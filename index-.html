<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stream Embed: Twitch + Kick (with Logs)</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --bad:#ef4444; --good:#22c55e; }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }
    header { padding:14px 16px; border-bottom:1px solid #1f2937; background:linear-gradient(180deg, #0b1222, #0b1222cc 60%, transparent); position:sticky; top:0; z-index:10; }
    h1 { font-size:16px; margin:0 0 6px; letter-spacing:0.4px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    label { display:flex; gap:6px; align-items:center; color:var(--muted); }
    select, input[type="text"] { background:#0b1020; border:1px solid #253046; color:var(--text); padding:8px 10px; border-radius:10px; outline:none; }
    select:focus, input:focus { border-color:var(--accent); box-shadow:0 0 0 3px #22d3ee22; }
    button { background:var(--accent); color:#001018; border:0; padding:9px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    button.secondary { background:#1f2937; color:#cbd5e1; border:1px solid #334155; }
    button.bad { background:var(--bad); color:white; }
    .wrap { display:grid; grid-template-columns: 1fr 380px; gap:14px; padding:14px; }
    .panel { background:var(--panel); border:1px solid #1f2937; border-radius:14px; overflow:hidden; }
    .player { aspect-ratio:16/9; width:100%; height:auto; background:#0b1020; display:grid; place-items:center; }
    iframe { width:100%; height:100%; border:0; }
    .logs { height:calc(100% - 40px); display:flex; flex-direction:column; }
    .logs header { padding:10px 12px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #253046; background:#0b1222; position:sticky; top:0; }
    .loglist { padding:10px; overflow:auto; white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .log { margin:0 0 6px; border-left:3px solid #334155; padding-left:8px; }
    .log.info { border-color:#3b82f6; }
    .log.warn { border-color:#f59e0b; }
    .log.error { border-color:#ef4444; }
    .kv { color:#a5b4fc; }
    .hint { color:#93c5fd; font-size:12px; margin-left:4px; }
    .footer { padding:10px; text-align:center; color:#9ca3af; }
    @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Stream Embed: Twitch + Kick</h1>
    <div class="row">
      <label>Platform
        <select id="platform">
          <option value="twitch">Twitch</option>
          <option value="kick">Kick</option>
        </select>
      </label>
      <label>Channel/User
        <input id="channel" type="text" placeholder="channel name" />
      </label>
      <label><input id="autoplay" type="checkbox" /> Autoplay</label>
      <label><input id="muted" type="checkbox" checked /> Start muted</label>
      <button id="load">Load stream</button>
      <button id="swap" class="secondary" title="Swap platform">Swap</button>
      <span class="hint" id="hostHint"></span>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="player" id="player">
        <div style="text-align:center; padding:14px; color:#9ca3af;">
          <div style="font-size:18px; margin-bottom:6px;">No stream loaded</div>
          <div>Pick a platform, enter a channel, and hit <strong>Load stream</strong>.</div>
        </div>
      </div>
      <div class="footer">Tip: Twitch requires a <code>parent</code> domain. If you see a playback error, make sure you’re serving this page over HTTP(S) and the hostname matches.</div>
    </div>

    <div class="panel logs">
      <header>
        <div>Logs</div>
        <div class="row">
          <button id="download" class="secondary">Download</button>
          <button id="clear" class="bad">Clear</button>
        </div>
      </header>
      <div id="loglist" class="loglist" aria-live="polite"></div>
    </div>
  </div>

  <script>
    const els = {
      platform: document.getElementById('platform'),
      channel: document.getElementById('channel'),
      autoplay: document.getElementById('autoplay'),
      muted: document.getElementById('muted'),
      load: document.getElementById('load'),
      swap: document.getElementById('swap'),
      player: document.getElementById('player'),
      loglist: document.getElementById('loglist'),
      download: document.getElementById('download'),
      clear: document.getElementById('clear'),
      hostHint: document.getElementById('hostHint'),
    };

    // Simple logger with levels and persistence
    const LOGS_KEY = 'streamEmbedLogs';
    let logs = JSON.parse(localStorage.getItem(LOGS_KEY) || '[]');

    function log(level, msg, kv) {
      const entry = { ts: new Date().toISOString(), level, msg, kv: kv || null };
      logs.push(entry);
      localStorage.setItem(LOGS_KEY, JSON.stringify(logs).slice(-50000));
      const div = document.createElement('div');
      div.className = `log ${level}`;
      const meta = `[${new Date(entry.ts).toLocaleString()}] [${level.toUpperCase()}]`;
      let text = `${meta} ${msg}`;
      if (kv && typeof kv === 'object') {
        text += '\n' + Object.entries(kv).map(([k,v]) => `  · ${k}: ${JSON.stringify(v)}`).join('\n');
      }
      div.textContent = text;
      els.loglist.appendChild(div);
      els.loglist.scrollTop = els.loglist.scrollHeight;
    }

    // Hostname hint, useful for Twitch parent param
    (function() {
      const host = location.hostname || '(file://)';
      els.hostHint.textContent = `Host: ${host}`;
      if (!location.protocol.startsWith('http')) {
        log('warn', 'Page is not served over HTTP(S). Twitch embeds may fail due to missing parent domain. Use a local dev server like `python -m http.server`.', { protocol: location.protocol });
      } else {
        log('info', 'Page served over HTTP(S).', { host });
      }
    })();

    function twitchSrc(channel, opts) {
      // Opt for the non-interactive iframe for simplicity
      // https://player.twitch.tv/?channel=<name>&parent=<domain>&muted=true
      const parent = (location.hostname || '').split(':')[0] || 'localhost';
      const q = new URLSearchParams({ channel, parent });
      if (opts.autoplay) q.set('autoplay', 'true');
      if (opts.muted) q.set('muted', 'true');
      return `https://player.twitch.tv/?${q.toString()}`;
    }

    function kickSrc(user, opts) {
      // Kick embed docs: https://player.kick.com/<username>
      const q = new URLSearchParams();
      if (opts.autoplay) q.set('autoplay', 'true');
      if (opts.muted) q.set('muted', 'true');
      const qs = q.toString();
      return `https://player.kick.com/${encodeURIComponent(user)}${qs ? ('?' + qs) : ''}`;
    }

    function setPlayer(src, title) {
      els.player.innerHTML = '';
      const frame = document.createElement('iframe');
      frame.allowFullscreen = true;
      frame.referrerPolicy = 'origin-when-cross-origin';
      frame.src = src;
      frame.title = title || 'Stream Player';
      // Event hooks
      let loaded = false;
      frame.addEventListener('load', () => {
        loaded = true;
        log('info', 'Iframe loaded.', { src });
      }, { once: true });
      frame.addEventListener('error', (e) => {
        log('error', 'Iframe error event.', { src, error: String(e) });
      });

      // Timeout watchdog for silent failures
      const watchdog = setTimeout(() => {
        if (!loaded) {
          log('warn', 'Iframe did not finish loading in 8s. This often means a blocked embed or wrong parent domain.', { src });
          if (src.includes('player.twitch.tv') && (!location.hostname || !location.protocol.startsWith('http'))) {
            log('error', 'Twitch requires a valid parent domain over HTTPS. Serve this file via a web server and ensure the hostname is correct.', { tip: 'Use `http://localhost:8080` or similar.' });
          }
        }
      }, 8000);

      els.player.appendChild(frame);
      return () => clearTimeout(watchdog);
    }

    function loadStream() {
      const platform = els.platform.value.trim();
      const channel = els.channel.value.trim();
      const opts = { autoplay: els.autoplay.checked, muted: els.muted.checked };
      if (!channel) {
        log('warn', 'Channel/user is empty.');
        alert('Enter a channel name.');
        return;
      }
      try {
        let src = '';
        if (platform === 'twitch') {
          src = twitchSrc(channel, opts);
        } else if (platform === 'kick') {
          src = kickSrc(channel, opts);
        } else {
          throw new Error('Unknown platform: ' + platform);
        }
        log('info', 'Loading stream...', { platform, channel, opts, src });
        setPlayer(src, `${platform}:${channel}`);
      } catch (err) {
        log('error', 'Failed to build embed URL.', { error: err.message, stack: err.stack });
        alert('Could not load stream. Check logs.');
      }
    }

    els.load.addEventListener('click', loadStream);
    els.swap.addEventListener('click', () => {
      els.platform.value = els.platform.value === 'twitch' ? 'kick' : 'twitch';
      loadStream();
    });

    // Logs: download and clear
    els.download.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      a.download = `stream-embed-logs-${stamp}.json`;
      a.click();
      URL.revokeObjectURL(url);
      log('info', 'Logs downloaded.');
    });

    els.clear.addEventListener('click', () => {
      logs = [];
      localStorage.removeItem(LOGS_KEY);
      els.loglist.innerHTML = '';
      log('info', 'Logs cleared.');
    });

    // Quick deep-link support: ?platform=twitch&channel=foobar&autoplay=1&muted=1
    (function handleQuery() {
      const params = new URLSearchParams(location.search);
      const p = params.get('platform');
      const c = params.get('channel');
      const a = params.get('autoplay');
      const m = params.get('muted');
      if (p) els.platform.value = p;
      if (c) els.channel.value = c;
      if (a !== null) els.autoplay.checked = a === '1' || a === 'true';
      if (m !== null) els.muted.checked = m === '1' || m === 'true';
      if (p && c) loadStream();
    })();
  </script>
</body>
</html>
