<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kick Monitor Ultra v4.2 Advanced</title>
    <meta name="description" content="Monitor your favorite Kick streamers with real-time updates, notifications, and enhanced accessibility">
    <meta name="theme-color" content="#5cff8a">
    
    <style>
        :root {
            --bg: #111; --text: #f0f0f0; --card: #1a1a1a; --border: #404040;
            --accent: #4ade80; --live-glow: #4ade80; --toast-bg: #222;
            --toast-text: #fff; --skeleton-bg: #2a2a2a; --error: #ef4444;
            --success: #10b981; --warning: #f59e0b; --info: #3b82f6;
        }
        [data-theme="light"] {
            --bg: #f4f4f4; --text: #1a1a1a; --card: #fff; --border: #c0c0c0;
            --accent: #059669; --live-glow: #059669; --toast-bg: #eee;
            --toast-text: #000; --skeleton-bg: #e2e2e2; --error: #dc2626;
            --success: #059669; --warning: #d97706; --info: #2563eb;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 24px;
            transition: background 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            line-height: 1.6;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        #app-container { 
            max-width: 1600px; 
            margin: 0 auto; 
        }
        
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .app-title {
            margin: 0;
            color: var(--accent);
        }
        
        .app-status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--border);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.error {
            background-color: var(--error);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .view-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .view-toggle {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .view-toggle.active {
            background: var(--accent);
            color: var(--bg);
        }
        
        .view-toggle:hover:not(.active) {
            background: var(--border);
        }
        
        .bulk-actions {
            display: none;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            gap: 8px;
            align-items: center;
        }
        
        .bulk-actions.visible {
            display: flex;
        }
        
        .bulk-actions button {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
        }
        
        .selection-count {
            font-size: 14px;
            color: var(--accent);
            font-weight: 500;
        }
        
        #streamers {
            display: grid;
            gap: 16px;
        }
        
        #streamers.grid-view {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }
        
        #streamers.list-view {
            grid-template-columns: 1fr;
        }
        
        .streamer {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            position: relative;
            contain: layout style paint;
        }
        
        .streamer.list-view {
            flex-direction: row;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
        }
        
        .streamer.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(76, 222, 128, 0.2);
        }
        
        .streamer:hover:not(.selected) { 
            transform: translateY(-3px); 
        }
        
        .streamer.list-view:hover {
            transform: none;
            background-color: var(--border);
        }
        
        .streamer:focus-within {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        .streamer.live {
            outline: 2px solid var(--accent);
            outline-offset: -2px;
            box-shadow: 0 0 12px 0px var(--live-glow);
        }
        
        .streamer.favorite { 
            border-left: 4px solid gold; 
        }
        
        .streamer-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 3px;
            padding: 2px;
        }
        
        [data-theme="dark"] .streamer-checkbox {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .streamer.list-view .streamer-checkbox {
            position: static;
            margin-right: 8px;
            background: transparent;
            padding: 0;
        }
        
        .streamer-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .streamer.list-view .streamer-header {
            flex: 1;
            min-width: 200px;
        }
        
        .streamer-name { 
            font-size: 1.2em; 
            font-weight: 600; 
            color: var(--accent); 
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .streamer.list-view .streamer-name {
            font-size: 1em;
        }
        
        .streamer-name:hover {
            opacity: 0.8;
        }
        
        .streamer-name:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        .streamer-status { 
            font-weight: bold; 
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .live .streamer-status { 
            color: var(--accent); 
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--error);
        }
        
        .live .status-dot {
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        .streamer-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 40px;
        }
        
        .streamer.list-view .streamer-info {
            flex: 2;
            min-height: auto;
        }
        
        .stream-title {
            font-size: 0.95em;
            opacity: 0.9;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .streamer.list-view .stream-title {
            -webkit-line-clamp: 1;
            font-size: 0.9em;
        }
        
        .stream-category {
            font-size: 0.85em;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stream-meta {
            display: flex;
            gap: 12px;
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .uptime {
            color: var(--info);
        }
        
        .thumbnail-container {
            position: relative;
        }
        
        .streamer.list-view .thumbnail-container {
            width: 120px;
            flex-shrink: 0;
        }
        
        .thumbnail-preview {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--border);
            margin-top: 8px;
            transition: opacity 0.3s;
            background-color: var(--skeleton-bg);
        }
        
        .streamer.list-view .thumbnail-preview {
            margin-top: 0;
            width: 120px;
            height: 68px;
        }
        
        .thumbnail-preview:hover {
            opacity: 0.9;
        }
        
        .viewer-overlay {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .streamer-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        
        .streamer.list-view .streamer-actions {
            margin-top: 0;
            flex-shrink: 0;
        }
        
        .action-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: var(--text); 
            font-size: 20px; 
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s, transform 0.1s;
            min-width: 36px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .streamer.list-view .action-btn {
            font-size: 16px;
            min-width: 28px;
            min-height: 28px;
            padding: 6px;
        }
        
        .action-btn:hover {
            background-color: var(--border);
            transform: scale(1.1);
        }
        
        .action-btn:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        .action-btn.remove { 
            color: var(--error); 
        }
        
        .action-btn.favorite { 
            font-size: 22px; 
        }
        
        .streamer.list-view .action-btn.favorite {
            font-size: 18px;
        }
        
        .action-btn.favorite.active {
            color: gold;
        }
        
        #controls-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 16px; 
            margin: 20px 0; 
        }
        
        #controls-grid > div { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .range-input {
            flex: 1;
        }
        
        .range-display {
            font-size: 0.85em;
            color: var(--accent);
            min-width: 80px;
            text-align: center;
        }
        
        label {
            font-weight: 500;
            font-size: 0.9em;
            color: var(--text);
        }
        
        input, select, button {
            background-color: var(--card);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input[type="range"] {
            padding: 0;
            height: 6px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(76, 222, 128, 0.2);
        }
        
        button { 
            cursor: pointer; 
            background-color: var(--accent); 
            color: var(--bg); 
            font-weight: bold; 
            transition: opacity 0.2s, transform 0.1s; 
            border: none;
        }
        
        button:hover:not(:disabled) { 
            opacity: 0.85; 
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        button:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        button.secondary {
            background-color: var(--border);
            color: var(--text);
        }
        
        #more-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        #more-actions button {
            flex: 1;
            min-width: 120px;
        }
        
        .stats-panel {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .stats-panel h3 {
            margin: 0 0 12px 0;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent);
        }
        
        .stat-label {
            display: block;
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--border);
        }
        
        .empty-state h3 {
            margin: 0 0 16px 0;
            color: var(--text);
        }
        
        .empty-state button {
            margin-top: 16px;
            max-width: 200px;
        }
        
        .error-boundary {
            background-color: var(--card);
            border: 2px solid var(--error);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            margin: 20px 0;
        }
        
        .error-boundary h3 {
            color: var(--error);
            margin: 0 0 16px 0;
        }
        
        .error-boundary details {
            margin-top: 16px;
            text-align: left;
        }
        
        .error-boundary pre {
            background-color: var(--bg);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85em;
        }
        
        #toast {
            visibility: hidden;
            background-color: var(--toast-bg);
            color: var(--toast-text);
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s;
            max-width: 400px;
            border: 1px solid var(--border);
        }
        
        #toast.success {
            background-color: var(--success);
            color: white;
        }
        
        #toast.error {
            background-color: var(--error);
            color: white;
        }
        
        #toast.warning {
            background-color: var(--warning);
            color: white;
        }
        
        #toast.info {
            background-color: var(--info);
            color: white;
        }
        
        .skeleton { 
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
        }
        
        @keyframes pulse {
            50% { opacity: .5; }
        }
        
        .skeleton-card { 
            background-color: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 16px; 
        }
        
        .skeleton-line { 
            height: 20px; 
            background-color: var(--skeleton-bg); 
            border-radius: 4px; 
            margin-bottom: 10px; 
        }
        
        .skeleton-thumb { 
            width: 100%; 
            aspect-ratio: 16 / 9; 
            background-color: var(--skeleton-bg); 
            border-radius: 6px; 
        }
        
        /* Responsive design improvements */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            
            .app-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            #controls-grid {
                grid-template-columns: 1fr;
            }
            
            #more-actions {
                flex-direction: column;
            }
            
            #more-actions button {
                min-width: auto;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .view-controls {
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            #streamers.grid-view {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .streamer.list-view {
                flex-direction: column;
                align-items: stretch;
            }
            
            .streamer.list-view .thumbnail-container {
                width: 100%;
            }
            
            .streamer.list-view .thumbnail-preview {
                width: 100%;
                height: auto;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .streamer:hover {
                transform: none;
            }
            
            .action-btn:hover {
                transform: none;
            }
            
            button:hover:not(:disabled) {
                transform: none;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border: #666;
            }
            
            [data-theme="light"] {
                --border: #999;
            }
        }
        
        /* Focus improvements for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--accent);
            color: var(--bg);
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 1001;
        }
        
        .skip-link:focus {
            top: 6px;
        }
    </style>
</head>
<body data-theme="dark">
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div id="app-container">
        <header class="app-header">
            <h1 class="app-title">Kick Monitor Ultra <small>v4.2 Advanced</small></h1>
            <div class="app-status">
                <div class="status-indicator" id="connection-status" aria-label="Connection status"></div>
                <div id="last-updated" aria-live="polite"></div>
            </div>
        </header>

        <div id="controls-grid">
            <div>
                <label for="search-input">Search / Filter</label>
                <input type="text" id="search-input" placeholder="Name, category, title..." 
                       aria-describedby="search-help">
                <div id="search-help" class="sr-only">Search by streamer name, category, or stream title</div>
            </div>
            <div>
                <label for="filter-select">View</label>
                <select id="filter-select" aria-describedby="filter-help">
                    <option value="all">All</option>
                    <option value="live">Live</option>
                    <option value="offline">Offline</option>
                    <option value="favorites">Favorites</option>
                </select>
                <div id="filter-help" class="sr-only">Filter streamers by status</div>
            </div>
            <div>
                <label for="sort-select">Sort By</label>
                <select id="sort-select" aria-describedby="sort-help">
                    <option value="status">Live Status</option>
                    <option value="viewers">Viewer Count</option>
                    <option value="name">Name (A-Z)</option>
                    <option value="category">Category</option>
                    <option value="uptime">Stream Duration</option>
                </select>
                <div id="sort-help" class="sr-only">Sort streamers by different criteria</div>
            </div>
            <div>
                <label for="viewer-range">Viewer Count Range</label>
                <div class="range-container">
                    <input type="range" id="viewer-min" class="range-input" min="0" max="10000" step="100" value="0">
                    <span class="range-display" id="viewer-range-display">0 - ∞</span>
                    <input type="range" id="viewer-max" class="range-input" min="0" max="50000" step="500" value="50000">
                </div>
            </div>
            <div>
                <label for="auto-refresh-select">Auto Refresh</label>
                <select id="auto-refresh-select" aria-describedby="refresh-help">
                    <option value="0">Off</option>
                    <option value="60000">1 minute</option>
                    <option value="300000" selected>5 minutes</option>
                    <option value="600000">10 minutes</option>
                </select>
                <div id="refresh-help" class="sr-only">Automatically refresh streamer data</div>
            </div>
            <div>
                <label for="add-input">Add Streamer</label>
                <input type="text" id="add-input" placeholder="Enter streamer name"
                       aria-describedby="add-help">
                <div id="add-help" class="sr-only">Add a new streamer to monitor</div>
            </div>
        </div>

        <div class="view-controls">
            <button class="view-toggle active" data-view="grid" aria-label="Grid view">📱 Grid</button>
            <button class="view-toggle" data-view="list" aria-label="List view">📋 List</button>
            <button id="select-mode-btn" class="view-toggle" aria-label="Selection mode">☑️ Select</button>
        </div>

        <div class="bulk-actions" id="bulk-actions">
            <span class="selection-count" id="selection-count">0 selected</span>
            <button id="bulk-favorite" class="secondary">⭐ Favorite</button>
            <button id="bulk-unfavorite" class="secondary">☆ Unfavorite</button>
            <button id="select-all">Select All</button>
            <button id="clear-selection">Clear</button>
        </div>

        <div id="more-actions">
            <button id="add-btn" aria-describedby="add-help">➕ Add</button>
            <button id="refresh-btn">🔄 Refresh</button>
            <button id="theme-toggle-btn">🌗 Toggle Theme</button>
            <button id="export-btn">📤 Export</button>
            <button onclick="document.getElementById('import-file').click()">📥 Import</button>
            <input type="file" id="import-file" accept="application/json" style="display:none" 
                   aria-label="Import streamer list">
        </div>

        <div id="stats-container"></div>

        <main id="main-content">
            <div id="streamers" class="grid-view" role="grid" aria-label="Streamer monitoring dashboard" 
                 aria-describedby="streamers-help"></div>
            <div id="streamers-help" class="sr-only">
                Grid of streamer cards showing live status, viewer count, and stream information
            </div>
        </main>
    </div>
    
    <div id="toast" role="alert" aria-live="assertive"></div>
    <div id="status-announcements" aria-live="polite" aria-atomic="true" class="sr-only"></div>

<script>
// Enhanced Kick Monitor Ultra v4.2 Advanced
// Implements bulk actions, advanced filtering, view modes, and enhanced UX

// Utility functions
const Utils = {
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },
    
    throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    },
    
    formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    },
    
    formatDuration(minutes) {
        if (minutes < 60) {
            return `${minutes}m`;
        }
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours}h ${mins}m`;
    },
    
    sanitizeHTML(str) {
        const temp = document.createElement('div');
        temp.textContent = str;
        return temp.innerHTML;
    },
    
    calculateUptime(startTime) {
        if (!startTime) return 0;
        const now = new Date();
        const start = new Date(startTime);
        return Math.floor((now - start) / (1000 * 60)); // minutes
    }
};

// Enhanced cache system
class CacheManager {
    constructor(defaultTTL = 60000) {
        this.cache = new Map();
        this.defaultTTL = defaultTTL;
    }
    
    set(key, data, ttl = this.defaultTTL) {
        this.cache.set(key, {
            data,
            timestamp: Date.now(),
            ttl
        });
    }
    
    get(key) {
        const item = this.cache.get(key);
        if (!item) return null;
        
        if (Date.now() - item.timestamp > item.ttl) {
            this.cache.delete(key);
            return null;
        }
        
        return item.data;
    }
    
    clear() {
        this.cache.clear();
    }
    
    cleanup() {
        const now = Date.now();
        for (const [key, item] of this.cache.entries()) {
            if (now - item.timestamp > item.ttl) {
                this.cache.delete(key);
            }
        }
    }
}

// Enhanced statistics tracking
class StatsManager {
    constructor() {
        this.history = JSON.parse(localStorage.getItem('stream-history') || '{}');
        this.startCleanupTimer();
    }
    
    recordSnapshot(streamers) {
        const timestamp = Date.now();
        const liveStreamers = streamers.filter(s => s.isLive);
        const totalViewers = liveStreamers.reduce((sum, s) => sum + (s.viewers || 0), 0);
        
        const snapshot = {
            timestamp,
            totalStreamers: streamers.length,
            liveStreamers: liveStreamers.length,
            totalViewers,
            categories: this.getCategoryDistribution(liveStreamers),
            topStreamer: this.getTopStreamer(liveStreamers)
        };
        
        this.history[timestamp] = snapshot;
        this.cleanup();
        localStorage.setItem('stream-history', JSON.stringify(this.history));
    }
    
    getCategoryDistribution(streamers) {
        const distribution = {};
        streamers.forEach(s => {
            if (s.category) {
                distribution[s.category] = (distribution[s.category] || 0) + 1;
            }
        });
        return distribution;
    }
    
    getTopStreamer(streamers) {
        if (streamers.length === 0) return null;
        return streamers.reduce((top, current) => 
            (current.viewers || 0) > (top.viewers || 0) ? current : top
        );
    }
    
    getStats() {
        const snapshots = Object.values(this.history);
        if (snapshots.length === 0) return null;
        
        const latest = snapshots[snapshots.length - 1];
        const hourAgo = Date.now() - 3600000;
        const recentSnapshots = snapshots.filter(s => s.timestamp > hourAgo);
        
        return {
            current: latest,
            peakViewers: Math.max(...snapshots.map(s => s.totalViewers)),
            averageLive: recentSnapshots.length > 0 ? 
                Math.round(recentSnapshots.reduce((sum, s) => sum + s.liveStreamers, 0) / recentSnapshots.length) : 0,
            topCategory: this.getTopCategory(latest.categories)
        };
    }
    
    getTopCategory(categories) {
        if (!categories || Object.keys(categories).length === 0) return null;
        return Object.entries(categories).reduce((a, b) => a[1] > b[1] ? a : b)[0];
    }
    
    cleanup() {
        const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
        this.history = Object.fromEntries(
            Object.entries(this.history).filter(([ts]) => parseInt(ts) > dayAgo)
        );
    }
    
    startCleanupTimer() {
        setInterval(() => this.cleanup(), 3600000); // Cleanup every hour
    }
}

// Main Application
const App = {
    // Application State
    state: {
        streamers: [],
        streamerData: new Map(),
        favorites: [],
        isLoading: true,
        filter: 'all',
        sort: 'status',
        searchQuery: '',
        lastLiveStates: {},
        autoRefreshInterval: null,
        autoRefreshDelay: 300000,
        connectionStatus: 'connected',
        viewMode: 'grid',
        selectionMode: false,
        selectedStreamers: new Set(),
        viewerRange: { min: 0, max: 50000 },
        apiEndpoint: 'https://gist.githubusercontent.com/Rapahannock/9d6241637b3be456f610b3aa415d8b4f/raw/streamers1455.json',
        workerEndpoint: 'https://autumn-base-826c.rapahannock.workers.dev/',
    },

    // Enhanced components
    cache: new CacheManager(60000),
    stats: new StatsManager(),
    elements: {},

    // Initialization
    init() {
        this.cacheElements();
        this.loadSettings();
        this.registerEventListeners();
        this.setupKeyboardNavigation();
        this.requestNotificationPermission();
        this.startPeriodicCleanup();
        
        this.fetchStreamerList();
    },

    cacheElements() {
        this.elements = {
            container: document.getElementById('streamers'),
            searchInput: document.getElementById('search-input'),
            filterSelect: document.getElementById('filter-select'),
            sortSelect: document.getElementById('sort-select'),
            autoRefreshSelect: document.getElementById('auto-refresh-select'),
            viewerMin: document.getElementById('viewer-min'),
            viewerMax: document.getElementById('viewer-max'),
            viewerRangeDisplay: document.getElementById('viewer-range-display'),
            addInput: document.getElementById('add-input'),
            addBtn: document.getElementById('add-btn'),
            refreshBtn: document.getElementById('refresh-btn'),
            themeBtn: document.getElementById('theme-toggle-btn'),
            exportBtn: document.getElementById('export-btn'),
            importFile: document.getElementById('import-file'),
            lastUpdated: document.getElementById('last-updated'),
            toast: document.getElementById('toast'),
            statsContainer: document.getElementById('stats-container'),
            statusIndicator: document.getElementById('connection-status'),
            announcements: document.getElementById('status-announcements'),
            selectModeBtn: document.getElementById('select-mode-btn'),
            bulkActions: document.getElementById('bulk-actions'),
            selectionCount: document.getElementById('selection-count'),
            bulkFavorite: document.getElementById('bulk-favorite'),
            bulkUnfavorite: document.getElementById('bulk-unfavorite'),
            selectAll: document.getElementById('select-all'),
            clearSelection: document.getElementById('clear-selection'),
        };
    },

    loadSettings() {
        const theme = localStorage.getItem("theme") || 
            (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        document.body.setAttribute("data-theme", theme);

        this.state.favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
        this.state.filter = localStorage.getItem("filter") || 'all';
        this.state.sort = localStorage.getItem("sort") || 'status';
        this.state.autoRefreshDelay = parseInt(localStorage.getItem("autoRefreshDelay") || "300000");
        this.state.viewMode = localStorage.getItem("viewMode") || 'grid';
        this.state.viewerRange = JSON.parse(localStorage.getItem("viewerRange") || '{"min":0,"max":50000}');

        this.elements.filterSelect.value = this.state.filter;
        this.elements.sortSelect.value = this.state.sort;
        this.elements.autoRefreshSelect.value = this.state.autoRefreshDelay;
        this.elements.viewerMin.value = this.state.viewerRange.min;
        this.elements.viewerMax.value = this.state.viewerRange.max;
        
        this.updateViewMode(this.state.viewMode);
        this.updateViewerRangeDisplay();
        this.startAutoRefresh(this.state.autoRefreshDelay);
    },

    registerEventListeners() {
        // Debounced search
        this.elements.searchInput.addEventListener('input', 
            Utils.debounce((e) => {
                this.state.searchQuery = e.target.value.toLowerCase();
                this.render();
            }, 300)
        );
        
        this.elements.filterSelect.addEventListener('change', e => {
            this.state.filter = e.target.value;
            localStorage.setItem("filter", this.state.filter);
            this.render();
        });
        
        this.elements.sortSelect.addEventListener('change', e => {
            this.state.sort = e.target.value;
            localStorage.setItem("sort", this.state.sort);
            this.render();
        });
        
        this.elements.autoRefreshSelect.addEventListener('change', e => {
            this.state.autoRefreshDelay = parseInt(e.target.value);
            localStorage.setItem("autoRefreshDelay", this.state.autoRefreshDelay);
            this.startAutoRefresh(this.state.autoRefreshDelay);
        });
        
        // Viewer range controls
        this.elements.viewerMin.addEventListener('input', Utils.throttle(() => {
            this.state.viewerRange.min = parseInt(this.elements.viewerMin.value);
            this.updateViewerRangeDisplay();
            localStorage.setItem("viewerRange", JSON.stringify(this.state.viewerRange));
            this.render();
        }, 100));
        
        this.elements.viewerMax.addEventListener('input', Utils.throttle(() => {
            this.state.viewerRange.max = parseInt(this.elements.viewerMax.value);
            this.updateViewerRangeDisplay();
            localStorage.setItem("viewerRange", JSON.stringify(this.state.viewerRange));
            this.render();
        }, 100));
        
        // View mode controls
        document.querySelectorAll('.view-toggle[data-view]').forEach(btn => {
            btn.addEventListener('click', e => {
                const view = e.target.dataset.view;
                this.updateViewMode(view);
            });
        });
        
        // Selection mode
        this.elements.selectModeBtn.addEventListener('click', () => {
            this.toggleSelectionMode();
        });
        
        // Bulk actions
        this.elements.bulkFavorite.addEventListener('click', () => {
            this.bulkToggleFavorite(true);
        });
        
        this.elements.bulkUnfavorite.addEventListener('click', () => {
            this.bulkToggleFavorite(false);
        });
        
        this.elements.selectAll.addEventListener('click', () => {
            this.selectAllStreamers();
        });
        
        this.elements.clearSelection.addEventListener('click', () => {
            this.clearSelection();
        });
        
        this.elements.themeBtn.addEventListener('click', () => this.toggleTheme());
        this.elements.refreshBtn.addEventListener('click', () => this.fetchStreamerList());
        this.elements.addBtn.addEventListener('click', () => this.addStreamer());
        
        this.elements.addInput.addEventListener('keyup', e => {
            if (e.key === 'Enter') this.addStreamer();
        });
        
        this.elements.exportBtn.addEventListener('click', () => this.exportList());
        this.elements.importFile.addEventListener('change', e => this.importList(e));

        // Enhanced event delegation
        this.elements.container.addEventListener('click', e => {
            const checkbox = e.target.closest('.streamer-checkbox');
            if (checkbox) {
                const streamerCard = checkbox.closest('[data-streamer-name]');
                const streamerName = streamerCard.dataset.streamerName;
                this.toggleSelection(streamerName);
                return;
            }
            
            const button = e.target.closest('.action-btn');
            if (!button) return;

            const streamerCard = button.closest('[data-streamer-name]');
            const streamerName = streamerCard.dataset.streamerName;

            if (button.classList.contains('favorite')) {
                this.toggleFavorite(streamerName);
            } else if (button.classList.contains('remove')) {
                this.removeStreamer(streamerName);
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            this.stopAutoRefresh();
        });
    },
    
    setupKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
            if (e.target.matches('input, select, button, textarea')) return;
            
            switch(e.key.toLowerCase()) {
                case 'r':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        this.fetchStreamerList();
                    }
                    break;
                case 'f':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        this.elements.searchInput.focus();
                    }
                    break;
                case 't':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        this.toggleTheme();
                    }
                    break;
                case 'g':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        this.updateViewMode('grid');
                    }
                    break;
                case 'l':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        this.updateViewMode('list');
                    }
                    break;
                case 's':
                    if (!e.ctrlKey && !e.metaKey) {
                        e.preventDefault();
                        this.toggleSelectionMode();
                    }
                    break;
                case 'a':
                    if (e.ctrlKey || e.metaKey) {
                        if (this.state.selectionMode) {
                            e.preventDefault();
                            this.selectAllStreamers();
                        }
                    }
                    break;
                case 'escape':
                    if (this.state.selectionMode) {
                        this.toggleSelectionMode();
                    } else {
                        this.elements.searchInput.blur();
                    }
                    break;
            }
        });
    },
    
    requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    },
    
    startPeriodicCleanup() {
        setInterval(() => {
            this.cache.cleanup();
        }, 300000); // Cleanup every 5 minutes
    },
    
    // Enhanced API methods
    async fetchStreamerList() {
        this.setLoadingState(true, 'Loading streamer list...');
        this.updateConnectionStatus('connecting');
        
        try {
            const cacheKey = `streamer-list-${this.state.apiEndpoint}`;
            let streamers = this.cache.get(cacheKey);
            
            if (!streamers) {
                const res = await fetch(`${this.state.apiEndpoint}?t=${Date.now()}`);
                if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
                streamers = await res.json();
                this.cache.set(cacheKey, streamers, 300000); // Cache for 5 minutes
            }
            
            this.state.streamers = streamers;
            this.updateConnectionStatus('connected');
            this.fetchStreamerData();
        } catch (error) {
            console.error("Failed to load streamer list:", error);
            this.updateConnectionStatus('error');
            this.showToast(`⚠️ Error fetching list: ${error.message}`, 'error');
            this.setLoadingState(false);
        }
    },

    async fetchStreamerData() {
        this.setLoadingState(true, 'Updating streamer data...');
        
        const fetchPromises = this.state.streamers.map(name =>
            this.fetchApiWithCache(`https://kick.com/api/v1/channels/${name}`, name)
        );

        const results = await Promise.allSettled(fetchPromises);
        let successCount = 0;

        results.forEach((result, index) => {
            const name = this.state.streamers[index];
            if (result.status === 'fulfilled' && result.value) {
                const data = result.value;
                const isLive = data.livestream !== null;

                // Enhanced notification logic
                if (isLive && this.state.lastLiveStates[name] === false && this.state.favorites.includes(name)) {
                    this.notifyFavoriteStreamerLive(name, data);
                }
                this.state.lastLiveStates[name] = isLive;
                
                const uptime = isLive ? Utils.calculateUptime(data.livestream?.created_at) : 0;
                
                this.state.streamerData.set(name, {
                    name,
                    isLive,
                    title: data.livestream?.session_title || "Offline",
                    viewers: data.livestream?.viewer_count || 0,
                    category: data.livestream?.categories?.[0]?.name || null,
                    thumbnail: data.livestream?.thumbnail?.url,
                    url: `https://kick.com/${name}`,
                    profilePic: data.user?.profile_pic,
                    uptime,
                    startTime: data.livestream?.created_at
                });
                successCount++;
            } else {
                console.warn(`Failed to fetch data for ${name}`);
                this.state.streamerData.set(name, { 
                    name, 
                    isLive: false, 
                    title: 'Unavailable', 
                    viewers: 0, 
                    category: null, 
                    url: `https://kick.com/${name}`,
                    uptime: 0
                });
            }
        });
        
        // Record statistics
        this.stats.recordSnapshot(Array.from(this.state.streamerData.values()));
        
        this.setLoadingState(false);
        this.render();
        this.announceUpdate(successCount, this.state.streamers.length);
    },

    async fetchApiWithCache(url, identifier) {
        const cacheKey = `api-${identifier}`;
        let data = this.cache.get(cacheKey);
        
        if (data) {
            return data;
        }
        
        return this.fetchApi(url).then(result => {
            if (result) {
                this.cache.set(cacheKey, result, 60000); // Cache for 1 minute
            }
            return result;
        });
    },

    async fetchApi(url, options = {}, retries = 2, backoff = 1000) {
        for (let i = 0; i < retries; i++) {
            try {
                const res = await fetch(url, options);
                if (res.status === 429 && i < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, backoff * (i + 1)));
                    continue;
                }
                if (!res.ok) throw new Error(`API responded with status ${res.status}`);
                return res.json();
            } catch (err) {
                if (i === retries - 1) throw err;
                await new Promise(resolve => setTimeout(resolve, backoff));
            }
        }
    },

    // Enhanced rendering
    render() {
        if (this.state.isLoading) {
            this.renderSkeletons();
            return;
        }

        const filtered = this.getFilteredAndSortedData();
        this.renderStats();
        
        // Clear container
        this.elements.container.innerHTML = '';

        if (filtered.length === 0) {
            this.renderEmptyState();
            return;
        }

        const fragment = document.createDocumentFragment();
        filtered.forEach(streamer => {
            const card = this.createStreamerCard(streamer);
            fragment.appendChild(card);
        });

        this.elements.container.appendChild(fragment);
        this.elements.lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        this.updateSelectionUI();
    },
    
    renderStats() {
        const stats = this.stats.getStats();
        if (!stats) {
            this.elements.statsContainer.innerHTML = '';
            return;
        }
        
        this.elements.statsContainer.innerHTML = `
            <div class="stats-panel">
                <h3>📊 Statistics</h3>
                <div class="stats-grid">
                    <div class="stat">
                        <span class="stat-value">${stats.current.liveStreamers}</span>
                        <span class="stat-label">Live Now</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">${Utils.formatNumber(stats.current.totalViewers)}</span>
                        <span class="stat-label">Total Viewers</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">${Utils.formatNumber(stats.peakViewers)}</span>
                        <span class="stat-label">Peak Viewers (24h)</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value">${stats.averageLive}</span>
                        <span class="stat-label">Avg Live (1h)</span>
                    </div>
                    ${stats.topCategory ? `
                    <div class="stat">
                        <span class="stat-value">${stats.topCategory}</span>
                        <span class="stat-label">Top Category</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    },

    getFilteredAndSortedData() {
        let data = Array.from(this.state.streamerData.values());

        // Enhanced filtering
        data = data.filter(s => {
            const searchMatch = !this.state.searchQuery ||
                s.name.toLowerCase().includes(this.state.searchQuery) ||
                (s.title || '').toLowerCase().includes(this.state.searchQuery) ||
                (s.category || '').toLowerCase().includes(this.state.searchQuery);
            
            if (!searchMatch) return false;

            // Viewer range filter
            const viewers = s.viewers || 0;
            if (viewers < this.state.viewerRange.min || viewers > this.state.viewerRange.max) {
                return false;
            }

            switch (this.state.filter) {
                case 'live': return s.isLive;
                case 'offline': return !s.isLive;
                case 'favorites': return this.state.favorites.includes(s.name);
                default: return true;
            }
        });

        // Enhanced sorting
        data.sort((a, b) => {
            switch (this.state.sort) {
                case 'viewers': 
                    return b.viewers - a.viewers;
                case 'name': 
                    return a.name.localeCompare(b.name);
                case 'category': 
                    return (a.category || '').localeCompare(b.category || '');
                case 'uptime':
                    return b.uptime - a.uptime;
                case 'status':
                default:
                    if (a.isLive !== b.isLive) {
                        return b.isLive - a.isLive;
                    }
                    return b.viewers - a.viewers;
            }
        });

        return data;
    },

    createStreamerCard(s) {
        const div = document.createElement('div');
        const isFavorite = this.state.favorites.includes(s.name);
        const isSelected = this.state.selectedStreamers.has(s.name);
        
        div.className = `streamer ${s.isLive ? 'live' : 'offline'} ${isFavorite ? 'favorite' : ''} ${this.state.viewMode}-view ${isSelected ? 'selected' : ''}`;
        div.dataset.streamerName = s.name;
        div.setAttribute('role', 'gridcell');
        div.setAttribute('aria-label', 
            `${s.name}, ${s.isLive ? 'currently live' : 'offline'}${s.isLive ? ` with ${s.viewers.toLocaleString()} viewers` : ''}`
        );

        const categoryIcons = { 
            "Just Chatting": "💬", "Slots & Casino": "🎰", "Games & Casino": "🎲", 
            "Call of Duty": "🎯", "Grand Theft Auto V": "🚗", "Sports": "🏀", 
            "Music": "🎵", "Valorant": "🔫", "Fortnite": "🛡️", "League of Legends": "🧙‍♂️", 
            "Minecraft": "⛏️", "IRL": "🌍", "Poker": "🃏" 
        };
        const icon = categoryIcons[s.category] || '🎮';

        div.innerHTML = `
            ${this.state.selectionMode ? `<input type="checkbox" class="streamer-checkbox" ${isSelected ? 'checked' : ''} aria-label="Select ${s.name}">` : ''}
            <div class="streamer-header">
                <a href="${s.url}" target="_blank" rel="noopener noreferrer" class="streamer-name"
                   aria-label="Visit ${s.name}'s stream page">${Utils.sanitizeHTML(s.name)}</a>
                <span class="streamer-status">
                    <span class="status-dot"></span>
                    ${s.isLive ? `LIVE (${Utils.formatNumber(s.viewers)})` : 'OFFLINE'}
                </span>
            </div>
            <div class="streamer-info">
                <div class="stream-title">${s.isLive ? Utils.sanitizeHTML(s.title) : 'Currently not streaming'}</div>
                ${s.category ? `<div class="stream-category">${icon} ${Utils.sanitizeHTML(s.category)}</div>` : ''}
                ${s.isLive && s.uptime > 0 ? `
                <div class="stream-meta">
                    <span class="uptime">⏱️ ${Utils.formatDuration(s.uptime)}</span>
                </div>
                ` : ''}
            </div>
            ${s.isLive && s.thumbnail ? this.createThumbnailHTML(s) : ''}
            <div class="streamer-actions">
                <button class="action-btn favorite ${isFavorite ? 'active' : ''}" 
                        aria-label="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}"
                        title="${isFavorite ? 'Remove from favorites' : 'Add to favorites'}">
                    ${isFavorite ? '⭐' : '☆'}
                </button>
                <button class="action-btn remove" 
                        aria-label="Remove streamer from list"
                        title="Remove streamer">🗑️</button>
            </div>
        `;
        return div;
    },
    
    createThumbnailHTML(s) {
        return `
            <div class="thumbnail-container">
                <a href="${s.url}" target="_blank" rel="noopener noreferrer" 
                   aria-label="View ${s.name}'s stream">
                    <img class="thumbnail-preview" 
                         src="${s.thumbnail}" 
                         alt="Stream preview for ${s.name}" 
                         loading="lazy"
                         onerror="this.style.display='none'">
                    <div class="viewer-overlay">${Utils.formatNumber(s.viewers)}</div>
                </a>
            </div>
        `;
    },

    renderSkeletons() {
        this.elements.container.innerHTML = '';
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < 6; i++) {
            const skeletonCard = document.createElement('div');
            skeletonCard.className = 'skeleton-card skeleton';
            skeletonCard.setAttribute('aria-label', 'Loading streamer data');
            skeletonCard.innerHTML = `
                <div class="skeleton-line" style="width: 60%;"></div>
                <div class="skeleton-line" style="width: 80%;"></div>
                <div class="skeleton-thumb"></div>
            `;
            fragment.appendChild(skeletonCard);
        }
        this.elements.container.appendChild(fragment);
    },
    
    renderEmptyState() {
        const { filter, searchQuery } = this.state;
        let message, action;
        
        if (searchQuery) {
            message = `No streamers found matching "${searchQuery}"`;
            action = '<button onclick="App.clearSearch()">Clear search</button>';
        } else if (filter === 'live') {
            message = 'No streamers are currently live';
            action = '<button onclick="App.showAllStreamers()">View all streamers</button>';
        } else if (filter === 'favorites') {
            message = 'No favorite streamers yet';
            action = '<p>Click the ☆ icon on any streamer to add them to favorites</p>';
        } else {
            message = 'No streamers in your list';
            action = '<p>Add streamers using the input field above</p>';
        }
        
        this.elements.container.innerHTML = `
            <div class="empty-state">
                <h3>${message}</h3>
                ${action}
            </div>
        `;
    },

    setLoadingState(isLoading, message = '') {
        this.state.isLoading = isLoading;
        this.elements.refreshBtn.disabled = isLoading;
        this.elements.refreshBtn.textContent = isLoading ? 
            `🔄 ${message || 'Loading...'}` : '🔄 Refresh';
        
        if (!isLoading) {
            this.render();
        }
    },
    
    updateConnectionStatus(status) {
        this.state.connectionStatus = status;
        this.elements.statusIndicator.className = `status-indicator ${status}`;
        this.elements.statusIndicator.setAttribute('aria-label', 
            `Connection status: ${status}`);
    },

    // View mode management
    updateViewMode(mode) {
        this.state.viewMode = mode;
        localStorage.setItem("viewMode", mode);
        
        // Update UI
        document.querySelectorAll('.view-toggle[data-view]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === mode);
        });
        
        this.elements.container.className = `${mode}-view`;
        this.render();
    },
    
    updateViewerRangeDisplay() {
        const min = this.state.viewerRange.min;
        const max = this.state.viewerRange.max;
        const maxDisplay = max >= 50000 ? '∞' : Utils.formatNumber(max);
        this.elements.viewerRangeDisplay.textContent = `${Utils.formatNumber(min)} - ${maxDisplay}`;
    },

    // Selection mode management
    toggleSelectionMode() {
        this.state.selectionMode = !this.state.selectionMode;
        this.state.selectedStreamers.clear();
        
        this.elements.selectModeBtn.classList.toggle('active', this.state.selectionMode);
        this.elements.bulkActions.classList.toggle('visible', this.state.selectionMode);
        
        this.render();
        
        if (this.state.selectionMode) {
            this.showToast('Selection mode enabled. Click streamers to select them.', 'info');
        } else {
            this.showToast('Selection mode disabled.', 'info');
        }
    },
    
    toggleSelection(streamerName) {
        if (this.state.selectedStreamers.has(streamerName)) {
            this.state.selectedStreamers.delete(streamerName);
        } else {
            this.state.selectedStreamers.add(streamerName);
        }
        this.updateSelectionUI();
        this.render();
    },
    
    selectAllStreamers() {
        const filtered = this.getFilteredAndSortedData();
        filtered.forEach(s => this.state.selectedStreamers.add(s.name));
        this.updateSelectionUI();
        this.render();
    },
    
    clearSelection() {
        this.state.selectedStreamers.clear();
        this.updateSelectionUI();
        this.render();
    },
    
    updateSelectionUI() {
        const count = this.state.selectedStreamers.size;
        this.elements.selectionCount.textContent = `${count} selected`;
        
        this.elements.bulkFavorite.disabled = count === 0;
        this.elements.bulkUnfavorite.disabled = count === 0;
    },
    
    bulkToggleFavorite(addToFavorites) {
        const selectedArray = Array.from(this.state.selectedStreamers);
        let changedCount = 0;
        
        selectedArray.forEach(name => {
            const isFavorite = this.state.favorites.includes(name);
            
            if (addToFavorites && !isFavorite) {
                this.state.favorites.push(name);
                changedCount++;
            } else if (!addToFavorites && isFavorite) {
                this.state.favorites = this.state.favorites.filter(f => f !== name);
                changedCount++;
            }
        });
        
        if (changedCount > 0) {
            localStorage.setItem("favorites", JSON.stringify(this.state.favorites));
            this.render();
            
            const action = addToFavorites ? 'added to' : 'removed from';
            this.showToast(`⭐ ${changedCount} streamers ${action} favorites`, 'success');
        } else {
            const action = addToFavorites ? 'already in' : 'not in';
            this.showToast(`ℹ️ Selected streamers are ${action} favorites`, 'info');
        }
    },

    // Enhanced user actions
    async addStreamer() {
        const name = this.elements.addInput.value.trim().toLowerCase();
        if (!name) {
            this.showToast('⚠️ Please enter a streamer name.', 'warning');
            this.elements.addInput.focus();
            return;
        }
        if (this.state.streamers.includes(name)) {
            this.showToast('⚠️ Streamer is already in the list.', 'warning');
            this.elements.addInput.focus();
            return;
        }

        this.setLoadingState(true, 'Adding streamer...');
        
        try {
            const res = await fetch(this.state.workerEndpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ streamer: name }),
            });
            const msg = await res.text();
            if (!res.ok) throw new Error(msg);

            this.showToast(`✅ ${msg}`, 'success');
            this.elements.addInput.value = '';
            this.cache.clear(); // Clear cache to force refresh
            setTimeout(() => this.fetchStreamerList(), 1500);
        } catch (error) {
            console.error("Failed to add streamer:", error);
            this.showToast(`❌ Add failed: ${error.message}`, 'error');
        } finally {
            this.setLoadingState(false);
        }
    },

    async removeStreamer(name) {
        if (!confirm(`Are you sure you want to remove ${name}? This requires a PIN.`)) return;
        
        const pin = prompt("Enter PIN to remove streamer:");
        if (!pin) {
            this.showToast('⚠️ PIN entry cancelled.', 'warning');
            return;
        }

        this.setLoadingState(true, 'Removing streamer...');
        
        try {
            const res = await fetch(this.state.workerEndpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ remove: name, pin }),
            });
            const msg = await res.text();
            if (!res.ok) throw new Error(msg);

            this.showToast(`🗑️ ${msg}`, 'success');
            this.cache.clear(); // Clear cache to force refresh
            setTimeout(() => this.fetchStreamerList(), 1500);
        } catch (error) {
            console.error("Failed to remove streamer:", error);
            this.showToast(`❌ Remove failed: ${error.message}`, 'error');
        } finally {
            this.setLoadingState(false);
        }
    },

    toggleFavorite(name) {
        const favSet = new Set(this.state.favorites);
        const wasAdded = !favSet.has(name);
        
        if (wasAdded) {
            favSet.add(name);
        } else {
            favSet.delete(name);
        }
        
        this.state.favorites = Array.from(favSet);
        localStorage.setItem("favorites", JSON.stringify(this.state.favorites));
        this.render();
        
        const message = wasAdded ? 
            `⭐ ${name} added to favorites!` : 
            `☆ ${name} removed from favorites.`;
        this.showToast(message, 'success');
        
        // Announce to screen readers
        this.announceToScreenReader(message);
    },

    toggleTheme() {
        const current = document.body.getAttribute("data-theme");
        const newTheme = current === "dark" ? "light" : "dark";
        document.body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        this.showToast(`🌗 Switched to ${newTheme} theme`, 'success');
    },
    
    exportList() {
        const dataStr = JSON.stringify({ 
            streamers: this.state.streamers, 
            favorites: this.state.favorites,
            settings: {
                theme: localStorage.getItem("theme"),
                filter: this.state.filter,
                sort: this.state.sort,
                autoRefreshDelay: this.state.autoRefreshDelay,
                viewMode: this.state.viewMode,
                viewerRange: this.state.viewerRange
            }
        }, null, 2);
        
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `kick_monitor_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        this.showToast('✅ Exported current list and settings.', 'success');
    },
    
    importList(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                let imported = [];
                
                if (data.streamers && Array.isArray(data.streamers)) {
                    this.state.streamers = [...new Set([...this.state.streamers, ...data.streamers])];
                    imported.push('streamers');
                }
                if (data.favorites && Array.isArray(data.favorites)) {
                    this.state.favorites = [...new Set([...this.state.favorites, ...data.favorites])];
                    localStorage.setItem("favorites", JSON.stringify(this.state.favorites));
                    imported.push('favorites');
                }
                if (data.settings) {
                    if (data.settings.theme) {
                        document.body.setAttribute("data-theme", data.settings.theme);
                        localStorage.setItem("theme", data.settings.theme);
                    }
                    if (data.settings.autoRefreshDelay) {
                        this.state.autoRefreshDelay = data.settings.autoRefreshDelay;
                        this.elements.autoRefreshSelect.value = this.state.autoRefreshDelay;
                        localStorage.setItem("autoRefreshDelay", this.state.autoRefreshDelay);
                        this.startAutoRefresh(this.state.autoRefreshDelay);
                    }
                    if (data.settings.viewMode) {
                        this.updateViewMode(data.settings.viewMode);
                    }
                    if (data.settings.viewerRange) {
                        this.state.viewerRange = data.settings.viewerRange;
                        this.elements.viewerMin.value = this.state.viewerRange.min;
                        this.elements.viewerMax.value = this.state.viewerRange.max;
                        this.updateViewerRangeDisplay();
                        localStorage.setItem("viewerRange", JSON.stringify(this.state.viewerRange));
                    }
                    imported.push('settings');
                }
                
                this.showToast(`✅ Successfully imported ${imported.join(', ')}!`, 'success');
                this.cache.clear();
                this.fetchStreamerData();
            } catch (err) {
                console.error("Failed to import:", err);
                this.showToast('⚠️ Import failed. Invalid file format.', 'error');
            } finally {
                event.target.value = '';
            }
        };
        reader.readAsText(file);
    },

    // Auto-refresh functionality
    startAutoRefresh(delay) {
        this.stopAutoRefresh();
        if (delay > 0) {
            this.state.autoRefreshInterval = setInterval(() => {
                this.fetchStreamerList();
            }, delay);
        }
    },

    stopAutoRefresh() {
        if (this.state.autoRefreshInterval) {
            clearInterval(this.state.autoRefreshInterval);
            this.state.autoRefreshInterval = null;
        }
    },

    // Enhanced notifications
    notifyFavoriteStreamerLive(name, data) {
        if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification(`${name} is now live!`, { 
                body: data.livestream?.session_title || 'Streaming now on Kick!',
                icon: data.user?.profile_pic || '/favicon.ico',
                tag: `streamer-${name}`,
                requireInteraction: false
            });
            
            notification.onclick = () => {
                window.open(`https://kick.com/${name}`, '_blank');
                notification.close();
            };
            
            setTimeout(() => notification.close(), 5000);
        }
        
        this.announceToScreenReader(`${name} is now live!`);
    },

    // Enhanced toast system
    showToast(message, type = 'info') {
        const toast = this.elements.toast;
        toast.textContent = message;
        toast.className = type;
        
        toast.style.visibility = "visible";
        toast.style.opacity = "1";
        
        setTimeout(() => {
            toast.style.opacity = "0";
            setTimeout(() => {
                toast.style.visibility = "hidden";
                toast.className = '';
            }, 300);
        }, 3000);
    },

    // Accessibility helpers
    announceToScreenReader(message) {
        this.elements.announcements.textContent = message;
        setTimeout(() => {
            this.elements.announcements.textContent = '';
        }, 1000);
    },
    
    announceUpdate(successCount, totalCount) {
        const message = `Updated ${successCount} of ${totalCount} streamers`;
        this.announceToScreenReader(message);
    },

    // Helper methods for empty state actions
    clearSearch() {
        this.elements.searchInput.value = '';
        this.state.searchQuery = '';
        this.render();
        this.elements.searchInput.focus();
    },
    
    showAllStreamers() {
        this.elements.filterSelect.value = 'all';
        this.state.filter = 'all';
        localStorage.setItem("filter", this.state.filter);
        this.render();
    }
};

// Error boundary wrapper
function withErrorBoundary(fn, context = 'Unknown') {
    return async function(...args) {
        try {
            return await fn.apply(this, args);
        } catch (error) {
            console.error(`Error in ${context}:`, error);
            App.showToast(`⚠️ Error in ${context}: ${error.message}`, 'error');
            
            // Show error boundary for critical failures
            if (context === 'fetchStreamerList' || context === 'fetchStreamerData') {
                App.elements.container.innerHTML = `
                    <div class="error-boundary">
                        <h3>Something went wrong</h3>
                        <p>We're having trouble loading the streamers. Please try refreshing the page.</p>
                        <button onclick="location.reload()">Refresh Page</button>
                        <button onclick="App.fetchStreamerList()">Try Again</button>
                        <details>
                            <summary>Error details</summary>
                            <pre>${error.message}</pre>
                        </details>
                    </div>
                `;
            }
            throw error;
        }
    };
}

// Wrap critical methods with error boundaries
App.fetchStreamerList = withErrorBoundary(App.fetchStreamerList, 'fetchStreamerList');
App.fetchStreamerData = withErrorBoundary(App.fetchStreamerData, 'fetchStreamerData');

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    try {
        App.init();
    } catch (error) {
        console.error('Failed to initialize app:', error);
        document.body.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <h1>Failed to load Kick Monitor Ultra</h1>
                <p>Please refresh the page to try again.</p>
                <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">Refresh Page</button>
            </div>
        `;
    }
});
</script>

</body>
</html>

