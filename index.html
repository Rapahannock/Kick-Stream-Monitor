<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kick & Twitch Monitor v7.5</title>
  <meta name="description" content="Monitor your favorite Kick, Twitch, and YouTube streamers with real-time updates, AI-powered summaries, and enhanced accessibility">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #050505;
      --bg-secondary: rgba(15, 15, 18, 0.95);
      --bg-tertiary: #1a1a1f;
      --bg-hover: #252530;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a8;
      --text-tertiary: #707078;
      --border-primary: rgba(255, 255, 255, 0.08);
      --border-secondary: rgba(255, 255, 255, 0.12);
      --border-hover: rgba(255, 255, 255, 0.16);
      --accent-primary: #00d4ff;
      --accent-secondary: #00ff88;
      --accent-gradient: linear-gradient(135deg, #00d4ff 0%, #00ff88 100%);
      --live: #10b981;
      --live-glow: #34d399;
      --twitch: #9146ff;
      --twitch-glow: #a970ff;
      --youtube: #ff0000;
      --youtube-glow: #ff4444;
      --kick: #53fc18;
      --kick-glow: #6bff33;
      --offline: #6b7280;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --shadow-sm: 0 2px 4px rgba(0,0,0,.3);
      --shadow-md: 0 8px 16px rgba(0,0,0,.4);
      --shadow-lg: 0 16px 40px rgba(0,0,0,.5);
      --shadow-xl: 0 24px 60px rgba(0,0,0,.6);
      --shadow-glow: 0 0 40px rgba(0, 212, 255, 0.15);
      --radius-sm: 8px;
      --radius-md: 14px;
      --radius-lg: 20px;
      --radius-xl: 28px;
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-medium: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-spring: 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --blur-sm: blur(8px);
      --blur-md: blur(16px);
      --blur-lg: blur(24px);
      --blur-xl: blur(40px);
    }

    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: rgba(250, 250, 252, 0.95);
      --bg-tertiary: #f3f4f6;
      --bg-hover: #e5e7eb;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --border-primary: rgba(0, 0, 0, 0.08);
      --border-secondary: rgba(0, 0, 0, 0.12);
      --border-hover: rgba(0, 0, 0, 0.16);
      --accent-primary: #0891b2;
      --accent-secondary: #10b981;
      --accent-gradient: linear-gradient(135deg, #0891b2 0%, #10b981 100%);
      --shadow-sm: 0 2px 4px rgba(0,0,0,.06);
      --shadow-md: 0 8px 16px rgba(0,0,0,.08);
      --shadow-lg: 0 16px 40px rgba(0,0,0,.1);
      --shadow-xl: 0 24px 60px rgba(0,0,0,.12);
      --shadow-glow: 0 0 40px rgba(8, 145, 178, 0.1);
    }

    *, *::before, *::after { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    ::selection {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-secondary);
      border-radius: 10px;
      transition: background var(--transition-fast);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-primary);
    }

    body {
      font-family: var(--font-family);
      background: var(--bg-primary);
      background-image: 
        radial-gradient(ellipse at top left, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(0, 255, 136, 0.1) 0%, transparent 50%);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 24px 24px 140px 24px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background var(--transition-slow), color var(--transition-slow);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 30% 50%, rgba(0, 212, 255, 0.03), transparent 40%),
                  radial-gradient(circle at 70% 80%, rgba(0, 255, 136, 0.03), transparent 40%);
      animation: floatBackground 20s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes floatBackground {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(-20px, -20px) rotate(120deg); }
      66% { transform: translate(20px, -10px) rotate(240deg); }
    }

    #app-container { 
      max-width: 1920px; 
      margin: 0 auto;
      position: relative;
    }
    
    #streamers { 
      display: grid; 
      gap: 28px;
      animation: fadeIn 0.6s ease-out;
    }
    
    #streamers.grid-view { 
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); 
    }
    
    #streamers.list-view { 
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .streamer {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      backdrop-filter: var(--blur-md);
      -webkit-backdrop-filter: var(--blur-md);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      transition: all var(--transition-medium);
      animation: cardEntry 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
      transform-origin: center;
      will-change: transform;
    }

    .streamer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-gradient);
      opacity: 0;
      transition: opacity var(--transition-medium);
    }

    .streamer::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                  rgba(255, 255, 255, 0.06), transparent 40%);
      opacity: 0;
      transition: opacity var(--transition-fast);
      pointer-events: none;
    }

    .streamer:hover::after {
      opacity: 1;
    }

    .streamer.live::before {
      opacity: 1;
    }

    .streamer.live.kick {
      border-color: rgba(83, 252, 24, 0.3);
      box-shadow: 
        inset 0 0 20px rgba(83, 252, 24, 0.05),
        0 0 40px rgba(83, 252, 24, 0.1),
        var(--shadow-lg);
    }

    .streamer.live.twitch {
      border-color: rgba(145, 70, 255, 0.3);
      box-shadow: 
        inset 0 0 20px rgba(145, 70, 255, 0.05),
        0 0 40px rgba(145, 70, 255, 0.1),
        var(--shadow-lg);
    }

    .streamer.live.youtube {
      border-color: rgba(255, 0, 0, 0.3);
      box-shadow: 
        inset 0 0 20px rgba(255, 0, 0, 0.05),
        0 0 40px rgba(255, 0, 0, 0.1),
        var(--shadow-lg);
    }

    .streamer:hover {
      transform: translateY(-8px) scale(1.02);
      border-color: var(--border-hover);
      box-shadow: var(--shadow-xl), var(--shadow-glow);
      z-index: 10;
    }
    
    .streamer.actions-open {
      overflow: visible;
      z-index: 30;
    }

    .streamer.selected {
      border-color: var(--accent-primary);
      box-shadow: 
        inset 0 0 0 2px var(--accent-primary),
        0 0 30px rgba(0, 212, 255, 0.3),
        var(--shadow-lg);
    }

    .streamer.favorite::before {
      content: '‚≠ê';
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 5;
      font-size: 24px;
      animation: starPulse 2s ease-in-out infinite;
    }

    @keyframes starPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .streamer-checkbox {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 32px;
      height: 32px;
      cursor: pointer;
      z-index: 10;
      accent-color: var(--accent-primary);
      transform: scale(1.2);
      opacity: 0.8;
      transition: all var(--transition-fast);
    }

    .streamer-checkbox:hover {
      opacity: 1;
      transform: scale(1.3);
    }

    .thumbnail-container {
      position: relative;
      cursor: pointer;
      overflow: hidden;
      background: var(--bg-tertiary);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .thumbnail-preview {
      display: block;
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      transition: all var(--transition-slow);
      filter: brightness(0.9);
    }

    .streamer:hover .thumbnail-preview {
      transform: scale(1.1);
      filter: brightness(1.1) saturate(1.2);
    }

    .thumbnail-container::after {
      content: 'üîç';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      font-size: 48px;
      opacity: 0;
      transition: all var(--transition-medium);
      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.8));
    }

    .thumbnail-container:hover::after {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .live-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      backdrop-filter: var(--blur-sm);
      -webkit-backdrop-filter: var(--blur-sm);
      animation: liveFloat 3s ease-in-out infinite;
      transition: all var(--transition-fast);
    }

    .streamer.kick .live-indicator {
      background: linear-gradient(135deg, var(--kick), var(--kick-glow));
      box-shadow: 0 0 30px rgba(83, 252, 24, 0.6);
      color: #000;
    }

    .streamer.twitch .live-indicator {
      background: linear-gradient(135deg, var(--twitch), var(--twitch-glow));
      box-shadow: 0 0 30px rgba(145, 70, 255, 0.6);
      color: #fff;
    }

    .streamer.youtube .live-indicator {
      background: linear-gradient(135deg, var(--youtube), var(--youtube-glow));
      box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
      color: #fff;
    }

    @keyframes liveFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    .live-indicator::before {
      content: '';
      width: 10px;
      height: 10px;
      background: currentColor;
      border-radius: 50%;
      animation: livePulse 2s ease-in-out infinite;
    }

    @keyframes livePulse {
      0%, 100% { 
        transform: scale(1);
        opacity: 1;
      }
      50% { 
        transform: scale(1.5);
        opacity: 0.5;
      }
    }

    .streamer-content {
      padding: 24px;
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .streamer-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
    }

    .streamer-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: 3px solid var(--border-primary);
      transition: all var(--transition-medium);
      position: relative;
    }

    .streamer-avatar::after {
      content: '';
      position: absolute;
      inset: -6px;
      border-radius: 50%;
      background: var(--accent-gradient);
      opacity: 0;
      z-index: -1;
      transition: opacity var(--transition-medium);
    }

    .streamer:hover .streamer-avatar::after {
      opacity: 0.5;
    }

    .streamer:hover .streamer-avatar {
      border-color: var(--accent-primary);
      transform: scale(1.05);
    }

    .streamer-name-wrapper {
      flex: 1;
      min-width: 0;
    }

    .streamer-name {
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--text-primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: color var(--transition-fast);
      position: relative;
    }

    .streamer-name:hover {
      color: var(--accent-primary);
    }

    .platform-icon {
      width: 20px;
      height: 20px;
      opacity: 0.8;
      transition: all var(--transition-fast);
    }

    .streamer-name:hover .platform-icon {
      opacity: 1;
      transform: scale(1.1);
    }

    .stream-meta {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stream-title {
      font-size: 0.9375rem;
      color: var(--text-secondary);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin: 8px 0 12px 0;
    }

    .stream-category {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: auto;
      padding: 8px 16px;
      background: linear-gradient(135deg, 
                  rgba(0, 212, 255, 0.1), 
                  rgba(0, 255, 136, 0.1));
      border: 1px solid var(--border-primary);
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent-primary);
      transition: all var(--transition-fast);
    }

    .stream-category:hover {
      background: linear-gradient(135deg, 
                  rgba(0, 212, 255, 0.2), 
                  rgba(0, 255, 136, 0.2));
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .streamer-actions-wrapper {
      position: absolute;
      top: 24px;
      right: 24px;
    }

    .action-menu-toggle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-primary);
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
      position: relative;
    }

    .action-menu-toggle::after {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      background: var(--accent-gradient);
      opacity: 0;
      z-index: -1;
      transition: opacity var(--transition-fast);
    }

    .action-menu-toggle:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      transform: scale(1.1);
    }

    .action-menu-toggle:hover::after {
      opacity: 0.3;
    }

    .actions-drawer {
      position: absolute;
      right: 0;
      top: 54px;
      z-index: 20;
      background: var(--bg-secondary);
      backdrop-filter: var(--blur-lg);
      -webkit-backdrop-filter: var(--blur-lg);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      padding: 8px;
      min-width: 180px;
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
      pointer-events: none;
      transition: all var(--transition-spring);
    }

    .streamer.actions-open .actions-drawer {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      padding: 12px 16px;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.9375rem;
      text-align: left;
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--accent-gradient);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .action-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      transform: translateX(4px);
    }

    .action-btn:hover::before {
      opacity: 0.1;
    }

    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .action-btn.favorite.active {
      color: gold;
    }

    .action-btn.remove:hover {
      color: var(--error);
    }

    .floating-bar {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1100;
      background: linear-gradient(135deg, 
                  rgba(15, 15, 18, 0.95),
                  rgba(25, 25, 30, 0.95));
      backdrop-filter: var(--blur-xl);
      -webkit-backdrop-filter: var(--blur-xl);
      padding: 16px 24px;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-primary);
      box-shadow: 
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 20px 40px rgba(0, 0, 0, 0.5),
        0 0 60px rgba(0, 212, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 20px;
      animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translate(-50%, 100px);
      }
    }

    .floating-bar-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-title {
      margin: 0 12px;
      font-weight: 900;
      font-size: 1.25rem;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      white-space: nowrap;
      position: relative;
    }

    .app-title small {
      color: var(--text-tertiary);
      font-weight: 600;
      font-size: 0.7em;
      margin-left: 4px;
    }

    .view-controls button,
    .button {
      background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-hover));
      border: 1px solid var(--border-primary);
      color: var(--text-secondary);
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
    }

    .view-controls button::before,
    .button::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--accent-gradient);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .view-controls button:hover,
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      color: var(--text-primary);
      border-color: var(--border-hover);
    }

    .view-controls button:hover::before,
    .button:hover::before {
      opacity: 0.1;
    }

    .view-controls button.active,
    .button.active {
      background: var(--accent-gradient);
      color: var(--bg-primary);
      font-weight: 700;
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
    }

    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: clamp(360px, 35vw, 480px);
      background: linear-gradient(180deg,
                  rgba(15, 15, 18, 0.98),
                  rgba(10, 10, 13, 0.98));
      backdrop-filter: var(--blur-xl);
      -webkit-backdrop-filter: var(--blur-xl);
      padding: 32px;
      border-left: 1px solid var(--border-primary);
      box-shadow: -20px 0 40px rgba(0, 0, 0, 0.5);
      transform: translateX(100%);
      transition: transform var(--transition-medium);
      z-index: 1300;
      overflow-y: auto;
    }

    .settings-panel.expanded {
      transform: translateX(0);
    }

    .settings-grid {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .setting-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .setting-group label {
      font-weight: 600;
      font-size: 0.9375rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    input,
    select {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-primary);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      font-size: 1rem;
      width: 100%;
      transition: all var(--transition-fast);
    }

    input:hover,
    select:hover {
      border-color: var(--border-secondary);
      background: var(--bg-hover);
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 
        inset 0 0 0 1px var(--accent-primary),
        0 0 20px rgba(0, 212, 255, 0.2);
      background: var(--bg-hover);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: var(--blur-md);
      -webkit-backdrop-filter: var(--blur-md);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    #settings-overlay {
      z-index: 1290;
    }

    .modal-overlay.visible {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
    }

    .modal-content {
      background: linear-gradient(135deg,
                  rgba(15, 15, 18, 0.98),
                  rgba(25, 25, 30, 0.98));
      backdrop-filter: var(--blur-xl);
      -webkit-backdrop-filter: var(--blur-xl);
      padding: 32px;
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow-xl);
      max-width: 90vw;
      width: 560px;
      position: relative;
      animation: modalSlide 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: translateY(-40px) scale(0.9);
      }
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-primary);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      transform: rotate(90deg);
    }

    #toast {
      visibility: hidden;
      background: linear-gradient(135deg,
                  rgba(15, 15, 18, 0.98),
                  rgba(25, 25, 30, 0.98));
      backdrop-filter: var(--blur-lg);
      -webkit-backdrop-filter: var(--blur-lg);
      color: var(--text-primary);
      text-align: center;
      border-radius: var(--radius-lg);
      padding: 20px 32px;
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translate(-50%, calc(100% + 32px));
      z-index: 3001;
      box-shadow: var(--shadow-xl);
      opacity: 0;
      transition: all var(--transition-spring);
      max-width: 90%;
      width: 480px;
      border: 1px solid var(--border-primary);
      cursor: pointer;
      font-weight: 500;
    }

    #toast.show {
      visibility: visible;
      opacity: 1;
      transform: translate(-50%, 0);
    }

    #toast.success {
      background: linear-gradient(135deg, var(--live), var(--live-glow));
      color: #fff;
      border-color: var(--live);
    }

    #toast.error {
      background: linear-gradient(135deg, var(--error), #ff6b6b);
      color: #fff;
      border-color: var(--error);
    }

    #toast.warning {
      background: linear-gradient(135deg, var(--warning), #fbbf24);
      color: #000;
      border-color: var(--warning);
    }

    #toast.info {
      background: linear-gradient(135deg, var(--info), #60a5fa);
      color: #fff;
      border-color: var(--info);
    }

    .spinner {
      border: 3px solid var(--border-primary);
      border-top: 3px solid transparent;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      margin: 24px auto;
      background: conic-gradient(from 0deg, var(--accent-primary), var(--accent-secondary), var(--accent-primary));
      -webkit-mask: radial-gradient(circle, transparent 40%, black 40%);
      mask: radial-gradient(circle, transparent 40%, black 40%);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state,
    .error-state {
      text-align: center;
      padding: 80px 40px;
      background: linear-gradient(135deg,
                  rgba(15, 15, 18, 0.6),
                  rgba(25, 25, 30, 0.6));
      backdrop-filter: var(--blur-md);
      -webkit-backdrop-filter: var(--blur-md);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow-lg);
      animation: fadeIn 0.6s ease-out;
    }

    .empty-state h3,
    .error-state h3 {
      margin: 0 0 16px 0;
      font-size: 1.875rem;
      font-weight: 800;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .error-state h3 {
      background: linear-gradient(135deg, var(--error), #ff6b6b);
      -webkit-background-clip: text;
      background-clip: text;
    }

    .empty-state p,
    .error-state p {
      color: var(--text-secondary);
      font-size: 1.125rem;
      max-width: 500px;
      margin: 0 auto;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--offline);
      position: relative;
      animation: statusPulse 2s ease-in-out infinite;
    }

    .status-indicator.connected {
      background: var(--live);
    }

    .status-indicator.connecting {
      background: var(--warning);
    }

    .status-indicator.error {
      background: var(--error);
    }

    @keyframes statusPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 currentColor;
      }
      50% {
        box-shadow: 0 0 0 8px rgba(currentColor, 0.1);
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 12px 12px 100px 12px;
      }

      #streamers {
        gap: 12px;
      }

      #streamers.grid-view {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .streamer {
        border-radius: var(--radius-md);
      }

      .streamer-content {
        padding: 12px !important;
      }

      .streamer-header {
        gap: 10px;
        margin-bottom: 8px;
      }

      .streamer-avatar {
        width: 36px;
        height: 36px;
        border-width: 2px;
      }

      .streamer-name {
        font-size: 0.875rem;
        gap: 6px;
      }

      .platform-icon {
        width: 16px;
        height: 16px;
      }

      .stream-meta {
        font-size: 0.75rem;
      }

      .stream-title {
        font-size: 0.8125rem;
        margin: 4px 0 8px 0;
        -webkit-line-clamp: 1;
      }

      .stream-category {
        padding: 6px 10px;
        font-size: 0.75rem;
      }

      .thumbnail-preview {
        aspect-ratio: 16/9;
      }

      .streamer-actions-wrapper {
        top: 12px;
        right: 12px;
      }

      .action-menu-toggle {
        width: 32px;
        height: 32px;
        font-size: 1.2rem;
      }

      .actions-drawer {
        min-width: 140px;
        padding: 4px;
        top: 36px;
      }

      .action-btn {
        padding: 8px 12px;
        font-size: 0.8125rem;
        gap: 8px;
      }

      .live-indicator {
        top: 12px;
        right: 12px;
        padding: 4px 8px;
        font-size: 0.625rem;
      }

      .live-indicator::before {
        width: 6px;
        height: 6px;
      }

      .streamer.favorite::before {
        font-size: 18px;
        top: 12px;
        left: 12px;
      }

      .streamer-checkbox {
        top: 12px;
        right: 12px;
        width: 24px;
        height: 24px;
      }

      .floating-bar {
        bottom: 12px;
        padding: 10px 12px;
        gap: 8px;
        border-radius: var(--radius-md);
        width: calc(100% - 24px);
      }

      .floating-bar-section {
        gap: 6px;
      }

      .view-controls button,
      .button {
        padding: 8px 12px;
        font-size: 0.8125rem;
      }

      .app-title {
        display: none;
      }

      #last-updated {
        font-size: 0.75rem;
      }

      .settings-panel {
        width: 100%;
        padding: 20px;
      }

      .modal-content {
        width: calc(100% - 24px);
        padding: 20px;
      }

      .bulk-actions {
        bottom: 80px !important;
        padding: 8px 12px !important;
        gap: 8px !important;
      }

      .bulk-actions button {
        padding: 6px 10px;
        font-size: 0.75rem;
      }

      #selection-count {
        font-size: 0.8125rem;
      }
    }

    @media (max-width: 480px) {
      #streamers.grid-view {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stream-title {
        display: none;
      }
      
      .stream-category {
        display: none;
      }
    }

    @media (max-width: 768px) and (orientation: landscape) {
      #streamers.grid-view {
        grid-template-columns: repeat(3, 1fr);
      }
      
      body {
        padding-bottom: 90px;
      }
      
      .floating-bar {
        padding: 8px 12px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <div id="app-container">
    
    <main id="main-content">
      <div id="streamers" class="grid-view" role="grid"></div>
    </main>
    
    <div id="settings-overlay" class="modal-overlay"></div>
    <section class="settings-panel" id="settings-panel">
        <div class="settings-grid">
            <div class="setting-group">
            <label for="search-input">Search / Filter</label>
            <input type="text" id="search-input" placeholder="Name, category, title...">
            </div>
            <div class="setting-group">
            <label for="filter-select">View</label>
            <select id="filter-select"></select>
            </div>
            <div class="setting-group">
            <label for="sort-select">Sort By</label>
            <select id="sort-select">
                <option value="status">Live Status</option>
                <option value="viewers">Viewer Count</option>
                <option value="name">Name (A-Z)</option>
                <option value="category">Category</option>
                <option value="uptime">Stream Duration</option>
            </select>
            </div>
            <div class="setting-group">
                <label for="auto-refresh-select">Auto Refresh</label>
                <select id="auto-refresh-select">
                    <option value="0">Off</option>
                    <option value="5000">5 seconds</option>
                    <option value="30000">30 seconds</option>
                    <option value="60000">1 minute</option>
                    <option value="120000" selected>2 minutes</option>
                    <option value="300000">5 minutes</option>
                    <option value="600000">10 minutes</option>
                </select>
            </div>
            <div class="setting-group">
            <label for="add-input">Add Streamer</label>
            <div style="display: flex; gap: 8px;">
                <input type="text" id="add-input" placeholder="Enter streamer name" style="flex: 1;">
                <select id="platform-select" style="flex-basis: 100px;">
                    <option value="kick" selected>Kick</option>
                    <option value="twitch">Twitch</option>
                    <option value="youtube">YouTube</option>
                </select>
                <button id="add-btn" style="flex-basis: 80px;" class="button primary">Add</button>
            </div>
            </div>
        </div>
        <div class="action-buttons" style="margin-top: 32px; border-top: 1px solid var(--border-primary); padding-top: 32px; display: flex; flex-wrap: wrap; gap: 12px;">
            <button id="refresh-btn" class="button">Refresh</button>
            <button id="theme-toggle-btn" class="button">Toggle Theme</button>
            <button id="export-btn" class="button">Export</button>
            <button id="import-btn" class="button">Import</button>
            <input type="file" id="import-file" accept=".json" style="display:none">
        </div>
    </section>

    <div class="floating-bar">
        <div class="floating-bar-section">
            <h1 class="app-title">Stream Monitor <small>v7.5</small></h1>
            <div id="last-updated" aria-live="polite" title="Last updated time" style="font-size: 0.875rem; color: var(--text-secondary);"></div>
            <div class="status-indicator" id="connection-status" aria-label="Connection status"></div>
        </div>
        <div class="floating-bar-section view-controls">
            <button id="gemini-choice-btn">‚ú® Help Me Choose</button>
            <div style="flex:1;"></div>
            <button class="view-toggle active" data-view="grid" aria-label="Grid view">Grid</button>
            <button class="view-toggle" data-view="list" aria-label="List view">List</button>
            <button class="view-toggle" id="select-mode-btn" aria-label="Selection mode">Select</button>
        </div>
        <div class="floating-bar-section">
             <button class="icon-btn" id="install-btn" title="Install app" aria-label="Install app" style="display:none">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 20px; height: 20px;"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>
            </button>
            <button class="settings-toggle" id="settings-toggle" aria-expanded="false">‚öôÔ∏è Settings</button>
        </div>
     </div>
     <div class="bulk-actions" id="bulk-actions" style="position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--bg-secondary); backdrop-filter: var(--blur-lg); padding: 12px 20px; border-radius: var(--radius-lg); border: 1px solid var(--border-primary); box-shadow: var(--shadow-lg); display: none; gap: 12px; align-items: center; z-index: 1000;">
            <span class="selection-count" id="selection-count" style="font-weight: 700; color: var(--accent-primary);">0 selected</span>
            <button id="bulk-favorite" class="button">‚≠ê Favorite</button>
            <button id="bulk-unfavorite" class="button">‚òÜ Unfavorite</button>
            <button id="select-all" class="button">Select All</button>
            <button id="clear-selection" class="button">Clear</button>
    </div>
  </div>
    
  <div id="toast" role="alert" aria-live="assertive"></div>
  <div id="gemini-modal" class="modal-overlay">
    <div class="modal-content">
      <button id="gemini-modal-close" class="modal-close" title="Close">&times;</button>
      <h3 id="gemini-modal-title" style="margin: 0 0 24px 0; font-size: 1.5rem; font-weight: 800; background: var(--accent-gradient); -webkit-background-clip: text; background-clip: text; color: transparent;">AI Assistant</h3>
      <div id="gemini-modal-content"><div class="spinner"></div></div>
    </div>
  </div>
  <div id="thumbnail-modal" class="modal-overlay">
      <div class="modal-content" style="background: transparent; border: none; box-shadow: none; padding: 0; width: auto;">
          <button id="thumbnail-modal-close" class="modal-close" style="background: var(--bg-tertiary); top: -50px; right: -50px;">&times;</button>
          <img id="enlarged-thumbnail" src="" alt="Enlarged stream thumbnail" style="display: block; max-width: 90vw; max-height: 90vh; border-radius: var(--radius-lg); cursor: pointer; box-shadow: var(--shadow-xl);">
      </div>
  </div>

<script>
const PWA = {
  deferredPrompt: null,
  iconCache: {},

  async init() {
    try {
      await this.injectManifest();
      await this.registerServiceWorker();
      this.setupInstallUI();
    } catch (e) {
      console.warn('[PWA] init error:', e);
    }
  },

  async injectManifest() {
    const icon192 = await this.generateIcon(192);
    const icon512 = await this.generateIcon(512);
    const theme = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();
    const manifest = {
      name: 'Kick & Twitch Monitor',
      short_name: 'Stream Monitor',
      description: 'Monitor your favorite streamers.',
      start_url: '.',
      display: 'standalone',
      background_color: getComputedStyle(document.documentElement).getPropertyValue('--bg-primary').trim(),
      theme_color: theme,
      icons: [
        { src: icon192, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
        { src: icon512, sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const manifestLink = document.createElement('link');
    manifestLink.rel = 'manifest';
    manifestLink.href = url;
    document.head.appendChild(manifestLink);

    const faviconLink = document.createElement('link');
    faviconLink.rel = 'icon';
    faviconLink.type = 'image/png';
    faviconLink.href = icon192;
    document.head.appendChild(faviconLink);
  },

  async generateIcon(size) {
    if (this.iconCache[size]) return this.iconCache[size];
    const c = document.createElement('canvas');
    c.width = c.height = size;
    const ctx = c.getContext('2d');
    const grad = ctx.createLinearGradient(0, 0, size, size);
    grad.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim());
    grad.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary').trim());
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, size, size);
    ctx.fillStyle = '#ffffff';
    ctx.font = `bold ${size * 0.5}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('SM', size / 2, size / 2);
    const url = c.toDataURL();
    this.iconCache[size] = url;
    return url;
  },

  async registerServiceWorker() {
    if (!('serviceWorker' in navigator)) return;
    const swScript = `
        self.addEventListener('install', event => {});
        self.addEventListener('fetch', event => {
            event.respondWith(fetch(event.request));
        });
    `;
    const blob = new Blob([swScript], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    try {
      await navigator.serviceWorker.register(swUrl);
    } catch (err) {
      console.warn('[PWA] SW registration failed:', err);
    }
  },

  setupInstallUI() {
    const installBtn = document.getElementById('install-btn');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      this.deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });
    installBtn.addEventListener('click', async () => {
      if (!this.deferredPrompt) return;
      this.deferredPrompt.prompt();
      const { outcome } = await this.deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        installBtn.style.display = 'none';
      }
      this.deferredPrompt = null;
    });
  }
};

const Utils = {
  debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; },
  formatNumber(n){ if(!n) return '0'; if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1e3) return (n/1e3).toFixed(1)+'K'; return n.toString(); },
  sanitizeHTML(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; },
  formatDuration(m){ if(!m || m < 0) return '0m'; if(m<60) return `${m}m`; const h=Math.floor(m/60), min=m%60; if(h<24) return `${h}h ${min}m`; const d=Math.floor(h/24), rh=h%24; return `${d}d ${rh}h`; },
  calculateUptime(start){ if(!start) return 0; return Math.floor((new Date()-new Date(start))/(1000*60)); },
};

class CacheManager {
  constructor(ttl=60000){ this.cache=new Map(); this.ttl=ttl; }
  set(k,d,ttl=this.ttl){ this.cache.set(k,{d,t:Date.now(),ttl}); }
  get(k){ const it=this.cache.get(k); if(!it) return null; if(Date.now()-it.t>it.ttl){ this.cache.delete(k); return null; } return it.d; }
  clear(){ this.cache.clear(); }
}

const Gemini = {
  apiKey: "",
  async ask(prompt, retries = 3, delay = 1000) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-preview-0514:generateContent?key=${this.apiKey}`;
    const payload = { contents: [{ parts: [{ text: prompt }] }] };

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        if (response.status >= 500 && retries > 0) {
          await new Promise(res => setTimeout(res, delay));
          return this.ask(prompt, retries - 1, delay * 2);
        }
        throw new Error(`API Error: ${response.status} ${response.statusText}`);
      }
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";
    } catch (error) {
       if (retries > 0) {
          await new Promise(res => setTimeout(res, delay));
          return this.ask(prompt, retries - 1, delay * 2);
        }
      console.error("Gemini API call failed:", error);
      throw error;
    }
  }
};

const App = {
  state:{
    streamers:[], streamerData:new Map(), favorites:[], groups:{},
    isLoading:true, filter:'all', sort:'status', searchQuery:'',
    lastLiveStates: {},
    selectionMode: false, selectedStreamers: new Set(),
    workerEndpoint: 'https://autumn-base-826c.rapahannock.workers.dev/',
    workerAuthToken: 'oK2ZrKag8*R7Wr*UgMBrFdcD6',
    autoRefreshInterval: null,
    autoRefreshDelay: 120000,
    toastTimeout: null,
    BANNED_PLACEHOLDER_THUMBNAIL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 9' fill='none' stroke='%23ef4444' stroke-width='1'%3E%3Cpath d='M2 0H14C15.1 0 16 0.9 16 2V7C16 8.1 15.1 9 14 9H2C0.9 9 0 8.1 0 7V2C0 0.9 0.9 0 2 0Z' stroke='none' fill='%2323272d'/%3E%3Ccircle cx='8' cy='4.5' r='3'/%3E%3Cline x1='5.5' y1='2' x2='10.5' y2='7'/%3E%3C/svg%3E",
  },
  
  elements: {},
  cache: new CacheManager(120000),

  init(){
    this.cacheElements();
    this.loadSettings();
    this.registerEventListeners();
    this.populateFilterDropdown();
    this.fetchStreamerList();
    this.startAutoRefresh();
    this.initMouseTracking();
  },

  initMouseTracking() {
    document.addEventListener('mousemove', (e) => {
      document.querySelectorAll('.streamer').forEach(card => {
        const rect = card.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        card.style.setProperty('--mouse-x', `${x}%`);
        card.style.setProperty('--mouse-y', `${y}%`);
      });
    });
  },

  cacheElements(){
    this.elements = {
      container: document.getElementById('streamers'),
      searchInput: document.getElementById('search-input'),
      lastUpdated: document.getElementById('last-updated'),
      statusIndicator: document.getElementById('connection-status'),
      settingsToggle: document.getElementById('settings-toggle'),
      settingsPanel: document.getElementById('settings-panel'),
      settingsOverlay: document.getElementById('settings-overlay'),
      toast: document.getElementById('toast'),
      filterSelect: document.getElementById('filter-select'),
      sortSelect: document.getElementById('sort-select'),
      autoRefreshSelect: document.getElementById('auto-refresh-select'),
      addInput: document.getElementById('add-input'),
      platformSelect: document.getElementById('platform-select'),
      addBtn: document.getElementById('add-btn'),
      selectModeBtn: document.getElementById('select-mode-btn'),
      bulkActions: document.getElementById('bulk-actions'),
      selectionCount: document.getElementById('selection-count'),
      bulkFavoriteBtn: document.getElementById('bulk-favorite'),
      bulkUnfavoriteBtn: document.getElementById('bulk-unfavorite'),
      selectAllBtn: document.getElementById('select-all'),
      clearSelectionBtn: document.getElementById('clear-selection'),
      geminiChoiceBtn: document.getElementById('gemini-choice-btn'),
      geminiModal: document.getElementById('gemini-modal'),
      geminiModalTitle: document.getElementById('gemini-modal-title'),
      geminiModalContent: document.getElementById('gemini-modal-content'),
      geminiModalClose: document.getElementById('gemini-modal-close'),
      thumbnailModal: document.getElementById('thumbnail-modal'),
      enlargedThumbnail: document.getElementById('enlarged-thumbnail'),
      thumbnailModalClose: document.getElementById('thumbnail-modal-close'),
      refreshBtn: document.getElementById('refresh-btn'),
      themeToggleBtn: document.getElementById('theme-toggle-btn'),
      exportBtn: document.getElementById('export-btn'),
      importBtn: document.getElementById('import-btn'),
      importFile: document.getElementById('import-file'),
      installBtn: document.getElementById('install-btn'),
    };
  },

  loadSettings(){
    const theme = localStorage.getItem("theme") || (matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
    document.body.setAttribute("data-theme", theme);
    this.state.favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
    this.state.groups = JSON.parse(localStorage.getItem("groups") || "{}");
    this.state.filter = localStorage.getItem("filter") || 'all';
    this.state.sort = localStorage.getItem("sort") || 'status';
    this.state.autoRefreshDelay = parseInt(localStorage.getItem("autoRefreshDelay") || '120000', 10);
    this.elements.filterSelect.value = this.state.filter;
    this.elements.sortSelect.value = this.state.sort;
    this.elements.autoRefreshSelect.value = this.state.autoRefreshDelay;
    const viewMode = localStorage.getItem("viewMode") || 'grid';
    this.updateViewMode(viewMode);
  },

  registerEventListeners(){
    this.elements.settingsToggle.addEventListener('click', () => this.toggleSettings());
    this.elements.settingsOverlay.addEventListener('click', () => this.toggleSettings());
    this.elements.searchInput.addEventListener('input', Utils.debounce(() => this.render(), 300));
    this.elements.filterSelect.addEventListener('change', e => { this.state.filter = e.target.value; localStorage.setItem('filter', e.target.value); this.render(); });
    this.elements.sortSelect.addEventListener('change', e => { this.state.sort = e.target.value; localStorage.setItem('sort', e.target.value); this.render(); });
    this.elements.autoRefreshSelect.addEventListener('change', e => this.handleAutoRefreshChange(e));
    this.elements.addBtn.addEventListener('click', () => this.addStreamer());

    this.elements.selectModeBtn.addEventListener('click', () => this.toggleSelectionMode());
    this.elements.bulkFavoriteBtn.addEventListener('click', () => this.bulkToggleFavorite(true));
    this.elements.bulkUnfavoriteBtn.addEventListener('click', () => this.bulkToggleFavorite(false));
    this.elements.selectAllBtn.addEventListener('click', () => this.selectAllStreamers());
    this.elements.clearSelectionBtn.addEventListener('click', () => this.clearSelection());

    document.querySelectorAll('.view-toggle[data-view]').forEach(btn => {
      btn.addEventListener('click', e => this.updateViewMode(e.currentTarget.dataset.view));
    });

    this.elements.geminiChoiceBtn.addEventListener('click', () => this.handleRecommendStream());
    this.elements.geminiModal.addEventListener('click', (e) => { if (e.target === e.currentTarget) this.hideGeminiModal(); });
    this.elements.geminiModalClose.addEventListener('click', () => this.hideGeminiModal());

    this.elements.thumbnailModal.addEventListener('click', (e) => { if(e.target === e.currentTarget) this.hideEnlargedThumbnail(); });
    this.elements.thumbnailModalClose.addEventListener('click', () => this.hideEnlargedThumbnail());
    this.elements.enlargedThumbnail.addEventListener('click', e => { 
        const url = e.currentTarget.dataset.streamUrl;
        if(url) window.open(url, '_blank', 'noopener,noreferrer');
    });

    this.elements.refreshBtn.addEventListener('click', () => this.fetchStreamerData());
    this.elements.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
    this.elements.exportBtn.addEventListener('click', () => this.exportList());
    this.elements.importBtn.addEventListener('click', () => this.elements.importFile.click());
    this.elements.importFile.addEventListener('change', e => this.importList(e));
    this.elements.toast.addEventListener('click', () => this.dismissToast());
    
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && this.state.autoRefreshDelay > 0) {
        this.fetchStreamerData();
        this.startAutoRefresh();
      } else {
        this.stopAutoRefresh();
      }
    });
  },
  
  toggleSettings() {
      const isExpanded = this.elements.settingsPanel.classList.toggle('expanded');
      this.elements.settingsToggle.setAttribute('aria-expanded', isExpanded);
      this.elements.settingsOverlay.classList.toggle('visible', isExpanded);
  },

  handleAutoRefreshChange(event) {
    this.state.autoRefreshDelay = parseInt(event.target.value, 10);
    localStorage.setItem('autoRefreshDelay', this.state.autoRefreshDelay);
    this.startAutoRefresh();
    const friendlyTime = event.target.options[event.target.selectedIndex].text;
    this.showToast(`Auto-refresh set to ${friendlyTime.toLowerCase()}`, 'info');
  },

  startAutoRefresh() {
    this.stopAutoRefresh();
    if (this.state.autoRefreshDelay > 0) {
      this.state.autoRefreshInterval = setInterval(() => {
        if (!document.hidden) {
          this.fetchStreamerData();
        }
      }, this.state.autoRefreshDelay);
    }
  },

  stopAutoRefresh() {
    if (this.state.autoRefreshInterval) {
      clearInterval(this.state.autoRefreshInterval);
      this.state.autoRefreshInterval = null;
    }
  },

  populateFilterDropdown(){
    const defs = `<option value="all">All</option><option value="live">Live</option><option value="offline">Offline</option><option value="favorites">Favorites</option>`;
    const groups = Object.keys(this.state.groups).sort().map(n=>`<option value="group-${n}">üìÇ ${Utils.sanitizeHTML(n)}</option>`).join('');
    this.elements.filterSelect.innerHTML = defs + (groups? '<option disabled>-----</option>'+groups : '');
    this.elements.filterSelect.value = this.state.filter;
  },

  async fetchStreamerList(){
    this.setLoadingState(true);
    this.updateConnectionStatus('connecting');
    try {
      if (this.state.workerAuthToken === 'YOUR_WORKER_AUTH_TOKEN' || !this.state.workerAuthToken) {
        throw new Error('Authentication token is missing. Please check the App.state configuration.');
      }
      const headers = { 'Authorization': `Bearer ${this.state.workerAuthToken}` };
      const res = await fetch(`${this.state.workerEndpoint}?t=${Date.now()}`, { headers });

      if (res.status === 401) throw new Error('Unauthorized (401). Your worker authentication token is incorrect or has expired.');
      if (!res.ok) throw new Error(`Network response was not ok: ${res.status}`);
      
      const data = await res.json();
      this.state.streamers = data.streamers || [];
      this.state.twitchClientId = data.config?.twitchClientId;
      this.state.twitchAccessToken = data.config?.twitchAccessToken;
      this.state.youtubeApiKey = data.config?.youtubeApiKey;
      
      this.updateConnectionStatus('connected');
      await this.fetchStreamerData();
    } catch(err) {
      console.error('Failed to load data from worker:', err);
      this.updateConnectionStatus('error');
      this.setLoadingState(false);
      this.renderErrorState("Failed to Load Streamers", err.message);
    }
  },
  
  async fetchStreamerData() {
    this.setLoadingState(true);
    if (!this.state.streamers.length) {
        this.setLoadingState(false);
        this.render();
        return;
    }
    const promises = this.state.streamers.map(s => this.fetchStreamerInfo(s));
    const results = await Promise.allSettled(promises);
    results.forEach(r => {
      if (r.status === 'fulfilled' && r.value) {
        this.state.streamerData.set(r.value.name, r.value);
      }
    });
    this.setLoadingState(false);
  },

   async fetchStreamerInfo(streamer) {
    const {name, platform} = streamer;
    const k = `api-${platform}-${name}`;
    const c = this.cache.get(k); if (c) return c;
    
    let data;
    try {
        if (platform === 'kick') data = await this.fetchKickStreamer(name);
        else if (platform === 'twitch') data = await this.fetchTwitchStreamer(name);
        else if (platform === 'youtube') data = await this.fetchYouTubeStreamer(name);
        else data = { name, platform, isLive: false, title: "Platform not supported", viewers: 0 };
    } catch(e) {
        console.error(`Failed to fetch data for ${name} on ${platform}:`, e);
        const errorMessage = e.message.includes('403') 
            ? "API Key Error (403)" 
            : "Error fetching data";
        data = { name, platform, isLive: false, title: errorMessage, viewers: 0, url: this.getFallbackUrl(name, platform) };
    }

    this.cache.set(k, data);
    return data;
  },

  getFallbackUrl(name, platform) {
      switch(platform) {
          case 'kick': return `https://kick.com/${name}`;
          case 'twitch': return `https://twitch.tv/${name}`;
          case 'youtube': return `https://www.youtube.com/@${name.replace('@','')}`;
          default: return '#';
      }
  },
  
  async fetchApi(url, headers = {}) {
    for (let i = 0; i < 3; i++) {
      try {
        const r = await fetch(url, { headers });
        if (r.status === 404) return null;
        if (!r.ok) throw new Error(`API responded with status ${r.status}`);
        return r.json();
      } catch (e) {
        if (i < 2) await new Promise(res => setTimeout(res, 1200));
        else throw e;
      }
    }
  },
  
  async fetchKickStreamer(name) {
    const kickApiUrl = `https://kick.com/api/v1/channels/${encodeURIComponent(name)}`;
    const url = `https://corsproxy.io/?${encodeURIComponent(kickApiUrl)}`;
    const d = await this.fetchApi(url);
    if (!d) return { name, platform: 'kick', isLive: false, title: "Banned / Not Found", url: `https://kick.com/${name}`, viewers: 0, category: null, uptime: 0 };
    const isLive = d.livestream !== null;
    return {
      name, platform: 'kick', isLive,
      title: d.livestream?.session_title || "Offline",
      viewers: d.livestream?.viewer_count || 0,
      category: d.livestream?.categories?.[0]?.name || null,
      thumbnail: d.livestream?.thumbnail?.url?.replace('thumbnail_360p', 'thumbnail_720p') || null,
      url: `https://kick.com/${name}`,
      profilePic: d.user?.profile_pic || '',
      uptime: isLive ? Utils.calculateUptime(d.livestream.created_at) : 0,
    };
  },

  async fetchTwitchStreamer(name) {
    if (!this.state.twitchClientId || !this.state.twitchAccessToken) return { name, platform: 'twitch', isLive: false, title: 'Twitch API keys not set' };
    const headers = { 'Client-ID': this.state.twitchClientId, 'Authorization': `Bearer ${this.state.twitchAccessToken}` };
    const [streamRes, userRes] = await Promise.all([
      this.fetchApi(`https://api.twitch.tv/helix/streams?user_login=${encodeURIComponent(name)}`, headers),
      this.fetchApi(`https://api.twitch.tv/helix/users?login=${encodeURIComponent(name)}`, headers)
    ]);
    const streamData = streamRes?.data?.[0];
    const userData = userRes?.data?.[0];
    if (!userData) return { name, platform: 'twitch', isLive: false, title: 'Not Found' };
    const isLive = !!streamData && streamData.type === 'live';
    return {
      name, platform: 'twitch', isLive,
      title: isLive ? streamData.title : "Offline",
      viewers: isLive ? streamData.viewer_count : 0,
      category: isLive ? streamData.game_name : null,
      thumbnail: isLive ? streamData.thumbnail_url.replace('{width}', '440').replace('{height}', '248') : null,
      url: `https://twitch.tv/${name}`,
      profilePic: userData.profile_image_url || '',
      uptime: isLive ? Utils.calculateUptime(streamData.started_at) : 0,
    };
  },
    
  async fetchYouTubeStreamer(name) {
    if (!this.state.youtubeApiKey) {
      console.warn("YouTube API key not found in the state after fetching config from worker.");
      return { name, platform: 'youtube', isLive: false, title: 'YouTube API key missing' };
    }

    try {
        const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(name)}&type=channel&key=${this.state.youtubeApiKey}`;
        const searchData = await this.fetchApi(searchUrl);
        const channel = searchData?.items?.[0];

        if (!channel) {
            console.warn(`YouTube channel not found for name: ${name}`);
            return { name, platform: 'youtube', isLive: false, title: 'Channel not found', url: this.getFallbackUrl(name, 'youtube') };
        }
        
        const { channelId } = channel.id;
        const profilePic = channel.snippet.thumbnails.default.url;
        const channelUrl = `https://www.youtube.com/channel/${channelId}`;

        const liveSearchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&eventType=live&type=video&key=${this.state.youtubeApiKey}`;
        const liveData = await this.fetchApi(liveSearchUrl);
        const liveStream = liveData?.items?.[0];

        if (!liveStream) {
            return { name, platform: 'youtube', isLive: false, title: "Offline", profilePic, url: channelUrl, viewers: 0, category: null, uptime: 0 };
        }

        const videoId = liveStream.id.videoId;
        const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails,snippet&id=${videoId}&key=${this.state.youtubeApiKey}`;
        const videoData = await this.fetchApi(videoDetailsUrl);
        const videoDetails = videoData?.items?.[0];

        if (!videoDetails) {
            return { name, platform: 'youtube', isLive: false, title: "Offline", profilePic, url: channelUrl, viewers: 0, category: null, uptime: 0 };
        }

        return {
            name,
            platform: 'youtube',
            isLive: true,
            title: videoDetails.snippet.title || "Live",
            viewers: parseInt(videoDetails.liveStreamingDetails.concurrentViewers || 0, 10),
            category: videoDetails.snippet.tags ? videoDetails.snippet.tags.slice(0, 3).join(', ') : 'General',
            thumbnail: videoDetails.snippet.thumbnails.high?.url || videoDetails.snippet.thumbnails.medium?.url || null,
            url: channelUrl,
            profilePic,
            uptime: Utils.calculateUptime(videoDetails.snippet.publishedAt),
        };
    } catch (error) {
        console.error(`Failed to fetch YouTube data for ${name}:`, error);
        throw error; 
    }
  },

  getFilteredAndSortedData() {
      let data = Array.from(this.state.streamerData.values());
      this.state.searchQuery = this.elements.searchInput.value.toLowerCase();
      
      data = data.filter(s => {
        const searchMatch = !this.state.searchQuery || 
               s.name.toLowerCase().includes(this.state.searchQuery) ||
               (s.title || '').toLowerCase().includes(this.state.searchQuery) ||
               (s.category || '').toLowerCase().includes(this.state.searchQuery);
        if (!searchMatch) return false;
        
        if(this.state.filter.startsWith('group-')){
            const g=this.state.filter.replace('group-','');
            return this.state.groups[g]?.includes(s.name);
        }
        switch(this.state.filter){
            case 'live': return s.isLive;
            case 'offline': return !s.isLive;
            case 'favorites': return this.state.favorites.includes(s.name);
            default: return true;
        }
      });

      return data.sort((a,b) => {
        switch(this.state.sort) {
            case 'viewers': return (b.viewers || 0) - (a.viewers || 0);
            case 'name': return a.name.localeCompare(b.name);
            case 'category': return (a.category || '').localeCompare(b.category || '');
            case 'uptime': return (b.uptime || 0) - (a.uptime || 0);
            case 'status': default:
                if (a.isLive !== b.isLive) return b.isLive ? 1 : -1;
                return (b.viewers || 0) - (a.viewers || 0);
        }
      });
  },

  render(){
    if(this.state.isLoading) return this.renderSkeletons();
    
    const filtered = this.getFilteredAndSortedData();

    this.elements.container.innerHTML = '';
    if (!filtered.length) return this.renderEmptyState();
    
    const frag = document.createDocumentFragment();
    filtered.forEach((s, i) => {
      const card = this.createStreamerCard(s);
      card.style.animationDelay = `${i * 0.05}s`;
      frag.appendChild(card);
    });
    this.elements.container.appendChild(frag);
    this.elements.lastUpdated.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
    this.updateSelectionUI();
  },

  createStreamerCard(s) {
    const div = document.createElement('div');
    const isFav = this.state.favorites.includes(s.name);
    const isSel = this.state.selectedStreamers.has(s.name);
    div.className = `streamer ${s.platform} ${s.isLive ? 'live' : 'offline'} ${isFav ? 'favorite' : ''} ${this.state.viewMode}-view ${isSel ? 'selected' : ''}`;
    div.dataset.name = s.name;
    
    const platformIcon = `<svg class="platform-icon" role="img" viewBox="0 0 24 24" fill="currentColor">${{
        kick: '<path d="M19.43 2.57L4.57 17.43V2.57h14.86M19.43 0H4.57C2.05 0 0 2.05 0 4.57v14.86C0 21.95 2.05 24 4.57 24h14.86c2.52 0 4.57-2.05 4.57-4.57V4.57C24 2.05 21.95 0 19.43 0z"/>',
        twitch: '<path d="M11.571 4.714h1.715v5.143H11.57zm4.714 0h1.715v5.143h-1.715zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0H6zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714v9.429z"/>',
        youtube: '<path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>'
    }[s.platform] || ''}</svg>`;

    let thumbnailSrc = s.thumbnail || '';
    if (s.title === 'Banned / Not Found') {
        thumbnailSrc = this.state.BANNED_PLACEHOLDER_THUMBNAIL;
    }
    const defaultThumbnail = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
    
    let metaText = 'Offline';
    if (s.isLive) {
        metaText = `${Utils.formatNumber(s.viewers)} viewers ‚Ä¢ ${Utils.formatDuration(s.uptime || 0)}`;
    } else if (s.title === 'API Key Error (403)') {
        metaText = `<span style="color: var(--warning);">${s.title}</span>`;
    } else if (s.title === 'Banned / Not Found') {
        metaText = `<span style="color: var(--error);">${s.title}</span>`;
    }

    div.innerHTML = `
      ${this.state.selectionMode ? `<input type="checkbox" class="streamer-checkbox" ${isSel ? 'checked' : ''}>` : ''}
      <div class="thumbnail-container" data-url="${s.url}" data-src="${thumbnailSrc}">
        <img class="thumbnail-preview" src="${thumbnailSrc}" loading="lazy" onerror="this.style.backgroundColor='var(--bg-tertiary)'; this.src='${defaultThumbnail}'"/>
        ${s.isLive ? `<div class="live-indicator">LIVE</div>` : ''}
      </div>
      <div class="streamer-content">
        <div class="streamer-header">
          <img class="streamer-avatar" src="${s.profilePic}" alt="" onerror="this.style.backgroundColor='var(--bg-tertiary)'">
          <div class="streamer-name-wrapper">
            <a href="${s.url}" target="_blank" rel="noopener noreferrer" class="streamer-name">${platformIcon} ${Utils.sanitizeHTML(s.name)}</a>
            <div class="stream-meta">${metaText}</div>
          </div>
        </div>
        <p class="stream-title">${Utils.sanitizeHTML(s.title)}</p>
        ${s.category ? `<div class="stream-category">üéÆ ${Utils.sanitizeHTML(s.category)}</div>` : ''}
        <div class="streamer-actions-wrapper">
            <button class="action-menu-toggle" aria-label="More actions">‚Ä¢‚Ä¢‚Ä¢</button>
            <div class="actions-drawer">
                <button class="action-btn summarize" data-name="${s.name}" ${!s.isLive ? 'disabled' : ''}>‚ú® Summarize</button>
                <button class="action-btn favorite ${isFav ? 'active' : ''}" data-name="${s.name}">‚≠ê Favorite</button>
                <button class="action-btn assign-group" data-name="${s.name}">üìÇ Group</button>
                <button class="action-btn remove" data-name="${s.name}" data-platform="${s.platform}">üóëÔ∏è Remove</button>
            </div>
        </div>
      </div>
    `;
    div.addEventListener('click', e => {
        if (e.target.closest('.thumbnail-container')) {
            const thumb = e.target.closest('.thumbnail-container');
            if (thumb.dataset.src) this.showEnlargedThumbnail(thumb.dataset.src, thumb.dataset.url);
            return;
        }
        if (this.state.selectionMode && !e.target.closest('a, button, .streamer-actions-wrapper')) {
            this.toggleSelection(e.currentTarget.dataset.name);
        }
    });

    const menuToggle = div.querySelector('.action-menu-toggle');
    menuToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        const parentCard = e.currentTarget.closest('.streamer');
        
        document.querySelectorAll('.streamer.actions-open').forEach(openCard => {
            if(openCard !== parentCard) {
                openCard.classList.remove('actions-open');
            }
        });
        parentCard.classList.toggle('actions-open');
    });

    div.querySelector('.summarize').addEventListener('click', (e) => { e.stopPropagation(); this.handleStreamSummary(e.currentTarget.dataset.name); });
    div.querySelector('.favorite').addEventListener('click', (e) => { e.stopPropagation(); this.toggleFavorite(e.currentTarget.dataset.name); });
    div.querySelector('.assign-group').addEventListener('click', (e) => { e.stopPropagation(); this.showToast("Group functionality not yet re-implemented.", "info"); });
    div.querySelector('.remove').addEventListener('click', (e) => { e.stopPropagation(); this.removeStreamer(e.currentTarget.dataset.name, e.currentTarget.dataset.platform); });
    return div;
  },
  
  toggleSelectionMode() {
    this.state.selectionMode = !this.state.selectionMode;
    if (!this.state.selectionMode) {
        this.state.selectedStreamers.clear();
    }
    this.elements.selectModeBtn.classList.toggle('active', this.state.selectionMode);
    this.elements.bulkActions.style.display = this.state.selectionMode ? 'flex' : 'none';
    this.render();
  },
  toggleSelection(name) {
    if (this.state.selectedStreamers.has(name)) {
        this.state.selectedStreamers.delete(name);
    } else {
        this.state.selectedStreamers.add(name);
    }
    this.render();
  },
  selectAllStreamers() {
      this.getFilteredAndSortedData().forEach(s => this.state.selectedStreamers.add(s.name));
      this.render();
  },
  clearSelection() {
      this.state.selectedStreamers.clear();
      this.render();
  },
  updateSelectionUI() {
    if (!this.state.selectionMode) return;
    const count = this.state.selectedStreamers.size;
    this.elements.selectionCount.textContent = `${count} selected`;
  },
  bulkToggleFavorite(add) {
    this.state.selectedStreamers.forEach(name => {
        const has = this.state.favorites.includes(name);
        if (add && !has) this.state.favorites.push(name);
        if (!add && has) this.state.favorites = this.state.favorites.filter(f => f !== name);
    });
    localStorage.setItem('favorites', JSON.stringify(this.state.favorites));
    this.render();
  },

  async handleStreamSummary(name) {
    const s = this.state.streamerData.get(name);
    if (!s) return;
    this.showGeminiModal(`Summary for ${s.name}`);
    if (!s.isLive) {
      this.elements.geminiModalContent.innerHTML = `<p>${s.name} is currently offline.</p>`;
      return;
    }
    const prompt = `Act as an enthusiastic stream commentator. Based on the following data for the streamer '${s.name}', write a short, exciting summary (2-3 sentences) of what they are currently streaming. Stream Title: '${s.title}', Game/Category: '${s.category}'.`;
    try {
      const summary = await Gemini.ask(prompt);
      this.elements.geminiModalContent.innerHTML = `<p>${Utils.sanitizeHTML(summary)}</p>`;
    } catch (error) {
      this.elements.geminiModalContent.innerHTML = `<p class="error-text">Could not generate summary. The AI service may be temporarily unavailable.</p>`;
    }
  },
  
  async handleRecommendStream() {
    const liveStreamers = [...this.state.streamerData.values()].filter(s => s.isLive);
    if (liveStreamers.length === 0) {
      this.showToast("No one is live right now!", 'info');
      return;
    }
    this.showGeminiModal("Which stream should I watch?");

    const streamerInfo = liveStreamers
        .map(s => `${s.name} (${s.category || 'Misc'})`)
        .join(', ');
    const prompt = `From the following list of live streamers, who should I watch? Give me one fun, exciting recommendation and a brief reason why. List: ${streamerInfo}.`;
    
    try {
      const recommendation = await Gemini.ask(prompt);
      this.elements.geminiModalContent.innerHTML = `<p>${Utils.sanitizeHTML(recommendation)}</p>`;
    } catch (error) {
      this.elements.geminiModalContent.innerHTML = `<p class="error-text">Could not get a recommendation. The AI service may be temporarily unavailable.</p>`;
    }
  },
  
  showGeminiModal(title) {
    this.elements.geminiModalTitle.textContent = title;
    this.elements.geminiModalContent.innerHTML = '<div class="spinner"></div>';
    this.elements.geminiModal.classList.add('visible');
  },
  hideGeminiModal() {
    this.elements.geminiModal.classList.remove('visible');
  },

  showEnlargedThumbnail(src, url) {
    if (!src) return;
    this.elements.enlargedThumbnail.src = src;
    this.elements.enlargedThumbnail.dataset.streamUrl = url;
    this.elements.thumbnailModal.classList.add('visible');
  },
  hideEnlargedThumbnail() {
    this.elements.thumbnailModal.classList.remove('visible');
  },
  
  toggleFavorite(name) {
    const favs = new Set(this.state.favorites);
    if (favs.has(name)) favs.delete(name);
    else favs.add(name);
    this.state.favorites = [...favs];
    localStorage.setItem('favorites', JSON.stringify(this.state.favorites));
    this.render();
    this.showToast(`${name} ${favs.has(name) ? 'added to' : 'removed from'} favorites.`, 'success');
  },

  toggleTheme() {
    const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.body.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  },

  exportList() {
      const data = JSON.stringify(this.state.streamers);
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'streamers.json';
      a.click();
      URL.revokeObjectURL(url);
      this.showToast('Exported successfully!', 'success');
  },

  importList(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
          try {
              const imported = JSON.parse(e.target.result);
              if (!Array.isArray(imported)) throw new Error("Invalid format");
              const result = await this.postToWorker({ action: 'bulkReplace', list: imported });
              if (result) {
                  this.showToast('Import successful! Refreshing list...', 'success');
                  await this.fetchStreamerList();
              }
          } catch (err) {
              this.showToast(`Import failed: ${err.message}`, 'error');
          }
      };
      reader.readAsText(file);
      event.target.value = '';
  },
  
  async addStreamer() {
    const name = this.elements.addInput.value.trim();
    const platform = this.elements.platformSelect.value;
    if (!name) return this.showToast('Please enter a streamer name.', 'warning');

    const result = await this.postToWorker({ action: 'add', name, platform });
    if (result !== null) {
      this.showToast(`${name} added successfully!`, 'success');
      this.elements.addInput.value = '';
      await this.fetchStreamerList();
    }
  },

  async removeStreamer(name, platform) {
    const pin = prompt(`Enter PIN to confirm removal of ${name}:`);
    if (pin === null) {
        this.showToast('Removal cancelled.', 'info');
        return;
    }
    const result = await this.postToWorker({ action: 'remove', name, platform, pin });
    if (result !== null) {
      this.showToast(`üóëÔ∏è ${name} removed successfully.`, 'success');
      await this.fetchStreamerList();
    }
  },
  
  async postToWorker(body) {
    try {
      if (this.state.workerAuthToken === 'YOUR_WORKER_AUTH_TOKEN' || !this.state.workerAuthToken) {
          throw new Error('Authentication token is missing. Please check the App.state configuration.');
      }
      const res = await fetch(this.state.workerEndpoint, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${this.state.workerAuthToken}`
        },
        body: JSON.stringify(body)
      });
      const txt = await res.text();
      if (!res.ok) throw new Error(txt || `Worker responded with status ${res.status}`);
      return txt;
    } catch (e) {
      this.showToast(`‚ùå Action failed: ${e.message}`, 'error');
      return null;
    }
  },

  setLoadingState(isLoading){ this.state.isLoading = isLoading; this.render(); },
  updateConnectionStatus(status){ this.elements.statusIndicator.className = `status-indicator ${status}`; },
  updateViewMode(mode){
      this.state.viewMode = mode;
      localStorage.setItem("viewMode", mode);
      document.querySelectorAll('.view-toggle[data-view]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === mode);
      });
      this.elements.container.className = `${mode}-view`;
      this.render();
  },
  renderSkeletons(){
    this.elements.container.innerHTML = Array(8).fill('').map((_, i) => `
      <div class="streamer skeleton" style="animation-delay: ${i * 0.05}s;">
        <div style="width:100%; aspect-ratio:16/9; background: var(--bg-tertiary); border-radius: var(--radius-lg) var(--radius-lg) 0 0;"></div>
        <div class="streamer-content">
          <div class="streamer-header">
            <div style="width:52px; height:52px; border-radius:50%; background: var(--bg-tertiary);"></div>
            <div style="flex:1;">
              <div style="height:20px; width:60%; background:var(--bg-tertiary); border-radius:6px; margin-bottom:8px;"></div>
              <div style="height:14px; width:40%; background:var(--bg-tertiary); border-radius:6px;"></div>
            </div>
          </div>
          <div style="height:16px; width:90%; background:var(--bg-tertiary); border-radius:6px; margin-top:12px;"></div>
        </div>
      </div>
    `).join('');
  },
  renderEmptyState(){ this.elements.container.innerHTML = `<div class="empty-state"><h3>No Streamers Found</h3><p>No streamers match your current filter, or your list is empty.</p></div>`; },
  renderErrorState(title, message){ this.elements.container.innerHTML = `<div class="error-state"><h3>${title}</h3><p>${message}</p></div>`; },
  
  showToast(msg, type = 'info') {
    const t = this.elements.toast;
    if (!t) return;
    if (this.state.toastTimeout) {
      clearTimeout(this.state.toastTimeout);
    }
    t.textContent = msg;
    t.className = '';
    t.classList.add(type);
    t.classList.add('show');
    this.state.toastTimeout = setTimeout(() => {
        this.dismissToast();
    }, 5000);
  },

  dismissToast() {
      const t = this.elements.toast;
      if (!t) return;
      t.classList.remove('show');
      if (this.state.toastTimeout) {
          clearTimeout(this.state.toastTimeout);
          this.state.toastTimeout = null;
      }
  }
};

document.addEventListener('DOMContentLoaded', async () => {
  try {
    await PWA.init();
    App.init();
  } catch(e) {
    console.error('Failed to initialize:', e);
    document.body.innerHTML = `<div class="error-state" style="margin:20px;"><h1>Failed to load Monitor</h1><p>${e.message}</p></div>`;
  }
});
</script>
</body>
</html>
