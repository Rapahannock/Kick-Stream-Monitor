<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kick & Twitch Monitor v7.9.5</title>
  <meta name="description" content="Monitor your favorite Kick, Twitch, and YouTube streamers with real-time updates, AI-powered summaries, and enhanced accessibility">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #050505;
      --bg-glass: rgba(20, 20, 25, 0.7);
      --bg-glass-hover: rgba(30, 30, 35, 0.85);
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --border-primary: rgba(255, 255, 255, 0.1);
      --accent-primary: #22d3ee;
      --live: #10b981;
      --twitch: #9146ff;
      --youtube: #ff0000;
      --kick: #53fc18;
      --offline: #64748b;
      --warning: #f59e0b;
      --red-light: #ff4444;
      --radius-sm: 8px;
      --radius-md: 12px;
      --transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    [data-theme="light"] {
        --bg-primary: #f8fafc;
        --bg-glass: rgba(255, 255, 255, 0.8);
        --bg-glass-hover: rgba(255, 255, 255, 0.95);
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --border-primary: rgba(0, 0, 0, 0.1);
        --accent-primary: #0891b2;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      color: var(--text-primary);
      margin: 0;
      padding: 20px 20px 100px 20px;
      min-height: 100vh;
    }

    #app-container { max-width: 2400px; margin: 0 auto; }
    
    #streamers { 
        display: grid; 
        gap: 16px; 
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
    }
    
    #streamers.list-view {
        grid-template-columns: 1fr;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* POSTER CARD STYLE */
    .streamer {
        position: relative;
        aspect-ratio: 16/9; 
        border-radius: var(--radius-md);
        overflow: hidden;
        background: #111;
        border: 1px solid var(--border-primary);
        transition: var(--transition);
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    .streamer:hover {
        transform: scale(1.03);
        box-shadow: 0 16px 32px rgba(0,0,0,0.6);
        z-index: 100;
        border-color: rgba(255,255,255,0.4);
    }

    .streamer.list-view-view {
        aspect-ratio: auto;
        height: 140px;
        display: flex;
        flex-direction: row;
        transform: none !important;
    }
    .streamer.list-view-view:hover {
        background: var(--bg-glass-hover);
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    .streamer-img {
        width: 100%;
        height: 100%;
        object-fit: cover; 
        transition: var(--transition);
    }
    
    .streamer.list-view-view .thumbnail-container {
        width: 250px;
        height: 100%;
        flex-shrink: 0;
        border-radius: 0;
    }
    
    .name-tag {
        position: absolute;
        bottom: 0; left: 0; right: 0;
        padding: 10px 12px 10px 16px;
        background: linear-gradient(to top, rgba(0,0,0,0.95) 30%, transparent);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        z-index: 15;
        transition: transform 0.3s ease;
    }
    .streamer:hover .name-tag {
        transform: translateY(100%);
    }
    .streamer.list-view-view .name-tag { display: none; }

    .streamer-name {
        font-weight: 800;
        font-size: 1.1rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.9);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #fff;
        width: 100%;
    }

    /* Error State Styling for Card */
    .streamer.error-key {
        border-color: var(--warning);
    }
    .streamer.error-key .streamer-name {
        color: var(--warning);
    }

    .marquee-wrapper {
        width: 100%;
        overflow: hidden;
        position: relative;
        height: 20px;
        mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
    }

    .stream-title-marquee {
        display: inline-block;
        white-space: nowrap;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
        animation: marquee 15s linear infinite;
        padding-left: 100%;
    }

    @keyframes marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
    }

    .details-overlay {
        position: absolute;
        inset: 0;
        padding: 16px;
        background: rgba(10, 10, 14, 0.85); 
        backdrop-filter: blur(4px);
        display: flex;
        flex-direction: column;
        opacity: 0;
        transition: opacity 0.2s ease;
        z-index: 25;
        pointer-events: none;
    }
    .streamer:hover .details-overlay, .streamer.active .details-overlay {
        opacity: 1;
        pointer-events: auto;
    }

    .streamer.list-view-view .details-overlay {
        position: relative;
        opacity: 1;
        background: transparent;
        backdrop-filter: none;
        pointer-events: auto;
        inset: auto;
        width: 100%;
        height: 100%;
        padding: 16px 24px;
    }

    .streamer::before {
        content: '';
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 4px;
        z-index: 20;
        box-shadow: 2px 0 15px currentColor;
    }
    .streamer.kick::before { background: var(--kick); color: var(--kick); }
    .streamer.twitch::before { background: var(--twitch); color: var(--twitch); }
    .streamer.youtube::before { background: var(--youtube); color: var(--youtube); }
    .streamer.offline::before { background: var(--offline); color: var(--offline); opacity: 0.5; box-shadow: none;}

    .overlay-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
    }
    .overlay-name { font-weight: 800; font-size: 1.2rem; color: #fff; }
    .live-badge {
        font-size: 0.75rem; font-weight: 800;
        padding: 4px 8px; border-radius: 4px;
        background: rgba(255,255,255,0.1);
        color: var(--text-secondary);
    }
    .streamer.live .live-badge {
        background: var(--live);
        color: #000;
        box-shadow: 0 0 10px var(--live);
    }

    .overlay-title {
        font-size: 0.9rem;
        color: #e0e0e0;
        margin-bottom: 4px;
        line-height: 1.3;
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        font-weight: 500;
    }
    .overlay-category {
        font-size: 0.8rem;
        color: var(--accent-primary);
        font-weight: 600;
        margin-bottom: auto; 
    }
    .overlay-stats {
        font-size: 0.8rem;
        color: #ccc;
        margin-bottom: 12px;
        font-weight: 600;
        display: flex; gap: 8px;
    }

    .overlay-actions {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 8px;
    }
    .icon-action {
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        height: 36px;
        color: var(--text-secondary);
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: all 0.2s;
        font-size: 16px;
    }
    .icon-action:hover {
        background: var(--text-primary);
        color: #000;
        transform: translateY(-2px);
    }
    .icon-action.enlarge-btn {
        background: var(--accent-primary);
        color: #000;
        border: none;
    }
    .icon-action.enlarge-btn:hover {
        filter: brightness(1.2);
    }

    /* Floating Bar */
    .floating-bar {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      z-index: 1000;
      background: rgba(10, 10, 12, 0.7);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 8px 12px;
      display: flex; align-items: center; gap: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
      width: max-content; max-width: 95vw;
    }
    .app-logo { font-weight: 800; font-size: 1rem; color: var(--text-primary); margin-right: 8px; white-space: nowrap; }
    .bar-btn {
        background: rgba(255,255,255,0.05); border: none;
        color: var(--text-secondary); padding: 8px 12px;
        border-radius: 8px; font-weight: 600; cursor: pointer;
        transition: 0.2s; font-size: 0.85rem;
    }
    .bar-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .bar-btn.active { background: var(--text-primary); color: #000; }
    
    #gemini-btn {
        background: linear-gradient(135deg, var(--accent-primary), #3b82f6);
        color: #000;
    }

    /* Settings Panel */
    .settings-panel {
        position: fixed; top: 0; right: 0; bottom: 0; width: 350px;
        background: #0a0a0a; border-left: 1px solid var(--border-primary);
        transform: translateX(100%); transition: transform 0.3s ease;
        z-index: 1200; padding: 24px; box-shadow: -10px 0 50px rgba(0,0,0,0.5);
    }
    .settings-panel.open { transform: translateX(0); }
    .settings-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1100;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
        backdrop-filter: blur(4px);
    }
    .settings-overlay.visible { opacity: 1; pointer-events: auto; }
    
    .setting-row { margin-bottom: 16px; }
    .setting-label { display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary); }
    .setting-input { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid var(--border-primary); color: #fff; border-radius: 6px; }

    /* Modals */
    .modal {
        position: fixed; inset: 0; z-index: 2000;
        background: rgba(0,0,0,0.9);
        display: none; align-items: center; justify-content: center;
        backdrop-filter: blur(10px);
    }
    .modal.visible { display: flex; animation: fadeIn 0.2s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    #enlarged-img {
        max-width: 95vw; max-height: 90vh;
        border-radius: 12px;
        box-shadow: 0 0 50px rgba(0,0,0,0.8);
        border: 1px solid var(--border-primary);
        cursor: pointer;
        transition: transform 0.2s;
    }
    #enlarged-img:hover { transform: scale(1.01); }
    .modal-close {
        position: absolute; top: 20px; right: 20px;
        background: rgba(255,255,255,0.1); border: none;
        color: #fff; width: 40px; height: 40px; border-radius: 50%;
        font-size: 24px; cursor: pointer;
    }

    .gemini-content {
        background: #111; padding: 24px; border-radius: 16px;
        border: 1px solid var(--border-primary);
        max-width: 500px; width: 90%;
        color: var(--text-secondary);
    }
    .gemini-content h3 { color: var(--accent-primary); margin-top: 0; }

    /* Toast */
    #toast {
        position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
        background: #111; border: 1px solid var(--border-primary);
        padding: 12px 20px; border-radius: 50px;
        color: #fff; opacity: 0; pointer-events: none;
        transition: 0.3s; z-index: 1500;
    }
    #toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Live Indicator with Red Dot */
    .live-indicator {
      position: absolute; top: 12px; right: 12px;
      display: flex; align-items: center; gap: 6px;
      background: rgba(10, 10, 10, 0.85); 
      color: var(--red-light);
      border: 1px solid rgba(255, 68, 68, 0.2);
      padding: 4px 10px; border-radius: 99px;
      font-size: 0.8rem; font-weight: 800;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 20;
    }
    .live-indicator::before {
      content: ''; 
      display: block; width: 8px; height: 8px;
      background: #ff0000;
      border-radius: 50%;
      box-shadow: 0 0 10px #ff0000;
      animation: redTallyPulse 1.2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes redTallyPulse {
      0% { opacity: 1; transform: scale(1); box-shadow: 0 0 5px #ff0000; }
      50% { opacity: 0.6; transform: scale(0.9); box-shadow: 0 0 2px #ff0000; }
      100% { opacity: 1; transform: scale(1); box-shadow: 0 0 5px #ff0000; }
    }
    
    /* Mobile Adjustments */
    @media (max-width: 768px) {
        #streamers.grid-view { grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .name-tag { padding: 4px 8px; }
        .streamer-name { font-size: 0.8rem; }
        .overlay-actions { grid-template-columns: 1fr 1fr; }
        .floating-bar { width: 95%; justify-content: space-between; padding: 8px; }
        .app-logo { display: none; }
        /* Fix list view on mobile */
        .streamer.list-view-view { flex-direction: column; height: auto; }
        .streamer.list-view-view .thumbnail-container { width: 100%; height: 200px; }
    }
  </style>
</head>
<body>

<div id="app-container">
    <main id="main-content">
        <div id="streamers" class="grid-view"></div>
    </main>
</div>

<!-- Floating Control Bar -->
<div class="floating-bar">
    <span class="app-logo">StreamMonitor</span>
    <button class="bar-btn" id="refresh-yt-btn" title="Refresh YouTube Only">
        <!-- YouTube Red Refresh Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ff0000" width="18" height="18"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
    </button>
    <button class="bar-btn" id="gemini-choice-btn">‚ú® Pick for Me</button>
    <div style="width: 1px; height: 20px; background: var(--border-primary);"></div>
    <button class="bar-btn active" id="view-grid">Grid</button>
    <button class="bar-btn" id="view-list">List</button>
    <div style="flex:1"></div>
    <button class="bar-btn" id="install-btn" style="display:none">Install</button>
    <button class="bar-btn" id="settings-btn">‚öôÔ∏è</button>
</div>

<!-- Settings Panel -->
<div id="settings-overlay" class="settings-overlay"></div>
<div id="settings-panel" class="settings-panel">
    <h2>Settings</h2>
    
    <div class="setting-row">
        <label class="setting-label">Search</label>
        <input type="text" id="search-input" class="setting-input" placeholder="Filter streamers...">
    </div>

    <div class="setting-row">
        <label class="setting-label">Sort By</label>
        <select id="sort-select" class="setting-input">
            <option value="viewers" selected>Viewers (Default)</option>
            <option value="status">Live Status</option>
            <option value="name">Name</option>
        </select>
    </div>

    <div class="setting-row">
        <label class="setting-label">Add Streamer</label>
        <div style="display:flex; gap:8px;">
            <input id="add-name" class="setting-input" placeholder="Name">
            <select id="add-platform" class="setting-input" style="width:100px;">
                <option value="kick">Kick</option>
                <option value="twitch">Twitch</option>
                <option value="youtube">YouTube</option>
            </select>
            <button id="add-btn" class="bar-btn" style="background:var(--accent-primary); color:#000;">Add</button>
        </div>
    </div>
    
    <div class="setting-row" style="margin-top: 32px; border-top: 1px solid var(--border-primary); padding-top: 24px;">
        <label class="setting-label">Data Management</label>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button id="export-btn" class="bar-btn">Export JSON</button>
            <button id="import-btn" class="bar-btn">Import JSON</button>
            <input type="file" id="import-file" style="display:none">
        </div>
    </div>
    
    <div class="setting-row">
         <label class="setting-label">Gemini API Key</label>
         <input type="password" id="gemini-key" class="setting-input" placeholder="Paste API Key here">
         <button id="save-gemini" class="bar-btn" style="width:100%; margin-top:8px;">Save Key</button>
    </div>
    
    <div class="setting-row">
         <label class="setting-label">Worker Auth Token</label>
         <input type="password" id="worker-token" class="setting-input" placeholder="Paste Worker Token here">
         <button id="save-worker-token" class="bar-btn" style="width:100%; margin-top:8px;">Save Token</button>
    </div>
</div>

<!-- Modals -->
<div id="image-modal" class="modal">
    <button class="modal-close">&times;</button>
    <img id="enlarged-img">
</div>

<div id="gemini-modal" class="modal">
    <div class="gemini-content">
        <h3>AI Recommendation</h3>
        <div id="gemini-response">Thinking...</div>
        <button class="bar-btn" style="width:100%; margin-top:16px;" onclick="document.getElementById('gemini-modal').classList.remove('visible')">Close</button>
    </div>
</div>

<div id="toast">Notification</div>

<script>
// --- UTILITIES & CACHE ---
const Utils = {
  debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; },
  formatNumber(n){ if(!n) return '0'; if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1e3) return (n/1e3).toFixed(1)+'K'; return n.toString(); },
  sanitizeHTML(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; },
  formatDuration(m){ if(!m || m < 0) return '0m'; if(m<60) return `${m}m`; const h=Math.floor(m/60), min=m%60; if(h<24) return `${h}h ${min}m`; const d=Math.floor(h/24), rh=h%24; return `${d}d ${rh}h`; },
  calculateUptime(start){ if(!start) return 0; return Math.floor((new Date()-new Date(start))/(1000*60)); },
};

class CacheManager {
  constructor(ttl=60000){ this.cache=new Map(); this.ttl=ttl; }
  set(k,d){ this.cache.set(k,{d,t:Date.now()}); }
  get(k){ 
      const it=this.cache.get(k); 
      if(!it) return null; 
      if(Date.now()-it.t > this.ttl){ this.cache.delete(k); return null; } 
      return it.d; 
  }
  clear(){ this.cache.clear(); }
}

// Global Cache Instance
const streamCache = new CacheManager(120000); // 2 minute cache

/* --- GEMINI API --- */
const Gemini = {
  apiKey: "", 
  async ask(prompt, retries = 3, delay = 1000) {
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${this.apiKey}`;
    const payload = { contents: [{ parts: [{ text: prompt }] }] };
    try {
      const response = await fetch(apiUrl, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error(response.status);
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
    } catch (error) {
       console.error("Gemini API Error:", error);
       throw error;
    }
  }
};

/* --- MAIN APP --- */
const App = {
    state: {
        streamers: [],
        data: new Map(),
        filter: '',
        sort: 'viewers',
        workerUrl: 'https://autumn-base-826c.rapahannock.workers.dev/',
        workerToken: localStorage.getItem('workerToken') || 'oK2ZrKag8*R7Wr*UgMBrFdcD6',
        geminiKey: localStorage.getItem('geminiKey') || '',
        activeCard: null,
        viewMode: 'grid',
        BANNED_PLACEHOLDER_THUMBNAIL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 9' fill='none' stroke='%23ef4444' stroke-width='1'%3E%3Cpath d='M2 0H14C15.1 0 16 0.9 16 2V7C16 8.1 15.1 9 14 9H2C0.9 9 0 8.1 0 7V2C0 0.9 0.9 0 2 0Z' stroke='none' fill='%2323272d'/%3E%3Ccircle cx='8' cy='4.5' r='3'/%3E%3Cline x1='5.5' y1='2' x2='10.5' y2='7'/%3E%3C/svg%3E",
        youtubeQuotaExceeded: false,
    },
    
    els: {
        grid: document.getElementById('streamers'),
        toast: document.getElementById('toast'),
        container: document.getElementById('app-container')
    },

    async init() {
        this.bindEvents();
        await this.fetchList();
        setInterval(() => this.fetchData('auto'), 300000); 
    },

    bindEvents() {
        // UI Toggles
        document.getElementById('view-grid').onclick = () => this.updateViewMode('grid');
        document.getElementById('view-list').onclick = () => this.updateViewMode('list');
        const panel = document.getElementById('settings-panel');
        const overlay = document.getElementById('settings-overlay');
        const toggle = () => { panel.classList.toggle('open'); overlay.classList.toggle('visible'); };
        document.getElementById('settings-btn').onclick = toggle;
        overlay.onclick = toggle;

        // Inputs
        document.getElementById('search-input').oninput = (e) => { this.state.filter = e.target.value.toLowerCase(); this.render(); };
        document.getElementById('sort-select').onchange = (e) => { this.state.sort = e.target.value; this.render(); };
        
        // Actions
        document.getElementById('add-btn').onclick = () => this.addStreamer();
        // Manual YouTube Refresh triggers 'youtube' mode
        document.getElementById('refresh-yt-btn').onclick = () => this.fetchData('youtube', true);
        document.getElementById('gemini-choice-btn').onclick = () => this.askAI();
        document.getElementById('save-gemini').onclick = () => {
            const key = document.getElementById('gemini-key').value;
            if(key) { localStorage.setItem('geminiKey', key); this.state.geminiKey = key; this.toast('AI Key Saved'); }
        };
        document.getElementById('save-worker-token').onclick = () => {
             const key = document.getElementById('worker-token').value;
             if(key) { localStorage.setItem('workerToken', key); this.state.workerToken = key; this.toast('Token Saved'); }
        };
        
        // Export/Import
        document.getElementById('export-btn').onclick = () => this.exportList();
        document.getElementById('import-btn').onclick = () => document.getElementById('import-file').click();
        document.getElementById('import-file').onchange = (e) => this.handleImport(e);

        // Modals
        document.querySelector('.modal-close').onclick = () => document.getElementById('image-modal').classList.remove('visible');
        document.getElementById('image-modal').onclick = (e) => { if(e.target.id === 'image-modal') e.target.classList.remove('visible'); };
        document.getElementById('enlarged-img').onclick = (e) => { if(e.target.dataset.url) window.open(e.target.dataset.url, '_blank'); };
    },

    updateViewMode(mode) {
        this.state.viewMode = mode;
        localStorage.setItem("viewMode", mode);
        document.querySelectorAll('.view-toggle[data-view]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.view === mode);
        });
        this.els.grid.className = mode === 'grid' ? 'grid-view' : 'list-view';
        this.render();
    },

    async fetchList() {
        try {
            const res = await fetch(`${this.state.workerUrl}?t=${Date.now()}`, {
                headers: { 'Authorization': `Bearer ${this.state.workerToken}` }
            });
            if (!res.ok) throw new Error(res.status);
            const json = await res.json();
            this.state.streamers = json.streamers;
            this.state.keys = json.config;
            this.fetchData('all');
        } catch (e) {
            this.toast(`Backend Error: ${e.message}`, 'error');
            if(this.state.streamers.length === 0) {
                 this.state.streamers = [{name:'xqc', platform:'twitch'}, {name:'trainwreckstv', platform:'kick'}];
                 this.fetchData('all');
            }
        }
    },

    async fetchData(mode = 'all', force = false) {
        let queue = this.state.streamers;

        if (mode === 'auto') {
            // EXCLUDE YouTube from auto-refresh to save quota
            queue = queue.filter(s => s.platform !== 'youtube');
        } else if (mode === 'youtube') {
            // ONLY refresh YouTube when button clicked
            queue = queue.filter(s => s.platform === 'youtube');
            this.toast('Refreshing YouTube...', 'info');
            // Reset quota flag on manual refresh to try again
            this.state.youtubeQuotaExceeded = false;
        }

        // Process sequentially to avoid overwhelming browser, but update UI immediately
        queue.forEach(async s => {
            const data = await this.getStreamInfo(s, force);
            this.state.data.set(s.name, data);
            this.render();
        });
        
        this.render();
    },

    async getStreamInfo(s, force = false) {
        let url = '#';
        if(s.platform==='kick') url=`https://kick.com/${s.name}`;
        if(s.platform==='twitch') url=`https://twitch.tv/${s.name}`;
        if(s.platform==='youtube') url=`https://youtube.com/${s.name}`;
        
        const k = `api-${s.platform}-${s.name}`;
        if (!force) {
            const cached = streamCache.get(k); 
            if (cached) return cached;
        }

        const timeout = 5000; 

        try {
            if (s.platform === 'kick') {
                 const d = await this.fetchWithTimeout(`https://corsproxy.io/?${encodeURIComponent(`https://kick.com/api/v1/channels/${s.name}`)}`, {}, timeout);
                 if (!d) throw new Error('Not Found');
                 const result = d.livestream ? {
                     isLive: true, title: d.livestream.session_title, 
                     viewers: d.livestream.viewer_count, category: d.livestream.categories[0].name,
                     // REVERTED to original URL (no cache buster)
                     thumb: d.livestream.thumbnail.url, 
                     url
                 } : { isLive: false, title: 'Offline', url, thumb: d.user.profile_pic };
                 streamCache.set(k, result);
                 return result;
            }
            if (s.platform === 'twitch') {
                 if (!this.state.keys || !this.state.keys.twitchClientId) return { isLive: false, title: 'Config Error', url };
                 const t = Date.now();
                 const [streamRes, userRes] = await Promise.all([
                   this.fetchApi(`https://api.twitch.tv/helix/streams?user_login=${encodeURIComponent(s.name)}&t=${t}`, this.state.keys),
                   this.fetchApi(`https://api.twitch.tv/helix/users?login=${encodeURIComponent(s.name)}&t=${t}`, this.state.keys)
                 ]).catch(() => [{}, {}]);

                 if (!userRes.data || !userRes.data[0]) return { isLive: false, title: 'Not Found', url };
                 const userData = userRes.data[0];
                 const streamData = streamRes.data && streamRes.data[0];
                 const isLive = !!streamData && streamData.type === 'live';
                 const result = {
                    isLive,
                    title: isLive ? streamData.title : 'Offline',
                    viewers: isLive ? streamData.viewer_count : 0,
                    category: isLive ? streamData.game_name : '',
                    // KEPT cache buster for Twitch (required)
                    thumb: isLive ? `${streamData.thumbnail_url.replace('{width}', '640').replace('{height}', '360')}?t=${Date.now()}` : userData.profile_image_url,
                    url
                 };
                 streamCache.set(k, result);
                 return result;
            }
            if (s.platform === 'youtube') {
                 // Check if quota already exceeded
                 if (this.state.youtubeQuotaExceeded) {
                     return { isLive: false, title: 'Daily Limit Reached', url, viewers: 0 };
                 }

                 if (!this.state.keys || !this.state.keys.youtubeApiKey) return { isLive: false, title: 'YouTube Key Missing', url };
                 const apiKey = this.state.keys.youtubeApiKey;
                 const cb = force ? `&_=${Date.now()}` : '';
                 
                 // 1. Search Channel
                 const searchRes = await this.fetchWithTimeout(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(s.name)}&type=channel&key=${apiKey}${cb}`, {}, timeout);
                 if (!searchRes.items || !searchRes.items[0]) return { isLive: false, title: 'Channel Not Found', url };
                 
                 const channelId = searchRes.items[0].id.channelId;
                 const profilePic = searchRes.items[0].snippet.thumbnails.default.url;
                 const channelUrl = `https://www.youtube.com/channel/${channelId}`;

                 // 2. Search Live Video
                 const liveRes = await this.fetchWithTimeout(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&eventType=live&type=video&key=${apiKey}${cb}`, {}, timeout);
                 
                 if (!liveRes.items || !liveRes.items[0]) {
                     const offlineRes = { isLive: false, title: 'Offline', url: channelUrl, thumb: profilePic };
                     streamCache.set(k, offlineRes);
                     return offlineRes;
                 }
                 
                 // 3. Get Video Details
                 const videoId = liveRes.items[0].id.videoId;
                 const videoDetails = await this.fetchWithTimeout(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails,snippet&id=${videoId}&key=${apiKey}${cb}`, {}, timeout);
                 const details = videoDetails.items[0];

                 const result = {
                    isLive: true,
                    title: details.snippet.title,
                    viewers: parseInt(details.liveStreamingDetails.concurrentViewers || 0),
                    category: 'YouTube Live',
                    // REVERTED to original URL (no cache buster)
                    thumb: details.snippet.thumbnails.medium.url,
                    url: channelUrl
                 };
                 streamCache.set(k, result);
                 return result;
            }
            return { isLive: false, title: 'Offline', url }; 
        } catch (e) {
             const is403 = e.message.includes('403');
             if (is403 && s.platform === 'youtube') {
                 // FLIP THE SAFETY SWITCH
                 this.state.youtubeQuotaExceeded = true;
                 const msg = 'Daily Limit Reached';
                 return { isLive: false, title: msg, url };
             }
             if (is403 && s.platform === 'kick') {
                 return { isLive: false, title: 'Access Denied (Kick)', url };
             }
             // For twitch or generic errors
             const msg = is403 ? 'Access Denied' : (e.message.includes('400') ? 'Config Error' : 'Connection Failed');
             return { isLive: false, title: msg, url };
        }
    },
    
    async fetchWithTimeout(resource, options = {}, timeout = 5000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
            const response = await fetch(resource, { ...options, signal: controller.signal });
            clearTimeout(id);
            if (!response.ok) throw new Error(response.status);
            return response.json();
        } catch(e) {
            clearTimeout(id);
            throw e;
        }
    },
    
    async fetchApi(url, keys) {
        const headers = keys && keys.twitchClientId ? {
            'Client-ID': keys.twitchClientId,
            'Authorization': `Bearer ${keys.twitchAccessToken}`
        } : {};
        const r = await fetch(url, { headers, cache: 'no-store' }); 
        if (!r.ok) throw new Error(r.status);
        return r.json();
    },

    render() {
        if(this.state.isLoading && this.state.data.size === 0) return this.renderSkeletons();
        
        const list = this.state.streamers.map(s => {
            const info = this.state.data.get(s.name) || { isLive: false, title: 'Loading...', isLoading: true, url: '#' };
            return { ...s, ...info };
        }).filter(s => {
            if (!this.state.filter) return true;
            return s.name.toLowerCase().includes(this.state.filter) || 
                   (s.category && s.category.toLowerCase().includes(this.state.filter));
        }).sort((a, b) => {
            if (this.state.sort === 'viewers') return (b.viewers || 0) - (a.viewers || 0);
            if (this.state.sort === 'status') return (b.isLive === a.isLive) ? 0 : b.isLive ? 1 : -1;
            return a.name.localeCompare(b.name);
        });

        this.els.grid.innerHTML = list.map(s => `
            <div class="streamer ${s.platform} ${s.isLive?'live':''} ${this.state.viewMode === 'list' ? 'list-view-view' : ''} ${s.title.includes('Error') || s.title.includes('Limit') || s.title.includes('Denied') ? 'error-key' : ''}" onclick="App.handleCardClick(this, '${s.thumb}', '${s.url}')">
                <div class="thumbnail-container">
                    <img class="streamer-img" src="${s.thumb || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNiA5IiBmaWxsPSIjMTExIj48L3N2Zz4='}">
                    ${s.isLive ? '<div class="live-indicator">LIVE</div>' : ''}
                </div>
                <div class="name-tag">
                    <span class="streamer-name">${s.name}</span>
                    ${s.isLive ? `<div class="marquee-wrapper"><span class="stream-title-marquee">${Utils.sanitizeHTML(s.title)}</span></div>` : ''}
                </div>
                
                <div class="details-overlay">
                    <div class="overlay-header">
                        <div class="overlay-name">${s.name}</div>
                        ${s.isLive ? `<span class="live-badge">LIVE</span>` : ''}
                    </div>
                    <div class="overlay-title">${s.title}</div>
                    <div class="overlay-stats">${s.isLoading ? '...' : (s.viewers ? s.viewers.toLocaleString() + ' viewers' : 'Offline')}</div>
                    <div class="overlay-category">${s.category || ''}</div>
                    
                    <div class="overlay-actions">
                        <button class="icon-action enlarge-btn" title="Enlarge" onclick="App.enlarge(event, '${s.thumb}', '${s.url}')">üîç</button>
                        <button class="icon-action" title="Summarize" onclick="App.summarize(event, '${s.name}')">‚ú®</button>
                        <button class="icon-action" title="Favorite" onclick="App.toggleFav(event, '${s.name}')">‚≠ê</button>
                        <button class="icon-action remove" title="Remove" onclick="App.remove(event, '${s.name}', '${s.platform}')">üóëÔ∏è</button>
                    </div>
                </div>
            </div>
        `).join('');
    },

    /* --- INTERACTIONS --- */
    handleCardClick(el, thumb, url) {
        if (window.innerWidth <= 768) {
            if (this.state.activeCard && this.state.activeCard !== el) {
                this.state.activeCard.classList.remove('active');
            }
            el.classList.toggle('active');
            this.state.activeCard = el;
        } else {
            this.enlarge(null, thumb, url);
        }
    },

    enlarge(e, src, url) {
        if(e) e.stopPropagation();
        if(!src) return;
        const img = document.getElementById('enlarged-img');
        img.src = src;
        img.dataset.url = url;
        document.getElementById('image-modal').classList.add('visible');
    },

    async summarize(e, name) {
        if(e) e.stopPropagation();
        if(!this.state.geminiKey) return this.toast('API Key Missing', 'error');
        const s = this.state.data.get(name);
        if (!s || !s.isLive) return this.toast('Streamer is offline', 'warning');
        
        document.getElementById('gemini-modal').classList.add('visible');
        const res = await Gemini.ask(`Summarize this stream excitedly: ${s.name} playing ${s.category}, title: "${s.title}"`);
        document.getElementById('gemini-response').innerHTML = res;
    },

    async askAI() {
        if(!this.state.geminiKey) return this.toast('API Key Missing', 'error');
        const live = Array.from(this.state.data.values()).filter(s => s.isLive);
        if(live.length === 0) return this.toast('No one is live', 'warning');
        
        document.getElementById('gemini-modal').classList.add('visible');
        const list = live.map(s => `${s.name} (${s.category})`).join(', ');
        const res = await Gemini.ask(`Recommend one stream to watch from this list and say why: ${list}`);
        document.getElementById('gemini-response').innerHTML = res;
    },

    async remove(e, name, platform) {
        if(e) e.stopPropagation();
        const pin = prompt(`Enter PIN to remove ${name}:`);
        if(!pin) return;
        
        try {
            const res = await fetch(this.state.workerUrl, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.state.workerToken}`
                },
                body: JSON.stringify({ action: 'remove', name, platform, pin })
            });
            if(res.ok) {
                this.toast(`${name} removed`);
                this.fetchList();
            } else {
                this.toast('Remove failed', 'error');
            }
        } catch(err) { this.toast('Error connecting', 'error'); }
    },

    async addStreamer() {
        const name = document.getElementById('add-name').value;
        const platform = document.getElementById('add-platform').value;
        if(!name) return;
        
        try {
            const res = await fetch(this.state.workerUrl, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.state.workerToken}`
                },
                body: JSON.stringify({ action: 'add', name, platform })
            });
            if(res.ok) {
                this.toast(`${name} added`);
                document.getElementById('add-name').value = '';
                this.fetchList();
            } else {
                this.toast('Add failed', 'error');
            }
        } catch(err) { this.toast('Error connecting', 'error'); }
    },

    async handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            try {
                const list = JSON.parse(ev.target.result);
                const res = await fetch(this.state.workerUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.state.workerToken}` },
                    body: JSON.stringify({ action: 'bulkReplace', list })
                });
                if(res.ok) { this.toast('Imported'); this.fetchList(); }
            } catch(err) { this.toast('Import Failed', 'error'); }
        };
        reader.readAsText(file);
    },
    
    exportList() {
        const blob = new Blob([JSON.stringify(this.state.streamers)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'streamers.json'; a.click();
    },

    toast(msg, type='info') {
        this.els.toast.textContent = msg;
        this.els.toast.className = `visible ${type}`;
        setTimeout(() => this.els.toast.className = '', 3000);
    }
};

App.init();

// PWA Init
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // Minimal SW registration to satisfy installation criteria
    });
}
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    const btn = document.getElementById('install-btn');
    btn.style.display = 'inline-flex';
    btn.onclick = () => e.prompt();
});
</script>
</body>
</html>
