<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kick Monitor Ultra v4.3 Clean</title>
    <meta name="description" content="Monitor your favorite Kick streamers with real-time updates, notifications, and enhanced accessibility">
    <meta name="theme-color" content="#5cff8a">
    
    <style>
        :root {
            --bg: #111; --text: #f0f0f0; --card: #1a1a1a; --border: #404040;
            --accent: #4ade80; --live-glow: #4ade80; --toast-bg: #222;
            --toast-text: #fff; --skeleton-bg: #2a2a2a; --error: #ef4444;
            --success: #10b981; --warning: #f59e0b; --info: #3b82f6;
            --panel-bg: #1a1a1a; --panel-border: #333;
            --modal-bg: rgba(26, 26, 26, 0.8);
        }
        [data-theme="light"] {
            --bg: #f8fafc; --text: #1a1a1a; --card: #fff; --border: #e2e8f0;
            --accent: #059669; --live-glow: #059669; --toast-bg: #eee;
            --toast-text: #000; --skeleton-bg: #e2e2e2; --error: #dc2626;
            --success: #059669; --warning: #d97706; --info: #2563eb;
            --panel-bg: #f1f5f9; --panel-border: #cbd5e1;
            --modal-bg: rgba(241, 245, 249, 0.8);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 0 20px 20px 20px;
            transition: background 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            line-height: 1.6;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        #app-container { 
            max-width: 1600px; 
            margin: 0 auto; 
        }
        
        #main-content {
            padding: 20px 0;
        }
        
        .app-footer {
            margin-top: 40px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }
        
        /* Clean header design */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .app-title {
            margin: 0;
            color: var(--accent);
            font-size: 1.8em;
            font-weight: 700;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .settings-toggle {
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-toggle:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.error {
            background-color: var(--error);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Collapsible settings panel */
        .settings-panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 12px;
            margin-bottom: 24px;
            overflow: hidden;
            transition: all 0.3s ease;
            max-height: 0;
            opacity: 0;
        }
        
        .settings-panel.expanded {
            max-height: 1500px; /* Increased max-height for groups */
            opacity: 1;
        }
        
        .settings-content {
            padding: 24px;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .setting-group label {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text);
            margin-bottom: 4px;
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .range-input {
            flex: 1;
        }
        
        .range-display {
            font-size: 0.85em;
            color: var(--accent);
            min-width: 80px;
            text-align: center;
            font-weight: 600;
        }
        
        input, select, button {
            background-color: var(--card);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        
        input[type="range"] {
            padding: 0;
            height: 6px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(76, 222, 128, 0.1);
        }
        
        button { 
            cursor: pointer; 
            background-color: var(--accent); 
            color: var(--bg); 
            font-weight: 600; 
            transition: all 0.2s; 
            border: none;
        }
        
        button:hover:not(:disabled) { 
            opacity: 0.9; 
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary {
            background-color: var(--card);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        .view-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .view-toggle {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
        }
        
        .view-toggle.active {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }
        
        .view-toggle:hover:not(.active) {
            background: var(--border);
        }
        
        .bulk-actions {
            display: none;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            gap: 12px;
            align-items: center;
        }
        
        .bulk-actions.visible {
            display: flex;
        }
        
        .selection-count {
            font-size: 14px;
            color: var(--accent);
            font-weight: 600;
        }
        
        /* Improved streamers grid */
        #streamers {
            display: grid;
            gap: 12px;
        }
        
        #streamers.grid-view {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
        
        #streamers.list-view, #streamers.compact-view {
            grid-template-columns: 1fr;
        }
        
        .streamer {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            transition: all 0.2s ease;
            position: relative;
            contain: layout style paint;
        }

        /* Go-Live Animation */
        @keyframes go-live-pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 222, 128, 0); }
        }
        .newly-live {
            animation: go-live-pulse 2s ease-out;
            border-color: var(--accent);
        }
        
        .streamer.list-view, .streamer.compact-view {
            flex-direction: row;
            align-items: center;
            gap: 16px;
            padding: 10px 12px;
        }
        
        .streamer.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(76, 222, 128, 0.2);
        }
        
        .streamer:hover:not(.selected) { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .streamer.list-view:hover, .streamer.compact-view:hover {
            transform: none;
            background-color: var(--panel-bg);
        }
        
        .streamer:focus-within {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        .streamer.live {
            border-color: var(--accent);
        }
        
        .streamer.favorite { 
            border-left: 4px solid gold; 
        }
        
        .streamer-checkbox {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 2px;
        }
        
        [data-theme="dark"] .streamer-checkbox {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .streamer.list-view .streamer-checkbox, .streamer.compact-view .streamer-checkbox {
            position: static;
            margin-right: 12px;
            background: transparent;
            padding: 0;
        }
        
        .streamer-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            gap: 12px;
        }
        
        .streamer.list-view .streamer-header, .streamer.compact-view .streamer-header {
            flex: 1;
            min-width: 150px;
            gap: 8px;
            align-items: center;
        }

        .streamer-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--border);
            flex-shrink: 0;
        }
        
        .streamer-name {
            font-weight: 600;
            color: var(--accent);
            text-decoration: none;
            font-size: 14px;
            line-height: 1.2;
        }
        
        .streamer.list-view .streamer-name, .streamer.compact-view .streamer-name {
            font-size: 1.1em;
        }
        
        .streamer-name:hover {
            opacity: 0.8;
        }
        
        .streamer-name:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            border-radius: 4px;
        }
        
        .streamer-status { 
            font-weight: 700; 
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--panel-bg);
        }
        
        .live .streamer-status { 
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .offline .streamer-status {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
        }
        
        .live .status-dot {
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        .streamer-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-height: 20px;
        }
        
        .streamer.list-view .streamer-info, .streamer.compact-view .streamer-info {
            flex: 2;
            min-height: auto;
        }
        
        .stream-title {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }     
        .streamer.list-view .stream-title {
            -webkit-line-clamp: 1;
            font-size: 0.95em;
        }
        
        .stream-category {
            font-size: 0.8em;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }
        
        .stream-meta {
            display: flex;
            gap: 12px;
            font-size: 0.75em;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .uptime, .offline-time {
            color: var(--info);
            font-weight: 500;
        }
        
        .offline-time {
            color: var(--warning);
        }
        
        .thumbnail-container {
            position: relative;
            margin-top: 4px;
        }
        
        .streamer.list-view .thumbnail-container {
            width: 140px;
            flex-shrink: 0;
            margin-top: 0;
        }
        
        .thumbnail-preview {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.2s ease;
            background-color: var(--skeleton-bg);
        }

        .thumbnail-preview.placeholder {
            object-fit: contain;
            padding: 10%;
        }
        
        .thumbnail-container a:hover .thumbnail-preview {
            opacity: 0.8;
        }
        
        .thumbnail-preview.loading {
            border: 1px solid var(--border);
            transition: opacity 0.3s;
        }
        
        .streamer.list-view .thumbnail-preview {
            width: 140px;
            height: 79px;
        }
        
        .thumbnail-preview:hover {
            opacity: 0.9;
        }
        
        .viewer-overlay {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 700;
        }
        
        .streamer-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            z-index: 5; /* Ensure buttons are on top */
        }

        /* Position buttons over the card and hide them by default in Grid View */
        .streamer.grid-view .streamer-actions {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(26, 26, 26, 0.7); /* Semi-transparent background for visibility */
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            padding: 4px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            transform: translateY(5px); /* Start slightly lower for a subtle entrance animation */
        }

        /* Fade and slide in the buttons on hover or keyboard focus */
        .streamer.grid-view:hover .streamer-actions,
        .streamer.grid-view:focus-within .streamer-actions {
            opacity: 1;
            transform: translateY(0);
        }

        .streamer.list-view .streamer-actions, .streamer.compact-view .streamer-actions {
            margin-top: 0;
            flex-shrink: 0;
            justify-content: flex-end;
        }
        
        .action-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: var(--text); 
            font-size: 14px; 
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
            min-width: 24px;
            min-height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .streamer.list-view .action-btn, .streamer.compact-view .action-btn {
            font-size: 14px;
            min-width: 24px;
            min-height: 24px;
            padding: 4px;
        }
        
        .action-btn:hover {
            background-color: var(--panel-bg);
            transform: scale(1.1);
        }
        
        .action-btn:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        .action-btn.remove { 
            color: var(--error); 
        }
        
        .action-btn.favorite { 
            font-size: 16px; 
        }
        
        .streamer.list-view .action-btn.favorite, .streamer.compact-view .action-btn.favorite {
            font-size: 20px;
        }
        
        .action-btn.favorite.active {
            color: gold;
        }

        /* Compact View Styles */
        .streamer.compact-view {
            padding: 6px 12px;
            gap: 12px;
        }
        .streamer.compact-view .thumbnail-container,
        .streamer.compact-view .streamer-info,
        .streamer.compact-view .streamer-header .streamer-status .status-dot {
            display: none;
        }
        .streamer.compact-view .streamer-header {
            justify-content: flex-start;
        }
        .streamer.compact-view .streamer-status {
            background: none;
            padding: 0;
            margin-left: auto; /* Push to the right */
        }
        .streamer.compact-view .streamer-actions {
            margin-left: 16px;
        }
        
        .stats-panel, .groups-panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .stats-panel h3, .groups-panel h3 {
            margin: 0 0 16px 0;
            font-size: 1.2em;
            color: var(--accent);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
        }
        
        .stat {
            text-align: center;
            padding: 12px;
            background: var(--card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .stat-value {
            display: block;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-label {
            display: block;
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 4px;
            font-weight: 500;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--border);
        }
        
        .empty-state h3 {
            margin: 0 0 16px 0;
            color: var(--text);
            font-size: 1.3em;
        }
        
        .empty-state button {
            margin-top: 20px;
            max-width: 200px;
        }
        
        .error-boundary {
            background-color: var(--card);
            border: 2px solid var(--error);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            margin: 24px 0;
        }
        
        .error-boundary h3 {
            color: var(--error);
            margin: 0 0 16px 0;
        }
        
        #toast {
            visibility: hidden;
            background-color: var(--toast-bg);
            color: var(--toast-text);
            text-align: center;
            border-radius: 12px;
            padding: 16px 24px;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3001; /* Above all modals */
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 400px;
            border: 1px solid var(--border);
        }
        
        #toast.success {
            background-color: var(--success);
            color: white;
        }
        
        #toast.error {
            background-color: var(--error);
            color: white;
        }
        
        #toast.warning {
            background-color: var(--warning);
            color: white;
        }
        
        #toast.info {
            background-color: var(--info);
            color: white;
        }
        
        .skeleton { 
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
        }
        
        .skeleton-card { 
            background-color: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 20px; 
        }
        
        .skeleton-line { 
            height: 20px; 
            background-color: var(--skeleton-bg); 
            border-radius: 6px; 
            margin-bottom: 12px; 
        }
        
        .skeleton-thumb { 
            width: 100%; 
            aspect-ratio: 16 / 9; 
            background-color: var(--skeleton-bg); 
            border-radius: 8px; 
        }
        
        /* Modal Styles (General) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--panel-bg);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 90vw;
            max-height: 90vh;
            width: 400px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text);
            padding: 4px;
            line-height: 1;
        }

        /* Thumbnail Modal Styles */
        #thumbnail-modal .modal-content {
            background: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
            width: auto;
        }

        .enlarged-thumbnail {
            display: block;
            max-width: 100%;
            max-height: 85vh;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            border: 2px solid var(--border);
        }

        .enlarged-thumbnail:hover {
            transform: scale(1.02);
        }

        /* Group Management Styles */
        .groups-panel {
            border-top: 1px solid var(--border);
            margin-top: 24px;
            padding-top: 24px;
        }
        #groups-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .group-item-actions button {
            padding: 4px;
            font-size: 12px;
            min-width: 20px;
            background: none;
            color: var(--text);
        }
        #assign-group-modal .modal-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        #assign-group-modal-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .assign-group-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .assign-group-item input {
            width: auto;
        }

        /* Multi-stream Modal Styles */
        #multistream-modal {
            background: #000;
        }
        #multistream-grid {
            width: 100%;
            height: 100%;
            display: grid;
            gap: 4px;
            padding: 4px;
        }
        #multistream-grid iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #multistream-modal .modal-close {
            color: #fff;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            top: 12px;
            right: 12px;
        }


        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .view-controls {
                justify-content: center;
            }
            
            /* START: Mobile Grid Styles */
            #streamers.grid-view {
                /* Create a ~2-column grid on phones by setting a larger minimum card size */
                grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
                gap: 12px;
            }

            #streamers.grid-view .streamer {
                padding: 8px;
                gap: 6px;
            }
            
            #streamers.grid-view .thumbnail-container {
                margin-top: 4px;
            }

            #streamers.grid-view .streamer-header {
                flex-direction: row;
                gap: 4px;
            }
            
            #streamers.grid-view .streamer-avatar {
                display: none; /* Hide avatar on small grid cards to save space */
            }

            #streamers.grid-view .streamer-name {
                font-size: 14px;
                line-height: 1.3;
            }

            /* Hide title and meta, but show the category now that there's space */
            #streamers.grid-view .stream-title,
            #streamers.grid-view .stream-meta {
                display: none;
            }
            
            #streamers.grid-view .stream-category {
                display: flex;
                font-size: 12px;
            }
            
            #streamers.grid-view .streamer-status {
                font-size: 11px;
                padding: 2px 5px;
            }

            /* Remove absolute positioning for mobile, return buttons to the document flow */
            #streamers.grid-view .streamer-actions {
                opacity: 1;
                transform: none;
                position: static;
                background: transparent;
                backdrop-filter: none;
                padding: 0;
                margin-top: 4px;
                gap: 4px;
            }

            #streamers.grid-view .action-btn {
                padding: 4px;
                font-size: 16px;
                min-width: 24px;
                min-height: 24px;
            }
            #streamers.grid-view .action-btn.favorite {
                font-size: 18px;
            }
             /* END: Mobile Grid Styles */
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .streamer.list-view {
                flex-direction: column;
                align-items: stretch;
            }
            
            .streamer.list-view .thumbnail-container {
                width: 100%;
            }
            
            .streamer.list-view .thumbnail-preview {
                width: 100%;
                height: auto;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .streamer:hover {
                transform: none;
            }
            
            .action-btn:hover {
                transform: none;
            }
            
            button:hover:not(:disabled) {
                transform: none;
            }
        }
        
        /* Focus improvements */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--accent);
            color: var(--bg);
            padding: 8px;
            text-decoration: none;
            border-radius: 8px;
            z-index: 1001;
        }
        
        .skip-link:focus {
            top: 6px;
        }
    </style>
</head>
<body data-theme="dark">
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div id="app-container">
        <main id="main-content">
            <div id="streamers" class="grid-view" role="grid" aria-label="Streamer monitoring dashboard" 
                 aria-describedby="streamers-help"></div>
            <div id="streamers-help" class="sr-only">
                Grid of streamer cards showing live status, viewer count, and stream information
            </div>
        </main>

        <footer class="app-footer">
            <header class="app-header">
                <h1 class="app-title">Kick Monitor Ultra <small>v4.3 Clean</small></h1>
                <div class="header-controls">
                    <div class="status-indicator" id="connection-status" aria-label="Connection status"></div>
                    <div id="last-updated" aria-live="polite"></div>
                    <button class="settings-toggle" id="settings-toggle" aria-expanded="false">
                        ⚙️ Settings
                    </button>
                </div>
            </header>

            <div class="settings-panel" id="settings-panel">
                <div class="settings-content">
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label for="search-input">Search / Filter</label>
                            <input type="text" id="search-input" placeholder="Name, category, title..." 
                                   aria-describedby="search-help">
                            <div id="search-help" class="sr-only">Search by streamer name, category, or stream title</div>
                        </div>
                        <div class="setting-group">
                            <label for="filter-select">View</label>
                            <select id="filter-select" aria-describedby="filter-help">
                                </select>
                            <div id="filter-help" class="sr-only">Filter streamers by status</div>
                        </div>
                        <div class="setting-group">
                            <label for="sort-select">Sort By</label>
                            <select id="sort-select" aria-describedby="sort-help">
                                <option value="status">Live Status</option>
                                <option value="viewers">Viewer Count</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="category">Category</option>
                                <option value="uptime">Stream Duration</option>
                            </select>
                            <div id="sort-help" class="sr-only">Sort streamers by different criteria</div>
                        </div>
                        <div class="setting-group">
                            <label for="viewer-range">Viewer Count Range</label>
                            <div class="range-container">
                                <input type="range" id="viewer-min" class="range-input" min="0" max="10000" step="100" value="0">
                                <span class="range-display" id="viewer-range-display">0 - ∞</span>
                                <input type="range" id="viewer-max" class="range-input" min="0" max="50000" step="500" value="50000">
                            </div>
                        </div>
                        <div class="setting-group" id="auto-refresh-setting-group">
                            <label for="auto-refresh-select">Auto Refresh (Offline)</label>
                            <select id="auto-refresh-select" aria-describedby="refresh-help">
                                <option value="0">Off</option>
                                <option value="120000">2 minutes</option>
                                <option value="300000">5 minutes</option>
                                <option value="600000" selected>10 minutes</option>
                                <option value="900000">15 minutes</option>
                            </select>
                            <div id="refresh-help" class="sr-only">Live streamers refresh every 2 mins.</div>
                        </div>
                        <div class="setting-group">
                            <label for="add-input">Add Streamer</label>
                            <input type="text" id="add-input" placeholder="Enter streamer name"
                                   aria-describedby="add-help">
                            <div id="add-help" class="sr-only">Add a new streamer to monitor</div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button id="add-btn" aria-describedby="add-help">➕ Add</button>
                        <button id="refresh-btn">🔄 Refresh</button>
                        <button id="theme-toggle-btn">🌗 Toggle Theme</button>
                        <button id="export-btn">📤 Export</button>
                        <button onclick="document.getElementById('import-file').click()">📥 Import</button>
                        <input type="file" id="import-file" accept="application/json" style="display:none" 
                               aria-label="Import streamer list">
                    </div>
                    
                    <div class="groups-panel">
                        <h3>Manage Groups</h3>
                        <div class="setting-group">
                            <input type="text" id="new-group-input" placeholder="New group name...">
                            <button id="add-group-btn">Create Group</button>
                        </div>
                        <div id="groups-list"></div>
                    </div>
                </div>
            </div>

            <div class="view-controls">
                <button class="view-toggle active" data-view="grid" aria-label="Grid view">📱 Grid</button>
                <button class="view-toggle" data-view="list" aria-label="List view">📋 List</button>
                <button class="view-toggle" data-view="compact" aria-label="Compact view">📄 Compact</button>
                <button id="select-mode-btn" class="view-toggle" aria-label="Selection mode">☑️ Select</button>
            </div>

            <div class="bulk-actions" id="bulk-actions">
                <span class="selection-count" id="selection-count">0 selected</span>
                <button id="bulk-watch-btn" class="secondary" disabled>📺 Watch Selected</button>
                <button id="bulk-assign-group" class="secondary">📂 Assign Group</button>
                <button id="bulk-favorite" class="secondary">⭐ Favorite</button>
                <button id="bulk-unfavorite" class="secondary">☆ Unfavorite</button>
                <button id="select-all">Select All</button>
                <button id="clear-selection">Clear</button>
            </div>

            <div id="stats-container"></div>
        </footer>
    </div>
    
    <div id="toast" role="alert" aria-live="assertive"></div>
    <div id="status-announcements" aria-live="polite" aria-atomic="true" class="sr-only"></div>

    <div id="thumbnail-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="thumbnail-modal-close" class="modal-close" title="Close (Esc)" aria-label="Close enlarged view">&times;</button>
            <img id="enlarged-thumbnail" class="enlarged-thumbnail" src="" alt="Enlarged stream thumbnail">
        </div>
    </div>
    
    <div id="assign-group-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="assign-group-modal-close" class="modal-close" title="Close (Esc)" aria-label="Close group assignment">&times;</button>
            <h3>Assign to Groups</h3>
            <div id="assign-group-modal-list"></div>
            <button id="assign-group-save-btn">Save</button>
        </div>
    </div>

    <div id="multistream-modal" class="modal-overlay">
        <button id="multistream-modal-close" class="modal-close" title="Close (Esc)" aria-label="Close multistream view">&times;</button>
        <div id="multistream-grid"></div>
    </div>


<script>
// Enhanced Kick Monitor Ultra v4.3 Clean
// Features: Smarter Polling, Custom Groups, Go-Live Animations, Avatars, Compact View, Multistream

// Utility functions
const Utils = {
    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },
    
    throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    },
    
    formatNumber(num) {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    },
    
    formatDuration(minutes) {
        if (minutes < 60) {
            return `${minutes}m`;
        }
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        if (hours < 24) {
            return `${hours}h ${mins}m`;
        }
        const days = Math.floor(hours / 24);
        const remainingHours = hours % 24;
        return `${days}d ${remainingHours}h`;
    },
    
    sanitizeHTML(str) {
        const temp = document.createElement('div');
        temp.textContent = str;
        return temp.innerHTML;
    },
    
    calculateUptime(startTime) {
        if (!startTime) return 0;
        const now = new Date();
        const start = new Date(startTime);
        return Math.floor((now - start) / (1000 * 60)); // minutes
    },
    
    calculateOfflineTime(lastSeenTime) {
        if (!lastSeenTime) return 0;
        const now = new Date();
        const lastSeen = new Date(lastSeenTime);
        return Math.floor((now - lastSeen) / (1000 * 60)); // minutes
    }
};

// Enhanced cache system
class CacheManager {
    constructor(defaultTTL = 60000) {
        this.cache = new Map();
        this.defaultTTL = defaultTTL;
    }
    
    set(key, data, ttl = this.defaultTTL) {
        this.cache.set(key, {
            data,
            timestamp: Date.now(),
            ttl
        });
    }
    
    get(key) {
        const item = this.cache.get(key);
        if (!item) return null;
        
        if (Date.now() - item.timestamp > item.ttl) {
            this.cache.delete(key);
            return null;
        }
        
        return item.data;
    }
    
    clear() {
        this.cache.clear();
    }
    
    cleanup() {
        const now = Date.now();
        for (const [key, item] of this.cache.entries()) {
            if (now - item.timestamp > item.ttl) {
                this.cache.delete(key);
            }
        }
    }
}

// Enhanced statistics tracking
class StatsManager {
    constructor() {
        this.history = JSON.parse(localStorage.getItem('stream-history') || '{}');
        this.offlineTracking = JSON.parse(localStorage.getItem('offline-tracking') || '{}');
        this.startCleanupTimer();
    }
    
    recordSnapshot(streamers) {
        const timestamp = Date.now();
        const liveStreamers = streamers.filter(s => s.isLive);
        const totalViewers = liveStreamers.reduce((sum, s) => sum + (s.viewers || 0), 0);
        
        // Track offline times
        streamers.forEach(s => {
            if (!s.isLive) {
                if (!this.offlineTracking[s.name]) {
                    this.offlineTracking[s.name] = timestamp;
                }
            } else {
                // Remove from offline tracking when they go live
                delete this.offlineTracking[s.name];
            }
        });
        
        const snapshot = {
            timestamp,
            totalStreamers: streamers.length,
            liveStreamers: liveStreamers.length,
            totalViewers,
            categories: this.getCategoryDistribution(liveStreamers),
            topStreamer: this.getTopStreamer(liveStreamers)
        };
        
        this.history[timestamp] = snapshot;
        this.cleanup();
        localStorage.setItem('stream-history', JSON.stringify(this.history));
        localStorage.setItem('offline-tracking', JSON.stringify(this.offlineTracking));
    }
    
    getOfflineTime(streamerName) {
        const offlineStart = this.offlineTracking[streamerName];
        if (!offlineStart) return 0;
        return Math.floor((Date.now() - offlineStart) / (1000 * 60)); // minutes
    }
    
    getCategoryDistribution(streamers) {
        const distribution = {};
        streamers.forEach(s => {
            if (s.category) {
                distribution[s.category] = (distribution[s.category] || 0) + 1;
            }
        });
        return distribution;
    }
    
    getTopStreamer(streamers) {
        if (streamers.length === 0) return null;
        return streamers.reduce((top, current) => 
            (current.viewers || 0) > (top.viewers || 0) ? current : top
        );
    }
    
    getStats() {
        const snapshots = Object.values(this.history);
        if (snapshots.length === 0) return null;
        
        const latest = snapshots[snapshots.length - 1];
        const hourAgo = Date.now() - 3600000;
        const recentSnapshots = snapshots.filter(s => s.timestamp > hourAgo);
        
        return {
            current: latest,
            peakViewers: Math.max(...snapshots.map(s => s.totalViewers)),
            averageLive: recentSnapshots.length > 0 ? 
                Math.round(recentSnapshots.reduce((sum, s) => sum + s.liveStreamers, 0) / recentSnapshots.length) : 0,
            topCategory: this.getTopCategory(latest.categories)
        };
    }
    
    getTopCategory(categories) {
        if (!categories || Object.keys(categories).length === 0) return null;
        return Object.entries(categories).reduce((a, b) => a[1] > b[1] ? a : b)[0];
    }
    
    cleanup() {
        const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
        this.history = Object.fromEntries(
            Object.entries(this.history).filter(([ts]) => parseInt(ts) > dayAgo)
        );
        
        // Clean up offline tracking older than 7 days
        const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
        this.offlineTracking = Object.fromEntries(
            Object.entries(this.offlineTracking).filter(([name, ts]) => ts > weekAgo)
        );
    }
    
    startCleanupTimer() {
        setInterval(() => this.cleanup(), 3600000); // Cleanup every hour
    }
}

// Main Application
const App = {
    // Application State
    state: {
        streamers: [],
        streamerData: new Map(),
        favorites: [],
        groups: {},
        isLoading: true,
        filter: 'all',
        sort: 'status',
        searchQuery: '',
        lastLiveStates: {},
        slowPollInterval: null,
        fastPollInterval: null,
        slowPollDelay: 600000,
        fastPollDelay: 120000,
        connectionStatus: 'connected',
        viewMode: 'grid',
        selectionMode: false,
        selectedStreamers: new Set(),
        viewerRange: { min: 0, max: 50000 },
        settingsExpanded: false,
        lastFocusedElement: null,
        apiEndpoint: 'https://gist.githubusercontent.com/Rapahannock/9d6241637b3be456f610b3aa415d8b4f/raw/streamers1455.json',
        workerEndpoint: 'https://autumn-base-826c.rapahannock.workers.dev/',
    },

    // Constants
    PLACEHOLDER_THUMBNAIL: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 9' fill='%23404040'%3E%3Cpath d='M14 0H2C.9 0 0 .9 0 2v5c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V2c0-1.1-.9-2-2-2zm-1.5 5.5l-2.5-3-3.5 4.5-1.5-2-3.5 4.5h11l-1-1z'/%3E%3C/svg%3E",

    // Enhanced components
    cache: new CacheManager(60000),
    stats: new StatsManager(),
    elements: {},

    // Initialization
    init() {
        this.cacheElements();
        this.loadSettings();
        this.renderGroupsList();
        this.populateFilterDropdown();
        this.registerEventListeners();
        this.setupKeyboardNavigation();
        this.requestNotificationPermission();
        this.startPeriodicCleanup();
        
        this.fetchStreamerList();
    },

    cacheElements() {
        this.elements = {
            container: document.getElementById('streamers'),
            searchInput: document.getElementById('search-input'),
            filterSelect: document.getElementById('filter-select'),
            sortSelect: document.getElementById('sort-select'),
            autoRefreshSelect: document.getElementById('auto-refresh-select'),
            viewerMin: document.getElementById('viewer-min'),
            viewerMax: document.getElementById('viewer-max'),
            viewerRangeDisplay: document.getElementById('viewer-range-display'),
            addInput: document.getElementById('add-input'),
            addBtn: document.getElementById('add-btn'),
            refreshBtn: document.getElementById('refresh-btn'),
            themeBtn: document.getElementById('theme-toggle-btn'),
            exportBtn: document.getElementById('export-btn'),
            importFile: document.getElementById('import-file'),
            lastUpdated: document.getElementById('last-updated'),
            toast: document.getElementById('toast'),
            statsContainer: document.getElementById('stats-container'),
            statusIndicator: document.getElementById('connection-status'),
            announcements: document.getElementById('status-announcements'),
            selectModeBtn: document.getElementById('select-mode-btn'),
            bulkActions: document.getElementById('bulk-actions'),
            selectionCount: document.getElementById('selection-count'),
            bulkFavorite: document.getElementById('bulk-favorite'),
            bulkUnfavorite: document.getElementById('bulk-unfavorite'),
            bulkAssignGroup: document.getElementById('bulk-assign-group'),
            bulkWatchBtn: document.getElementById('bulk-watch-btn'),
            selectAll: document.getElementById('select-all'),
            clearSelection: document.getElementById('clear-selection'),
            settingsToggle: document.getElementById('settings-toggle'),
            settingsPanel: document.getElementById('settings-panel'),
            // Thumbnail Modal
            thumbnailModal: document.getElementById('thumbnail-modal'),
            enlargedThumbnail: document.getElementById('enlarged-thumbnail'),
            modalCloseBtn: document.getElementById('thumbnail-modal-close'),
            // Group Management
            newGroupInput: document.getElementById('new-group-input'),
            addGroupBtn: document.getElementById('add-group-btn'),
            groupsList: document.getElementById('groups-list'),
            // Assign Group Modal
            assignGroupModal: document.getElementById('assign-group-modal'),
            assignGroupModalList: document.getElementById('assign-group-modal-list'),
            assignGroupModalCloseBtn: document.getElementById('assign-group-modal-close'),
            assignGroupSaveBtn: document.getElementById('assign-group-save-btn'),
            // Multistream Modal
            multistreamModal: document.getElementById('multistream-modal'),
            multistreamGrid: document.getElementById('multistream-grid'),
            multistreamModalCloseBtn: document.getElementById('multistream-modal-close'),
        };
    },

    loadSettings() {
        const theme = localStorage.getItem("theme") || 
            (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        document.body.setAttribute("data-theme", theme);

        this.state.favorites = JSON.parse(localStorage.getItem("favorites") || "[]");
        this.state.groups = JSON.parse(localStorage.getItem("groups") || "{}");
        this.state.filter = localStorage.getItem("filter") || 'all';
        this.state.sort = localStorage.getItem("sort") || 'status';
        this.state.slowPollDelay = parseInt(localStorage.getItem("slowPollDelay") || "600000");
        this.state.viewMode = localStorage.getItem("viewMode") || 'grid';
        this.state.viewerRange = JSON.parse(localStorage.getItem("viewerRange") || '{"min":0,"max":50000}');
        this.state.settingsExpanded = JSON.parse(localStorage.getItem("settingsExpanded") || 'false');

        this.elements.filterSelect.value = this.state.filter;
        this.elements.sortSelect.value = this.state.sort;
        this.elements.autoRefreshSelect.value = this.state.slowPollDelay;
        this.elements.viewerMin.value = this.state.viewerRange.min;
        this.elements.viewerMax.value = this.state.viewerRange.max;
        
        this.updateViewMode(this.state.viewMode);
        this.updateViewerRangeDisplay();
        this.updateSettingsPanel(); // This call is now safe
        this.startAutoRefresh(this.state.slowPollDelay);
    },

    registerEventListeners() {
        // Settings toggle
        this.elements.settingsToggle.addEventListener('click', () => this.toggleSettings());
        
        // Debounced search
        this.elements.searchInput.addEventListener('input', Utils.debounce(e => {
            this.state.searchQuery = e.target.value.toLowerCase();
            this.render();
        }, 300));
        
        this.elements.filterSelect.addEventListener('change', e => {
            this.state.filter = e.target.value;
            localStorage.setItem("filter", this.state.filter);
            this.render();
        });
        
        this.elements.sortSelect.addEventListener('change', e => {
            this.state.sort = e.target.value;
            localStorage.setItem("sort", this.state.sort);
            this.render();
        });
        
        this.elements.autoRefreshSelect.addEventListener('change', e => {
            this.state.slowPollDelay = parseInt(e.target.value);
            localStorage.setItem("slowPollDelay", this.state.slowPollDelay);
            this.startAutoRefresh(this.state.slowPollDelay);
        });
        
        // Viewer range controls
        this.elements.viewerMin.addEventListener('input', Utils.throttle(() => {
            this.state.viewerRange.min = parseInt(this.elements.viewerMin.value);
            this.updateViewerRangeDisplay();
            localStorage.setItem("viewerRange", JSON.stringify(this.state.viewerRange));
            this.render();
        }, 100));
        
        this.elements.viewerMax.addEventListener('input', Utils.throttle(() => {
            this.state.viewerRange.max = parseInt(this.elements.viewerMax.value);
            this.updateViewerRangeDisplay();
            localStorage.setItem("viewerRange", JSON.stringify(this.state.viewerRange));
            this.render();
        }, 100));
        
        // View mode controls
        document.querySelectorAll('.view-toggle[data-view]').forEach(btn => {
            btn.addEventListener('click', e => this.updateViewMode(e.target.dataset.view));
        });
        
        // Selection mode
        this.elements.selectModeBtn.addEventListener('click', () => this.toggleSelectionMode());
        
        // Bulk actions
        this.elements.bulkFavorite.addEventListener('click', () => this.bulkToggleFavorite(true));
        this.elements.bulkUnfavorite.addEventListener('click', () => this.bulkToggleFavorite(false));
        this.elements.selectAll.addEventListener('click', () => this.selectAllStreamers());
        this.elements.clearSelection.addEventListener('click', () => this.clearSelection());
        this.elements.bulkWatchBtn.addEventListener('click', () => this.showMultistreamModal());
        
        // Top-level actions
        this.elements.themeBtn.addEventListener('click', () => this.toggleTheme());
        this.elements.refreshBtn.addEventListener('click', () => this.performSlowPoll());
        this.elements.addBtn.addEventListener('click', () => this.addStreamer());
        this.elements.addInput.addEventListener('keyup', e => { if (e.key === 'Enter') this.addStreamer(); });
        this.elements.exportBtn.addEventListener('click', () => this.exportList());
        this.elements.importFile.addEventListener('change', e => this.importList(e));

        // Group Management Listeners
        this.elements.addGroupBtn.addEventListener('click', () => this.createGroup());
        this.elements.newGroupInput.addEventListener('keyup', e => { if (e.key === 'Enter') this.createGroup(); });
        this.elements.groupsList.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const groupItem = e.target.closest('.group-item');
            const groupName = groupItem.dataset.groupName;
            if (button.classList.contains('delete-group-btn')) this.deleteGroup(groupName);
        });
        this.elements.bulkAssignGroup.addEventListener('click', () => this.showGroupModal(Array.from(this.state.selectedStreamers)));

        // Assign Group Modal Listeners
        this.elements.assignGroupModalCloseBtn.addEventListener('click', () => this.hideGroupModal());
        this.elements.assignGroupModal.addEventListener('click', e => { if(e.target === this.elements.assignGroupModal) this.hideGroupModal(); });

        // Multistream Modal Listeners
        this.elements.multistreamModalCloseBtn.addEventListener('click', () => this.hideMultistreamModal());

        // Event Delegation for Card Clicks
        this.elements.container.addEventListener('click', e => {
            const checkbox = e.target.closest('.streamer-checkbox');
            if (checkbox) {
                const streamerName = checkbox.closest('[data-streamer-name]').dataset.streamerName;
                this.toggleSelection(streamerName); return;
            }

            const button = e.target.closest('.action-btn');
            if (button) {
                const streamerName = button.closest('[data-streamer-name]').dataset.streamerName;
                if (button.classList.contains('favorite')) this.toggleFavorite(streamerName);
                else if (button.classList.contains('remove')) this.removeStreamer(streamerName);
                else if (button.classList.contains('assign-group')) {
                    e.preventDefault();
                    this.showGroupModal([streamerName]);
                }
                return;
            }

            const thumbnail = e.target.closest('.thumbnail-preview');
            if (thumbnail) {
                e.preventDefault();
                const link = thumbnail.closest('a');
                if (link && link.href) this.showEnlargedThumbnail(thumbnail.src, link.href);
                return;
            }
        });

        // Thumbnail Modal Listeners
        this.elements.modalCloseBtn.addEventListener('click', () => this.hideEnlargedThumbnail());
        this.elements.thumbnailModal.addEventListener('click', e => { if (e.target === this.elements.thumbnailModal) this.hideEnlargedThumbnail(); });
        this.elements.enlargedThumbnail.addEventListener('click', e => {
            const url = e.target.dataset.kickUrl;
            if (url) {
                window.open(url, '_blank', 'noopener,noreferrer');
                this.hideEnlargedThumbnail();
            }
        });
        
        window.addEventListener('beforeunload', () => this.stopAutoRefresh());
    },
    
    setupKeyboardNavigation() {
        document.addEventListener('keydown', e => {
            const isModalOpen = this.elements.thumbnailModal.style.display === 'flex' 
                || this.elements.assignGroupModal.style.display === 'flex'
                || this.elements.multistreamModal.style.display === 'flex';
                
            if (e.target.matches('input, select, button, textarea') && e.key !== 'Escape') return;

            switch(e.key.toLowerCase()) {
                case 'r':
                    if (!e.ctrlKey && !e.metaKey && !isModalOpen) { e.preventDefault(); this.performSlowPoll(); }
                    break;
                case 'f':
                    if (!e.ctrlKey && !e.metaKey && !isModalOpen) { e.preventDefault(); this.elements.searchInput.focus(); }
                    break;
                case 'escape':
                    if (this.elements.multistreamModal.style.display === 'flex') this.hideMultistreamModal();
                    else if (this.elements.assignGroupModal.style.display === 'flex') this.hideGroupModal();
                    else if (this.elements.thumbnailModal.style.display === 'flex') this.hideEnlargedThumbnail();
                    else if (this.state.selectionMode) this.toggleSelectionMode();
                    else if (this.state.settingsExpanded) this.toggleSettings();
                    else this.elements.searchInput.blur();
                    break;
            }
        });
    },
    
    requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission();
    },
    
    startPeriodicCleanup() {
        setInterval(() => this.cache.cleanup(), 300000);
    },

    showModal(modalElement) {
        this.state.lastFocusedElement = document.activeElement;
        modalElement.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    },

    hideModal(modalElement) {
        modalElement.style.display = 'none';
        document.body.style.overflow = '';
        if (this.state.lastFocusedElement) this.state.lastFocusedElement.focus();
    },

    showEnlargedThumbnail(imageUrl, kickUrl) {
        this.showModal(this.elements.thumbnailModal);
        this.elements.enlargedThumbnail.src = imageUrl;
        this.elements.enlargedThumbnail.dataset.kickUrl = kickUrl;
        setTimeout(() => this.elements.modalCloseBtn.focus(), 100);
    },

    hideEnlargedThumbnail() {
        this.hideModal(this.elements.thumbnailModal);
        this.elements.enlargedThumbnail.src = '';
        this.elements.enlargedThumbnail.removeAttribute('data-kick-url');
    },
    
    toggleSettings() {
        this.state.settingsExpanded = !this.state.settingsExpanded;
        localStorage.setItem("settingsExpanded", JSON.stringify(this.state.settingsExpanded));
        this.updateSettingsPanel();
    },
    
    // START: FIXED FUNCTION
    updateSettingsPanel() {
        const panel = this.elements.settingsPanel;
        const toggle = this.elements.settingsToggle;
        
        if (this.state.settingsExpanded) {
            panel.classList.add('expanded');
            toggle.setAttribute('aria-expanded', 'true');
            toggle.innerHTML = '⚙️ Hide Settings';
        } else {
            panel.classList.remove('expanded');
            toggle.setAttribute('aria-expanded', 'false');
            toggle.innerHTML = '⚙️ Settings';
        }
    },
    // END: FIXED FUNCTION
    
    async fetchStreamerList() {
        this.setLoadingState(true, 'Loading streamer list...');
        this.updateConnectionStatus('connecting');
        try {
            const res = await fetch(`${this.state.apiEndpoint}?t=${Date.now()}`);
            if (!res.ok) throw new Error(`Network response was not ok: ${res.statusText}`);
            this.state.streamers = await res.json();
            this.updateConnectionStatus('connected');
            this.performSlowPoll();
        } catch (error) {
            console.error("Failed to load streamer list:", error);
            this.updateConnectionStatus('error');
            this.showToast(`⚠️ Error fetching list: ${error.message}`, 'error');
            this.setLoadingState(false);
        }
    },

    async fetchStreamerData(streamerList) {
        const fetchPromises = streamerList.map(name => this.fetchApiWithCache(`https://kick.com/api/v1/channels/${name}`, name));
        const results = await Promise.allSettled(fetchPromises);
        let successCount = 0;
        const liveStreamers = [];

        results.forEach((result, index) => {
            const name = streamerList[index];
            if (result.status === 'fulfilled' && result.value) {
                const data = result.value;
                const isLive = data.livestream !== null;
                const wasLive = this.state.lastLiveStates[name];

                if (isLive && wasLive === false) {
                    if (this.state.favorites.includes(name)) this.notifyFavoriteStreamerLive(name, data);
                    const card = this.elements.container.querySelector(`[data-streamer-name="${name}"]`);
                    if (card) {
                        card.classList.add('newly-live');
                        setTimeout(() => card.classList.remove('newly-live'), 2000);
                    }
                }
                this.state.lastLiveStates[name] = isLive;
                
                if (isLive) liveStreamers.push(name);
                
                const uptime = isLive ? Utils.calculateUptime(data.livestream?.created_at) : 0;
                const offlineTime = !isLive ? this.stats.getOfflineTime(name) : 0;
                
                this.state.streamerData.set(name, {
                    name, isLive, uptime, offlineTime,
                    title: data.livestream?.session_title || "Offline",
                    viewers: data.livestream?.viewer_count || 0,
                    category: data.livestream?.categories?.[0]?.name || null,
                    thumbnail: data.livestream?.thumbnail?.url,
                    url: `https://kick.com/${name}`,
                    profilePic: data.user?.profile_pic,
                });
                successCount++;
            } else {
                console.warn(`Failed to fetch data for ${name}`);
                const offlineTime = this.stats.getOfflineTime(name);
                this.state.streamerData.set(name, { name, isLive: false, title: 'Unavailable', viewers: 0, category: null, url: `https://kick.com/${name}`, uptime: 0, offlineTime });
            }
        });
        return { successCount, liveStreamers };
    },

    async fetchApiWithCache(url, identifier) {
        const cacheKey = `api-${identifier}`;
        let data = this.cache.get(cacheKey);
        if (data) return data;
        return this.fetchApi(url).then(result => {
            if (result) this.cache.set(cacheKey, result);
            return result;
        });
    },

    async fetchApi(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`API responded with status ${res.status}`);
        return res.json();
    },

    render() {
        if (this.state.isLoading) return this.renderSkeletons();
        const filtered = this.getFilteredAndSortedData();
        this.renderStats();
        this.elements.container.innerHTML = '';
        if (filtered.length === 0) return this.renderEmptyState();

        const fragment = document.createDocumentFragment();
        filtered.forEach(streamer => fragment.appendChild(this.createStreamerCard(streamer)));
        this.elements.container.appendChild(fragment);
        this.elements.lastUpdated.textContent = `${new Date().toLocaleTimeString()}`;
        this.updateSelectionUI();
    },
    
    renderStats() {
        const stats = this.stats.getStats();
        if (!stats) return this.elements.statsContainer.innerHTML = '';
        this.elements.statsContainer.innerHTML = `<div class="stats-panel"><h3>📊 Live Statistics</h3><div class="stats-grid"><div class="stat"><span class="stat-value">${stats.current.liveStreamers}</span><span class="stat-label">Live Now</span></div><div class="stat"><span class="stat-value">${Utils.formatNumber(stats.current.totalViewers)}</span><span class="stat-label">Total Viewers</span></div><div class="stat"><span class="stat-value">${Utils.formatNumber(stats.peakViewers)}</span><span class="stat-label">Peak (24h)</span></div><div class="stat"><span class="stat-value">${stats.averageLive}</span><span class="stat-label">Avg Live (1h)</span></div>${stats.topCategory ? `<div class="stat"><span class="stat-value">${stats.topCategory}</span><span class="stat-label">Top Category</span></div>` : ''}</div></div>`;
    },

    getFilteredAndSortedData() {
        let data = Array.from(this.state.streamerData.values());
        // Filtering
        data = data.filter(s => {
            const searchMatch = !this.state.searchQuery || s.name.toLowerCase().includes(this.state.searchQuery) || (s.title || '').toLowerCase().includes(this.state.searchQuery) || (s.category || '').toLowerCase().includes(this.state.searchQuery);
            if (!searchMatch) return false;
            const viewers = s.viewers || 0;
            if (viewers < this.state.viewerRange.min || viewers > this.state.viewerRange.max) return false;
            if (this.state.filter.startsWith('group-')) {
                const groupName = this.state.filter.replace('group-', '');
                return this.state.groups[groupName]?.includes(s.name);
            }
            switch (this.state.filter) {
                case 'live': return s.isLive; case 'offline': return !s.isLive; case 'favorites': return this.state.favorites.includes(s.name); default: return true;
            }
        });
        // Sorting
        return data.sort((a, b) => {
            switch (this.state.sort) {
                case 'viewers': return b.viewers - a.viewers; case 'name': return a.name.localeCompare(b.name); case 'category': return (a.category || '').localeCompare(b.category || ''); case 'uptime': return b.uptime - a.uptime; case 'status': default:
                    if (a.isLive !== b.isLive) return b.isLive - a.isLive; return b.viewers - a.viewers;
            }
        });
    },

    createStreamerCard(s) {
        const div = document.createElement('div');
        const isFavorite = this.state.favorites.includes(s.name);
        const isSelected = this.state.selectedStreamers.has(s.name);
        div.className = `streamer ${s.isLive ? 'live' : 'offline'} ${isFavorite ? 'favorite' : ''} ${this.state.viewMode}-view ${isSelected ? 'selected' : ''}`;
        div.dataset.streamerName = s.name;
        const categoryIcons = {"Just Chatting": "💬", "Slots & Casino": "🎰", "Games & Casino": "🎲", "Call of Duty": "🎯", "Grand Theft Auto V": "🚗", "Sports": "🏀", "Music": "🎵", "Valorant": "🔫", "Fortnite": "🛡️", "League of Legends": "🧙‍♂️", "Minecraft": "⛏️", "IRL": "🌍", "Poker": "🃏"};
        const icon = categoryIcons[s.category] || '🎮';
        const avatarHTML = `<img class="streamer-avatar" src="${s.profilePic || ''}" alt="${s.name} avatar" onerror="this.style.display='none'">`;
        
        div.innerHTML = `
            ${this.state.selectionMode ? `<input type="checkbox" class="streamer-checkbox" ${isSelected ? 'checked' : ''} aria-label="Select ${s.name}">` : ''}
            ${s.isLive && s.thumbnail ? this.createThumbnailHTML(s) : ''}
            <div class="streamer-header">
                ${avatarHTML}
                <a href="${s.url}" target="_blank" rel="noopener noreferrer" class="streamer-name">${Utils.sanitizeHTML(s.name)}</a>
                <span class="streamer-status"><span class="status-dot"></span>${s.isLive ? `LIVE (${Utils.formatNumber(s.viewers)})` : 'OFFLINE'}</span>
            </div>
            <div class="streamer-info">
                <div class="stream-title">${s.isLive ? Utils.sanitizeHTML(s.title) : 'Currently not streaming'}</div>
                ${s.category ? `<div class="stream-category">${icon} ${Utils.sanitizeHTML(s.category)}</div>` : ''}
                <div class="stream-meta">
                    ${s.isLive && s.uptime > 0 ? `<span class="uptime">⏱️ ${Utils.formatDuration(s.uptime)}</span>` : ''}
                    ${!s.isLive && s.offlineTime > 0 ? `<span class="offline-time">💤 ${Utils.formatDuration(s.offlineTime)} offline</span>` : ''}
                </div>
            </div>
            <div class="streamer-actions">
                <button class="action-btn assign-group" title="Assign to Group">📂</button>
                <button class="action-btn favorite ${isFavorite ? 'active' : ''}" title="${isFavorite ? 'Unfavorite' : 'Favorite'}">${isFavorite ? '⭐' : '☆'}</button>
                <button class="action-btn remove" title="Remove streamer">🗑️</button>
            </div>`;
        return div;
    },
    
    createThumbnailHTML(s) { return `<div class="thumbnail-container"><a href="${s.url}" target="_blank" rel="noopener noreferrer" aria-label="View enlarged thumbnail for ${s.name}"><img class="thumbnail-preview" src="${s.thumbnail}" alt="Stream preview for ${s.name}" loading="lazy" onerror="this.src='${this.PLACEHOLDER_THUMBNAIL}'; this.classList.add('placeholder');"><div class="viewer-overlay">${Utils.formatNumber(s.viewers)}</div></a></div>`; },
    renderSkeletons() { this.elements.container.innerHTML = Array(12).fill('').map(() => `<div class="skeleton-card skeleton" aria-label="Loading streamer data"><div class="skeleton-line" style="width: 60%;"></div><div class="skeleton-line" style="width: 80%;"></div><div class="skeleton-thumb"></div></div>`).join(''); },
    renderEmptyState() {
        const { filter, searchQuery } = this.state;
        let message, action;
        if (searchQuery) { message = `No streamers found matching "${searchQuery}"`; action = '<button onclick="App.clearSearch()">Clear search</button>'; } 
        else if (filter === 'live') { message = 'No streamers are currently live'; action = '<button onclick="App.showAllStreamers()">View all streamers</button>'; } 
        else if (filter === 'favorites') { message = 'No favorite streamers yet'; action = '<p>Click the ☆ icon on any streamer to add them to favorites</p>'; } 
        else if (filter.startsWith('group-')) { message = 'This group is empty'; action = '<p>Assign streamers to this group using the 📂 icon on their card.</p>'; } 
        else { message = 'No streamers in your list'; action = '<p>Add streamers using the settings panel.</p>'; }
        this.elements.container.innerHTML = `<div class="empty-state"><h3>${message}</h3>${action}</div>`;
    },

    setLoadingState(isLoading, message = '') {
        this.state.isLoading = isLoading;
        this.elements.refreshBtn.disabled = isLoading;
        this.elements.refreshBtn.textContent = isLoading ? `🔄 ${message || 'Loading...'}` : '🔄 Refresh';
        if (!isLoading) this.render();
    },
    
    updateConnectionStatus(status) { this.elements.statusIndicator.className = `status-indicator ${status}`; },
    updateViewMode(mode) {
        this.state.viewMode = mode;
        localStorage.setItem("viewMode", mode);
        document.querySelectorAll('.view-toggle[data-view]').forEach(btn => btn.classList.toggle('active', btn.dataset.view === mode));
        this.elements.container.className = `${mode}-view`;
        this.render();
    },
    
    updateViewerRangeDisplay() {
        const { min, max } = this.state.viewerRange;
        const maxDisplay = max >= 50000 ? '∞' : Utils.formatNumber(max);
        this.elements.viewerRangeDisplay.textContent = `${Utils.formatNumber(min)} - ${maxDisplay}`;
    },

    toggleSelectionMode() {
        this.state.selectionMode = !this.state.selectionMode;
        this.state.selectedStreamers.clear();
        this.elements.selectModeBtn.classList.toggle('active', this.state.selectionMode);
        this.elements.bulkActions.classList.toggle('visible', this.state.selectionMode);
        this.render();
        this.showToast(`Selection mode ${this.state.selectionMode ? 'enabled' : 'disabled'}.`, 'info');
    },
    
    toggleSelection(streamerName) { this.state.selectedStreamers.has(streamerName) ? this.state.selectedStreamers.delete(streamerName) : this.state.selectedStreamers.add(streamerName); this.updateSelectionUI(); this.render(); },
    selectAllStreamers() { this.getFilteredAndSortedData().forEach(s => this.state.selectedStreamers.add(s.name)); this.updateSelectionUI(); this.render(); },
    clearSelection() { this.state.selectedStreamers.clear(); this.updateSelectionUI(); this.render(); },
    
    updateSelectionUI() {
        const count = this.state.selectedStreamers.size;
        this.elements.selectionCount.textContent = `${count} selected`;
        const liveSelected = Array.from(this.state.selectedStreamers).some(name => this.state.streamerData.get(name)?.isLive);
        this.elements.bulkWatchBtn.disabled = count === 0 || !liveSelected;
        this.elements.bulkFavorite.disabled = count === 0;
        this.elements.bulkUnfavorite.disabled = count === 0;
        this.elements.bulkAssignGroup.disabled = count === 0;
    },
    
    bulkToggleFavorite(addToFavorites) {
        let changedCount = 0;
        this.state.selectedStreamers.forEach(name => {
            const isFavorite = this.state.favorites.includes(name);
            if (addToFavorites && !isFavorite) { this.state.favorites.push(name); changedCount++; } 
            else if (!addToFavorites && isFavorite) { this.state.favorites = this.state.favorites.filter(f => f !== name); changedCount++; }
        });
        if (changedCount > 0) { localStorage.setItem("favorites", JSON.stringify(this.state.favorites)); this.render(); const action = addToFavorites ? 'added to' : 'removed from'; this.showToast(`⭐ ${changedCount} streamers ${action} favorites`, 'success'); }
    },

    async addStreamer() {
        const name = this.elements.addInput.value.trim().toLowerCase();
        if (!name) return this.showToast('⚠️ Please enter a streamer name.', 'warning');
        if (this.state.streamers.includes(name)) return this.showToast('⚠️ Streamer is already in the list.', 'warning');
        this.setLoadingState(true, 'Adding streamer...');
        try {
            const res = await fetch(this.state.workerEndpoint, {method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ streamer: name })});
            const msg = await res.text();
            if (!res.ok) throw new Error(msg);
            this.showToast(`✅ ${msg}`, 'success');
            this.elements.addInput.value = '';
            this.cache.clear();
            setTimeout(() => this.fetchStreamerList(), 1500);
        } catch (error) { this.showToast(`❌ Add failed: ${error.message}`, 'error'); } 
        finally { this.setLoadingState(false); }
    },

    async removeStreamer(name) {
        if (!confirm(`Are you sure you want to remove ${name}? This requires a PIN.`)) return;
        const pin = prompt("Enter PIN to remove streamer:");
        if (!pin) return this.showToast('⚠️ PIN entry cancelled.', 'warning');
        this.setLoadingState(true, 'Removing streamer...');
        try {
            const res = await fetch(this.state.workerEndpoint, {method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ remove: name, pin })});
            const msg = await res.text();
            if (!res.ok) throw new Error(msg);
            this.showToast(`🗑️ ${msg}`, 'success');
            this.cache.clear();
            setTimeout(() => this.fetchStreamerList(), 1500);
        } catch (error) { this.showToast(`❌ Remove failed: ${error.message}`, 'error'); } 
        finally { this.setLoadingState(false); }
    },

    toggleFavorite(name) {
        const favSet = new Set(this.state.favorites);
        const wasAdded = !favSet.has(name);
        wasAdded ? favSet.add(name) : favSet.delete(name);
        this.state.favorites = Array.from(favSet);
        localStorage.setItem("favorites", JSON.stringify(this.state.favorites));
        this.render();
        const message = wasAdded ? `⭐ ${name} added to favorites!` : `☆ ${name} removed from favorites.`;
        this.showToast(message, 'success');
        this.announceToScreenReader(message);
    },

    toggleTheme() {
        const newTheme = document.body.getAttribute("data-theme") === "dark" ? "light" : "dark";
        document.body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        this.showToast(`🌗 Switched to ${newTheme} theme`, 'success');
    },
    
    // Auto-refresh Smarter Polling
    startAutoRefresh(delay) {
        this.stopAutoRefresh();
        if (delay > 0) this.state.slowPollInterval = setInterval(() => this.performSlowPoll(), delay);
    },

    stopAutoRefresh() {
        if (this.state.slowPollInterval) clearInterval(this.state.slowPollInterval);
        if (this.state.fastPollInterval) clearInterval(this.state.fastPollInterval);
        this.state.slowPollInterval = null; this.state.fastPollInterval = null;
    },
    
    async performSlowPoll() {
        this.setLoadingState(true, 'Updating all streamers...');
        const { successCount, liveStreamers } = await this.fetchStreamerData(this.state.streamers);
        this.stats.recordSnapshot(Array.from(this.state.streamerData.values()));
        this.setLoadingState(false);
        this.render();
        this.announceUpdate(successCount, this.state.streamers.length);
        this.startFastPoll(liveStreamers);
    },

    startFastPoll(liveStreamers) {
        if (this.state.fastPollInterval) clearInterval(this.state.fastPollInterval);
        if (liveStreamers.length > 0) {
            this.state.fastPollInterval = setInterval(() => this.performFastPoll(liveStreamers), this.state.fastPollDelay);
        }
    },

    async performFastPoll(liveStreamers) {
        const { liveStreamers: updatedLiveStreamers } = await this.fetchStreamerData(liveStreamers);
        this.stats.recordSnapshot(Array.from(this.state.streamerData.values()));
        this.render();
        if (updatedLiveStreamers.length !== liveStreamers.length) this.startFastPoll(updatedLiveStreamers);
    },

    // Group Management Methods
    createGroup() {
        const groupName = this.elements.newGroupInput.value.trim();
        if (!groupName) return this.showToast('⚠️ Please enter a group name.', 'warning');
        if (this.state.groups[groupName]) return this.showToast('⚠️ Group already exists.', 'warning');
        this.state.groups[groupName] = [];
        this.saveGroups(); this.renderGroupsList(); this.populateFilterDropdown();
        this.elements.newGroupInput.value = '';
        this.showToast(`✅ Group "${groupName}" created.`, 'success');
    },

    deleteGroup(groupName) {
        if (!confirm(`Are you sure you want to delete the group "${groupName}"?`)) return;
        delete this.state.groups[groupName];
        this.saveGroups(); this.renderGroupsList(); this.populateFilterDropdown();
        if (this.state.filter === `group-${groupName}`) { this.state.filter = 'all'; this.elements.filterSelect.value = 'all'; this.render(); }
        this.showToast(`🗑️ Group "${groupName}" deleted.`, 'success');
    },

    renderGroupsList() {
        this.elements.groupsList.innerHTML = Object.keys(this.state.groups).sort().map(name => `<div class="group-item" data-group-name="${name}"><span>${Utils.sanitizeHTML(name)}</span><div class="group-item-actions"><button class="delete-group-btn" title="Delete Group">🗑️</button></div></div>`).join('');
    },
    
    saveGroups() { localStorage.setItem('groups', JSON.stringify(this.state.groups)); },
    populateFilterDropdown() {
        const defaultOptions = `<option value="all">All</option><option value="live">Live</option><option value="offline">Offline</option><option value="favorites">Favorites</option>`;
        const groupOptions = Object.keys(this.state.groups).sort().map(name => `<option value="group-${name}">📂 ${Utils.sanitizeHTML(name)}</option>`).join('');
        this.elements.filterSelect.innerHTML = defaultOptions + (groupOptions ? '<option disabled>-----</option>' + groupOptions : '');
        this.elements.filterSelect.value = this.state.filter;
    },

    showGroupModal(streamerNames) {
        this.showModal(this.elements.assignGroupModal);
        this.elements.assignGroupModalList.innerHTML = Object.keys(this.state.groups).sort().map(groupName => {
            const isChecked = streamerNames.length > 0 && streamerNames.every(sName => this.state.groups[groupName]?.includes(sName));
            return `<label class="assign-group-item"><input type="checkbox" data-group-name="${groupName}" ${isChecked ? 'checked' : ''}>${Utils.sanitizeHTML(groupName)}</label>`;
        }).join('');

        this.elements.assignGroupSaveBtn.onclick = () => {
            this.elements.assignGroupModalList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const groupName = checkbox.dataset.groupName;
                streamerNames.forEach(streamerName => {
                    const group = this.state.groups[groupName];
                    const streamerIndex = group.indexOf(streamerName);
                    if (checkbox.checked && streamerIndex === -1) group.push(streamerName);
                    else if (!checkbox.checked && streamerIndex !== -1) group.splice(streamerIndex, 1);
                });
            });
            this.saveGroups(); this.hideGroupModal(); this.showToast('✅ Groups updated.', 'success');
        };
        setTimeout(() => this.elements.assignGroupSaveBtn.focus(), 100);
    },

    hideGroupModal() { this.hideModal(this.elements.assignGroupModal); },

    // Multistream Methods
    showMultistreamModal() {
        const liveSelection = Array.from(this.state.selectedStreamers).filter(name => this.state.streamerData.get(name)?.isLive);
        if (liveSelection.length === 0) return this.showToast('⚠️ No live streamers selected.', 'warning');
        
        const grid = this.elements.multistreamGrid;
        grid.innerHTML = liveSelection.map(name => `<iframe src="https://player.kick.com/${name}?autoplay=true&muted=true"></iframe>`).join('');

        let cols = Math.ceil(Math.sqrt(liveSelection.length));
        let rows = Math.ceil(liveSelection.length / cols);
        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        grid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

        this.showModal(this.elements.multistreamModal);
    },

    hideMultistreamModal() {
        this.hideModal(this.elements.multistreamModal);
        this.elements.multistreamGrid.innerHTML = ''; // Stop videos from playing
    },

    // Misc Helpers
    notifyFavoriteStreamerLive(name, data) {
        if ('Notification' in window && Notification.permission === 'granted') {
            const notification = new Notification(`${name} is now live!`, { body: data.livestream?.session_title || 'Streaming now on Kick!', icon: data.user?.profile_pic, tag: `streamer-${name}` });
            notification.onclick = () => { window.open(`https://kick.com/${name}`, '_blank'); notification.close(); };
            setTimeout(() => notification.close(), 5000);
        }
        this.announceToScreenReader(`${name} is now live!`);
    },

    showToast(message, type = 'info') {
        const toast = this.elements.toast;
        toast.textContent = message; toast.className = type;
        toast.style.visibility = "visible"; toast.style.opacity = "1";
        setTimeout(() => {
            toast.style.opacity = "0";
            setTimeout(() => { toast.style.visibility = "hidden"; toast.className = ''; }, 300);
        }, 3000);
    },

    announceToScreenReader(message) {
        this.elements.announcements.textContent = message;
        setTimeout(() => { this.elements.announcements.textContent = ''; }, 1000);
    },
    
    announceUpdate(successCount, totalCount) { this.announceToScreenReader(`Updated ${successCount} of ${totalCount} streamers`); },
    clearSearch() { this.elements.searchInput.value = ''; this.state.searchQuery = ''; this.render(); this.elements.searchInput.focus(); },
    showAllStreamers() { this.elements.filterSelect.value = 'all'; this.state.filter = 'all'; localStorage.setItem("filter", this.state.filter); this.render(); }
};

// Error boundary wrapper
function withErrorBoundary(fn, context = 'Unknown') {
    return async function(...args) {
        try { return await fn.apply(this, args); } 
        catch (error) {
            console.error(`Error in ${context}:`, error);
            App.showToast(`⚠️ Error in ${context}: ${error.message}`, 'error');
            if (context.includes('Poll')) App.setLoadingState(false);
        }
    };
}

// Wrap critical methods
App.fetchStreamerList = withErrorBoundary(App.fetchStreamerList, 'fetchStreamerList');
App.performSlowPoll = withErrorBoundary(App.performSlowPoll, 'SlowPoll');
App.performFastPoll = withErrorBoundary(App.performFastPoll, 'FastPoll');

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
    try { App.init(); } 
    catch (error) {
        console.error('Failed to initialize app:', error);
        document.body.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444;"><h1>Failed to load Kick Monitor Ultra</h1><p>An unexpected error occurred: ${error.message}</p><button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">Refresh Page</button></div>`;
    }
});
</script>

</body>
</html>
