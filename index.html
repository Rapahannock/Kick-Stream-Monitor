<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kick Streamers Monitor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: #eee;
      padding: 20px;
    }
    #streamers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }
    .streamer {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 6px;
      background-color: #1a1a1a;
      font-size: 14px;
    }
    .offline {
      opacity: 0.5;
    }
    a {
      color: #4af;
      text-decoration: none;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .info {
      margin-bottom: 8px;
    }
    .thumbnail-preview {
      width: 100%;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      border: 2px solid #888;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    #last-updated {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 10px;
    }
    #controls {
      margin-top: 20px;
    }
    #controls input {
      padding: 5px;
      font-size: 14px;
      width: 200px;
    }
    #controls button {
      padding: 5px 10px;
      margin-left: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .remove-btn {
      margin-top: 10px;
      color: #f55;
      cursor: pointer;
      font-weight: bold;
      text-align: right;
    }
    #qr {
      margin-top: 30px;
      text-align: center;
    }
    #qr img {
      border: 1px solid #333;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Kick Streamers Live Monitor</h1>
  <div id="last-updated"></div>
  <div id="streamers"></div>
  <div id="controls">
    <input type="text" id="newStreamer" placeholder="Add new streamer...">
    <button onclick="addStreamer()">Add</button>
  </div>
  <div id="qr">
    <p>ðŸ“± Scan this QR code to open this page on your phone:</p>
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=https%3A%2F%2Frapahannock.github.io%2FKick-Stream-Monitor%2F" alt="QR Code to Kick Stream Monitor">
  </div>

  <script>
    let streamers = [];

    async function loadStreamers() {
      try {
        const res = await fetch('streamers.json');
        streamers = await res.json();
        updateStreamers();
      } catch (err) {
        console.error("Failed to load streamers.json", err);
      }
    }

    function saveStreamers() {
      localStorage.setItem("kick_streamers", JSON.stringify(streamers));
    }

    function addStreamer() {
      const input = document.getElementById("newStreamer");
      const name = input.value.trim().toLowerCase();
      if (name && !streamers.includes(name)) {
        streamers.push(name);
        saveStreamers();
        updateStreamers();
      }
      input.value = "";
    }

    function removeStreamer(name) {
      streamers = streamers.filter(n => n !== name);
      saveStreamers();
      updateStreamers();
    }

    async function fetchStreamerInfo(username) {
      const res = await fetch(`https://kick.com/api/v1/channels/${username}`);
      const data = await res.json();
      return {
        name: username,
        live: data.livestream !== null,
        title: data.livestream?.session_title || "Offline",
        viewers: data.livestream?.viewer_count || 0,
        url: `https://kick.com/${username}`,
        thumbnail: data.livestream?.thumbnail?.url || null
      };
    }

    async function updateStreamers() {
      const container = document.getElementById("streamers");
      container.innerHTML = "";

      const streamerData = await Promise.all(streamers.map(fetchStreamerInfo));
      streamerData.sort((a, b) => b.viewers - a.viewers);

      for (const info of streamerData) {
        try {
          const div = document.createElement("div");
          div.className = "streamer" + (info.live ? "" : " offline");

          div.innerHTML = `
            <a href="${info.url}" target="_blank">${info.name}</a>
            <div class="info">
              ${info.live ? `LIVE - ${info.title} (${info.viewers} viewers)` : "Offline"}
            </div>
            ${info.live && info.thumbnail ? `<a href="${info.url}" target="_blank"><img class="thumbnail-preview" src="${info.thumbnail}" alt="Thumbnail"></a>` : ""}
            <div class="remove-btn" onclick="removeStreamer('${info.name}')">&times;</div>
          `;

          container.appendChild(div);
        } catch (err) {
          console.error(`Error displaying ${info.name}:`, err);
        }
      }

      const now = new Date();
      document.getElementById("last-updated").textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }

    loadStreamers();
    setInterval(updateStreamers, 60000); // refresh every minute
  </script>
</body>
</html>
